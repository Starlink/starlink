!
! NDPROGS HELP LIbrary
!
0 NDPROGS

  This help library will provide information on the NDPROGS set of programs
  which perform basic manipulation and display functions on images with
  up to six dimensions.

  The term image as used in this file simply means a regular data array,
  which might be anything from a 1-D spectrum or profile to a 4-D array
  consisting of several long-slit spectra with polarisation vectors.   
  The programs are fully compatible with FIGARO. 
  
  Further documentation may be found in the form of SUN19.
 
1 addnd
   Performs co-adding of images. It uses axis information or
   user specified values to align images on a common set of axes
   and then add them pixel by pixel.
2 FILES
   NAME    FI(LES)
   TYPE    FILE
   OPTIONS INPUT
   PROMPT  "(FIles) Name of image filename list"
   TEXT    ---------------------------------------------------------------
           This is the filename of an ASCII file that contains all the 
           names of the images you wish to process.
           ---------------------------------------------------------------
2 IMAGE
   NAME    IM(AGE)
   TYPE    FILE
   OPTIONS INPUT
   PROMPT  "(IMage) Name of input image"
   TEXT    ---------------------------------------------------------------
           This parameter is not used interactively and should not be set.
           ---------------------------------------------------------------
2 OUTPUT
   NAME    OUT(PUT)
   TYPE    FILE
   OPTIONS OUTPUT
   PROMPT  "(OUTput) Name of output image"
   TEXT    ---------------------------------------------------------------
           OUTPUT is the name of the structure which will contain the
           output image. It will have the same dimensions as the largest
           of the input images along each axis. If OUTPUT already exists, 
           it should NOT be one of the input images  
           ---------------------------------------------------------------
2 SHIFTS
   NAME    SH(IFTS)
   TYPE    FILE
   PROMPT  "(SHifts) File of pixel offsets for images"
   TEXT    ---------------------------------------------------------------
           Before co-adding, each image may be shifted relative to the
           output file by specifying a pixel displacement along each 
           dimension. This parameter is a filename containing shifts
           for each of the input files in respective order.
           ---------------------------------------------------------------
2 VERBOSE
   NAME    VERB(OSE)
   TYPE    KEY
   OPTIONS NOPROMPT
   TEXT    ---------------------------------------------------------------
           Specifying this keyword on the command line results in progress
           messages being written to the terminal.
           ---------------------------------------------------------------
2 AVERAGE
   NAME    AV(ERAGE)
   TYPE    KEY
   PROMPT  "(AVerage) Are the images to be averaged?"
   TEXT    ---------------------------------------------------------------
           Specifying this keyword causes the program to compute the 
           average of the data in the images rather than the sum.
           ---------------------------------------------------------------
2 USEAXES
   NAME    USEAX(ES)
   TYPE    KEY
   PROMPT  "(USEAXes) Use axis information to compute shifts?"
   TEXT    ---------------------------------------------------------------
           If true, this keyword instructs ADDND to compute the shifts
           using the axes of the input images so that all the images
           are aligned to the same origin.
           --------------------------------------------------------------- 
2 SMALL
   NAME    SMALL
   TYPE    FLOAT
   OPTIONS NOPROMPT
   TEXT    ---------------------------------------------------------------
           This parameter sets the effective floating-point zero, that is
           a value for which two real numbers will be considered the same
           if their difference is less than it. Defaults to 1.0E-07.
           ---------------------------------------------------------------
2 SOURCE_COMMENTS
C+
c
c   ---------
c   A D D N D
c   ---------
c
c   Description
c   -----------
c   Takes several  images and adds them together, shifting each of the images
c   by a prescribed amount along each dimension.
c
c   Program Scope
c   -------------
c   - FLOAT or REAL data handled explicitly, all others mapped to FLOAT
c   - Images of up to six dimensions handled.
c   - Subsetting not appropriate.
c   - Magic values, quality and error arrays supported.
c   - Batch execution supported.
c   - Linearly scaled axis arrays only allowed if USEAXES is .TRUE.
c
c   Environment
c   -----------
c   Figaro
c
c   Parameters
c   ----------
c   FILES	Name of a .DAT file containg input file names. (file)
c   OUTPUT	Name of the structure containing the resulting cube. (file)
c   SHIFTS      Name of a .DAT file containing the pixel shifts.
c   SMALL       Value of effective floating-point 0. (real, hidden)
c
c   Keywords
c   --------
c   VERBOSE  	Signals whether messages are terse (false) or long (hidden).
c   AVERAGE     If true, cubes are averaged rather than added.
c   USEAXES     If true, use cube axes to determine the shifts.
c
c   Propagation of Data Structure
c   -----------------------------
c   See method.
c
c   Method
c   ------
c   
c   - The program obtains USEAXES to determine whether shift values are to
c     be computed or read from a file.
c   - The parameter FILES is obtained. This is an ASCII file containing the
c     names of the images to be co-added. 
c   - The parameter SHIFTS is obtained if USEAXES is FALSE. This is an ASCII
c     file containing the relative pixel shifts of each of the images in the
c     input file.
c   - Each image is read in in turn, and the output file's properties are
c     determined from the information gathered in this first pass. The rules
c     are as follows:
c     
c     o The output file size is the maximum in each dimension of the input
c       images.
c     o The output file type is determined by the type of the first file
c       in the input list (hereafter called the BASE file).
c     o If shifts are to be read from a file rather than computed, it is up
c       to the user to ensure that they do not exceed the output array
c       boundaries. (Although checking could be added, it would significantly
c       reduce performance.) All arrays are therefore treated as "elastic"
c       and will expand to whatever size is necessary.
c     o Each input file MUST have the same dimensionality as the base file.
c     o If USEAXES is true, ALL axes must be present in ALL the images.
c       Further, logarithmic axes are disallowed and axes with units other
c       than that of the base file also cause program abortion. 
c     o All axis data must increase monotonically with index (if it doesn't, 
c       use AXFLIP or SETAXES to make it so).
c     o All axis data must be on the same scale as the base file (ie the ratio
c
c                        (end - start + 1) / no.of pixels
c                              
c       must be the same for each respective axis.)
c     o Quality or error arrays will appear in the output iff each input
c       file contains them, otherwise they will be ignored. Similarly
c       the bad pixel flag will only be set in the output structure iff
c       all the input files have it set. This avoids conflicts with magic
c       values and quality arrays.
c
c   - Each file is then opened, and the appropriate arrays mapped. Errors
c     are mapped as variances to simplify the arithmetic. The arrays are then
c     co-added by treating all arrays as 6D (using dimension of 1 for each
c     unused dimension). If AVERAGE is true, a count is maintained for each
c     pixel in the image. The file is closed after use, freeing up the slot
c     for the next file.
c
c   - If AVERAGE is true, the mean pixel values are computed in the final 
c     image.
c
c   - If USEAXES is true, the output axes are scaled accordingly.
c
c   External Functions & Subroutines
c   --------------------------------
c   DSA Library:
c     DSA_CLOSE
c     DSA_CLOSE_STRUCTURE
c     DSA_DATA_SIZE
c     DSA_DATA_TYPE
c     DSA_GET_AXIS_INFO
c     DSA_GET_LU
c     DSA_GET_WORKSPACE
c     DSA_INPUT
c     DSA_MAP_AXIS_DATA
c     DSA_MAP_DATA
c     DSA_MAP_QUALITY
c     DSA_MAP_VARIANCE
c     DSA_NAMED_INPUT
c     DSA_OPEN
c     DSA_OUTPUT
c     DSA_SEEK_AXIS
c     DSA_SEEK_ERRORS
c     DSA_SEEK_FLAGGED_VALUES
c     DSA_SEEK_QUALITY
c     DSA_SIMPLE_OUTPUT
c     DSA_TYPESIZE
c     DSA_UNMAP
c     DSA_WRUSER
c
c   GEN Library:
c     GEN_FILL  
c   
c   ICH Library:
c     ICH_CI
c     ICH_FOLD

c   NDP Library:
c     NDP_GET_IMAGE_INFO
c     NDP_PAR_RDARY
c
c   PAR Library:
c     PAR_CNPAR
c     PAR_GIVEN
c     PAR_RDCHAR
c     PAR_RDVAL
c
c   Internal Subroutines
c   --------------------
c
c     ADDND_ADD_W
c     ADDND_ADD_R
c     ADDND_GET_AXIS_INFO
c     ADDND_INFO
c     ADDND_SETAXES
c
c   INCLUDE's
c   ---------
c   INCLUDE 'DYN_SOURCE:DYNAMIC_MEMORY.INC'
c   INCLUDE 'NDP_SOURCE:NDP_MAGIC_VALUES.INC'
c   INCLUDE 'NDP_SOURCE:NDP_NUMERIC_RANGES.INC'
c   INCLUDE 'NDP_SOURCE:NDP_QUALITY_MASK.INC'
c
c   Fortran 77 Extensions
c   ---------------------
c   END DO / IMPLICIT NONE / INCLUDE / Names > 6 characters / DO WHILE
c
c   Author
c   ------
c   Julian Gold		RGO	(CAVAD::GOLDJIL or goldjil@uk.ac.cam.ast-star)
c
c   History
c   -------
c
c   14-MAY-1992		- Original program.
c   26-NOV-1992         - Unix version
c   06-OCT-1994         - Removed lots of unused variables. (GJP)
c
1 arith1
  Arithmetic combination of an image or image subset with a
  scalar value.
2 IMAGE
   NAME    IM(AGE)
   TYPE    FILE
   OPTIONS INPUT
   PROMPT  "(IMage) Name of input image"
   TEXT    ----------------------------------------------------------------
           IMAGE is the name of the structure containing the image to be 
           arithmetically combined with a scalar. The image may have from
           one to six dimensions.
           ----------------------------------------------------------------
2 WHOLE
   NAME    WH(OLE)
   TYPE    KEY                                               
   PROMPT  "(WHole) Process the whole image?"
   TEXT    ----------------------------------------------------------------
           If WHOLE is specified, the entire area of the image will be 
           processed. Otherwise, a subset of the image may be selected.
           ----------------------------------------------------------------
2 START
   NAME    ST(ART)
   TYPE    FLOAT[6]
   PROMPT  "(STart) Start coordinates of subset."
   TEXT    ----------------------------------------------------------------
           START is an array containing the start coordinate of the subset
           to be processed in each dimension of the image. The first array
           element is the start coordinate in the first dimension of the 
           current sort order (usually X). Each coordinate must be given 
           in axis units if the relevant axis is calibrated, or in pixels 
           if it is not calibrated or the axis structure is not present.  
           ----------------------------------------------------------------
2 END
   NAME    EN(D)
   TYPE    FLOAT[6]
   PROMPT  "(ENd) End coordinates of subset."
   TEXT    ----------------------------------------------------------------
           END is an array containing the end coordinate of the subset
           to be processed in each dimension of the image. The first array
           element is the end coordinate in the first dimension of the 
           current sort order (usually X). Each coordinate must be given 
           in axis units if the relevant axis is calibrated, or in pixels 
           if it is not calibrated or the axis structure is not present.  
           ----------------------------------------------------------------
2 OPER
   NAME    OP(ER)
   TYPE    CHAR
   PROMPT  "(OPer) +, -, *, /, **"
   TEXT    ----------------------------------------------------------------
           Arithmetic operations:
           +   add scalar to pixel
           -   subtract scalar from pixel
           *   multiply pixel by scalar
           /   divide pixel by scalar
           **  raise pixel to the power of the scalar
           ----------------------------------------------------------------
2 VALUE
   NAME    VAL(UE)
   TYPE    FLOAT
   PROMPT  "(VALue) Scalar or power value"
   TEXT    ----------------------------------------------------------------
           Every pixel of the image will be combined with this value.
           ----------------------------------------------------------------
2 OUTPUT
   NAME    OUT(PUT)
   TYPE    FILE
   OPTIONS OUTPUT
   PROMPT  "(OUTput) Name of output image"
   TEXT    ----------------------------------------------------------------
           OUTPUT is the name of the structure which will contain the
           output image. If OUTPUT already exists, a new version will be 
           created. If OUTPUT is the same as IMAGE, a new version of IMAGE
           will be created.
           ----------------------------------------------------------------
2 ERR_ACT
   NAME    ERR_ACT
   TYPE    CHAR
   PROMPT  "(ERR_ACT) (R)eplace void values or (L)eave"
   TEXT    ---------------------------------------------------------------
           When an operation inserts a new value for a pixel in the image,
           the error associated with that pixel is then undefined (void).
           Responding R will replace void  values with a constant of your
           choice. L or any other character will leave the error array 
           unchanged.
           ---------------------------------------------------------------
2 ERR_VAL
   NAME    ERR_VAL
   TYPE    FLOAT
   PROMPT  "(ERR_VAL) Value to replace void errors with"
   TEXT    ---------------------------------------------------------------
           When an operation inserts a new value for a pixel in the image,
           the error associated with that pixel is then undefined (void).
           Enter the value you wish to replace void errors with.
           ---------------------------------------------------------------
2 SOURCE_COMMENTS
C+
C
C   ---------
C   C O M B 1
C   ---------
C
C   Description
C   -----------
C   This routine services the following commands:
C
C     ARITH1 - Arithmetic operations between an image and a scalar. The 
C              operations supported are: +, -, *, /, **.
C
C     LOGIC1 - Bitwise logical operations between an image and a scalar. The
C              operations supported are: AND, OR, XOR, NAND, NOR, NXOR.
C
C     MASK1  - Masking operations between an image and a scalar. The 
C              operations supported are: MAX, MIN, replace where IMAGE is 
C              non-magic (or good quality), replace where IMAGE is magic
C              (or bad quality).
C
C
C   Scope of program
C   ----------------
C   - Images of up to six dimensions accepted.
C   - Data array types SHORT and FLOAT supported; others converted to FLOAT.
C     (bitwise logical operations accept SHORT array type only).
C   - Subsetting supported.
C   - Magic values supported.
C   - Quality and error arrays supported.
C   - Batch execution supported.
C
C
C   Environment
C   -----------
C   FIGARO
C
C                                               
C   Parameters (read or written)
C   ----------------------------
C   IMAGE    Name of the structure containing the input image. (character)
C            (prompted for).
C
C   START    Coordinate in each dimension of IMAGE at which the operation is
C            to start. (real, array)(prompted for).
C
C   END      Coordinate in each dimension of IMAGE at which the operation is
C            to end. (real, array)(prompted for).
C
C   OPER     Operation to be performed. (character)(prompted for).
C
C   VALUE    Scalar to be combined with IMAGE. (real)(prompted for).
C
C   OUTPUT   Name of the structure containing the output image. May be the 
C            same as IMAGE. (character)(prompted for).     
C
C   ERR_ACT  Action to be taken with a void error array (character,prompted)
C
C   ERR_VAL  Value to replace void errors with (real, prompted)
C
C
C   Keywords
C   --------
C   WHOLE    Instructs the program to operate on the whole image. Otherwise,
C            a subset of the image may be selected.
C
C
C   Propagation of data structure
C   -----------------------------
C   - Principal structure is IMAGE.
C   - All standard objects are copied from IMAGE.
C   - Data array is modified.
C
C
C   Method
C   ------
C   - The IMAGE structure is tested for the bad data flag. If it is found 
C     and non-zero, magic values are assumed to be present and are left in
C     the data.
C   - The structure IMAGE is copied to OUTPUT.
C   - A subroutine appropriate to the required operation, the data type,
C     and the presence or absence of magic values is called to operate on
C     the OUTPUT data array.
C
C   Note
C   ----
C
C     Lines commented with 'C*' indicate the current non-compatibility
C     of quality arrays and magic values, and have been included for
C     forward compatibilty.
C
C   External functions & subroutines called
C   ---------------------------------------
C   Library DSA:
C      DSA_CLOSE
C      DSA_DATA_SIZE
C      DSA_INPUT
C      DSA_MAP_DATA
C      DSA_MAP_ERRORS
C      DSA_MAP_QUALITY
C      DSA_OPEN          
C      DSA_OUTPUT
C      DSA_USE_FLAGGED_VALUES
C      DSA_WRUSER
C
C   Library DYN:
C      DYN_ELEMENT
C
C   Library ICH:
C      ICH_FOLD
C      ICH_LEN
C
C   Library NDP:
C      NDP_AXIS_RANGE
C      NDP_GET_IMAGE_INFO
C      NDP_SET_BAD_PIXEL
C
C   Library PAR:
C      PAR_COMMAND
C      PAR_RDCHAR
C      PAR_RDVAL
C
C
C   Internal subroutines called
C   ---------------------------
C   COMB1_AC_W
C   COMB1_AC_WQ
C   COMB1_AC_R
C   COMB1_AC_RQ
C   COMB1_B_W
C   COMB1_B_WQ
C   REPLACE_ERRORS_R
C   REPLACE_ERRORS_W
C      
C
C   INCLUDE statements
C   ------------------
C   INCLUDE 'DYN_SOURCE:DYNAMIC_MEMORY.INC'
C   INCLUDE 'NDP_SOURCE:NDP_MAGIC_VALUES.INC'
C   INCLUDE 'NDP_SOURCE:NDP_NUMERIC_RANGES.INC'
C   INCLUDE 'NDP_SOURCE:NDP_QUALITY_MASK.INC'
C   INCLUDE 'DCV_FUN'
C
C
C   Extensions to FORTRAN 77
C   ------------------------
C   END DO / IMPLICIT NONE / INCLUDE / Names > 6 characters
C
C
C   Possible future upgrades
C   ------------------------
C   - Allow a fractional offset between images before combination, with 
C     linear interpolation of pixel values.
C
C
C   Author/s
C   --------
C   Nick Fuller  RGO  (RGVAD::NMJF or NMJF@UK.AC.RGO.STAR)
C   Chris Benn  RGO  (RGVAD::CRB or CRB@UK.AC.RGO.STAR)
C   Julian Gold RGO (CAVAD::GOLDJIL or GOLDJIL@UK.AC.CAM.AST-STAR)
C
C
C   History
C   -------
C   01-FEB-1989  - Original program
C   12-JLY-1991  - Quality and error arrays implemented, with new options:
C                  REP1 replace data when quality is good
C                  REP4 replace data when quality is bad
C                  (only applicable when quality arrays exist). (GOLDJIL)
C   20-AUG-1991  - Why oh why did the author compare COMMAND with 'ACOMB1'
C                  etc when the command names are 'LOGIC1' etc ? Fixed now.
C                  Sigh...
C
C   30-NOV-1992  - Unix version. Changed REP1 to REPG, REP4 to REPB which
C                  are a tad less cryptic. (GOLDJIL)
C   06-OCT-1994  - Removed a Trojan Horse message. Also ensured that an
C                  infinite loop does not occur when an improper operation is
C                  requested. Removed unused variables. (GJP)
C   13-OCT-1994  - Modified code to avoid an eternal loop
C                  when attempting to divide by zero in ARITH1. (GJP)
C
C
1 arith2
  Arithmetic combination of two images or image subsets.
2 IMAGE
   NAME    IM(AGE)
   TYPE    FILE
   OPTIONS INPUT
   PROMPT  "(IMage) Name of first input image"
   TEXT    ----------------------------------------------------------------
           IMAGE is the name of the structure containing the image to be 
           arithmetically combined with a second image. The image may have
           from one to six dimensions. The dimensions of the output image
           will be the same as those of the first input image.
           ----------------------------------------------------------------
2 IMAGE1
   NAME    IMAGE1
   TYPE    FILE
   OPTIONS INPUT
   PROMPT  "(IMAGE1) Name of second input image"
   TEXT    ----------------------------------------------------------------
           IMAGE1 is the name of the structure containing the second image.
           The image may have from one to six dimensions.
           ----------------------------------------------------------------
2 WHOLE
   NAME    WH(OLE)
   TYPE    KEY                                               
   PROMPT  "(WHole) Process the whole of the first image?"
   TEXT    ----------------------------------------------------------------
           If WHOLE is specified, the entire area of IMAGE will be 
           processed. Otherwise, a subset of the image may be selected.
           ----------------------------------------------------------------
2 START
   NAME    ST(ART)
   TYPE    FLOAT[6]
   PROMPT  "(STart) Start coordinates of subset."
   TEXT    ----------------------------------------------------------------
           START is an array containing the start coordinate of the subset
           to be processed in each dimension of IMAGE. The first array
           element is the start coordinate in the first dimension of the 
           current sort order (usually X). Each coordinate must be given 
           in axis units if the relevant axis is calibrated, or in pixels 
           if it is not calibrated or the axis structure is not present.  
           ----------------------------------------------------------------
2 END
   NAME    EN(D)
   TYPE    FLOAT[6]
   PROMPT  "(ENd) End coordinates of subset."
   TEXT    ----------------------------------------------------------------
           END is an array containing the end coordinate of the subset
           to be processed in each dimension of IMAGE. The first array
           element is the end coordinate in the first dimension of the 
           current sort order (usually X). Each coordinate must be given 
           in axis units if the relevant axis is calibrated, or in pixels 
           if it is not calibrated or the axis structure is not present.  
           ----------------------------------------------------------------
2 OPER
   NAME    OP(ER)
   TYPE    CHAR
   PROMPT  "(OPer) +, -, *, /, **"
   TEXT    ----------------------------------------------------------------
           Arithmetic operations:
           +   add IMAGE1 to IMAGE
           -   subtract IMAGE1 from IMAGE
           *   multiply IMAGE by IMAGE1
           /   divide IMAGE by IMAGE1
           **  raise IMAGE to the power of IMAGE1
           ----------------------------------------------------------------
2 OUTPUT
   NAME    OUT(PUT)
   TYPE    FILE
   OPTIONS OUTPUT
   PROMPT  "(OUTput) Name of output image"
   TEXT    ----------------------------------------------------------------
           OUTPUT is the name of the structure which will contain the
           output image. It will have the same dimensions as IMAGE. If 
           OUTPUT already exists, a new version will be created. If OUTPUT
           is the same as IMAGE or IMAGE1, a new version of IMAGE or 
           IMAGE1 will be created.
           ----------------------------------------------------------------
2 ERR_ACT
   NAME    ERR_ACT
   TYPE    CHAR
   PROMPT  "(ERR_ACT) (R)eplace void values or (L)eave"
   TEXT    ---------------------------------------------------------------
           When an operation inserts a new value for a pixel in the image,
           the error associated with that pixel is then undefined (void).
           Responding R will replace void values with a constant of your 
           choice. L or any other character will leave the error array 
           unchanged.
           ---------------------------------------------------------------
2 ERR_VAL
   NAME    ERR_VAL
   TYPE    FLOAT
   PROMPT  "(ERR_VAL) Value to replace void errors with"
   TEXT    ---------------------------------------------------------------
           When an operation inserts a new value for a pixel in the image,
           the error associated with that pixel is then undefined (void).
           Enter the value you wish to replace void errors with.
           ---------------------------------------------------------------
2 SOURCE_COMMENTS
C+
C
C   ---------
C   C O M B 2
C   ---------
C
C   Description
C   -----------
C   This routine services the following commands:
C
C     ARITH2 - Arithmetic operations between two images. The operations 
C              supported are: +, -, *, /, **.
C
C     LOGIC2 - Bitwise logical operations between two images. The operations
C              supported are: AND, OR, XOR, NAND, NOR, NXOR.
C
C     MASK2  - Masking operations between two images. The operations 
C              supported are: MAX, MIN, replace where IMAGE is non-magic, 
C              replace where IMAGE1 is non-magic, replace where IMAGE and 
C              IMAGE1 are both non-magic, replace where IMAGE is magic.
C              (Read bad quality for magic if quality data is present)
C
C   If the input images have different dimensionalities, the one with the 
C   larger number of dimensions must be given first, as IMAGE. In such a
C   case the combination may be performed repeatedly, starting and ending at
C   given coordinates in the higher dimensions of IMAGE. For example a 2-D
C   IMAGE1 may be combined with several consecutive planes of a 3-D IMAGE.
C
C   The axes of IMAGE1 are aligned with the corresponding axes of IMAGE,
C   i.e. a 1-D IMAGE1 is always combined with the X rows of IMAGE. This is
C   the most efficient way to operate on arrays, producing the lowest number
C   of page faults. If it is required to combine a 1-D IMAGE1 with the Z 
C   rows of a 3-D IMAGE, the XYZ to ZXY transposition of IMAGE may be 
C   achieved by prior use of TRANSPOSE. 
C
C   The output structure will be a copy of the FIRST input structure.
C
C
C   Scope of program
C   ----------------
C   - Images of up to six dimensions accepted.
C   - Data array types SHORT and FLOAT supported; others converted to FLOAT.
C     (bitwise logical operations accept SHORT array type only).
C   - Subsetting supported.
C   - Magic values supported.
C   - Quality and error arrays supported.
C   - Batch execution supported.
C
C
C   Environment
C   -----------
C   FIGARO
C
C                                               
C   Parameters (read or written)
C   ----------------------------
C   IMAGE    Name of the structure containing the first image. (character)
C            (prompted for).
C
C   IMAGE1   Name of the structure containing the second image. (character)
C            (prompted for).  
C
C   START    Coordinate in each dimension of IMAGE at which the operation is
C            to start. (real, array)(prompted for).
C
C   END      Coordinate in each dimension of IMAGE at which the operation is
C            to end. (real, array)(prompted for).
C
C   OPER     Operation to be performed. (character)(prompted for).
C
C   OUTPUT   Name of the structure containing the output image. May be the 
C            same as IMAGE. (character)(prompted for).     
C
C
C   Keywords
C   --------
C   WHOLE    Instructs the program to operate on the whole image. Otherwise,
C            a subset of the image may be selected.
C
C
C   Propagation of data structure
C   -----------------------------
C   - Principal structure is IMAGE.
C   - All standard objects are copied from IMAGE.
C   - Data array is modified.
C
C
C   Method
C   ------
C   - The IMAGE and IMAGE1 structures are tested for the bad data flag. If 
C     either is found and non-zero, magic values are assumed to be present
C     and are left in the data.
C   - A subset of IMAGE is optionally selected by specifying the start and 
C     end coordinates in each dimension. If IMAGE has more dimensions than 
C     IMAGE1, the required start and end coordinates in each of the higher 
C     dimensions are also prompted for. For example, if it is required to 
C     combine a 2-D IMAGE1 with a 3-D IMAGE, the start and end pixels in the
C     third dimension of IMAGE control which XY planes of IMAGE are combined
C     with IMAGE1.         
C   - The structure IMAGE is copied to OUTPUT. If the data array of either 
C     IMAGE or IMAGE1 is of type FLOAT, then both IMAGE and IMAGE1 are 
C     mapped as FLOAT.
C   - Error and quality arrays are mapped as appropriate.
C   - A subroutine appropriate to the required operation, the data type, and
C     the presence or absence of magic values is called to operate on the
C     IMAGE1 and OUTPUT data arrays.
C
C
C   External functions & subroutines called
C   ---------------------------------------
C   Library DSA:
C      DSA_AXIS_RANGE
C      DSA_CLOSE
C      DSA_DATA_SIZE
C      DSA_INPUT
C      DSA_MAP_DATA
C      DSA_MAP_ERRORS
C      DSA_MAP_QUALITY
C      DSA_OPEN          
C      DSA_OUTPUT
C      DSA_USE_FLAGGED_VALUES
C      DSA_WRUSER
C
C   Library DYN:
C      DYN_ELEMENT
C
C   Library ICH:
C      ICH_ENCODE
C      ICH_FOLD
C      ICH_LEN
C
C   Library NDP:
C      NDP_ERROR_ARITH_R
C      NDP_ERROR_ARITH_W
C      NDP_GET_IMAGE_INFO
C      NDP_PAR_RDARY
C      NDP_SET_BAD_PIXEL
C
C   Library PAR:
C      PAR_COMMAND
C      PAR_RDCHAR
C      PAR_RDVAL
C
C
C   Internal subroutines called
C   ---------------------------
C   COMB2_AC_W
C   COMB2_AC_WQ
C   COMB2_AC_R
C   COMB2_AC_RQ
C   COMB2_B_W
C   COMB2_B_WQ
C   REPLACE_ERRORS_R
C   REPLACE_ERRORS_W
C      
C
C   INCLUDE statements
C   ------------------
C   INCLUDE 'DYN_SOURCE:DYNAMIC_MEMORY.INC'
C   INCLUDE 'NDP_SOURCE:NDP_MAGIC_VALUES.INC'
C   INCLUDE 'NDP_SOURCE:NDP_NUMERIC_RANGES.INC'
C   INCLUDE 'DCV_FUN'
C
C
C   Extensions to FORTRAN 77
C   ------------------------
C   END DO / IMPLICIT NONE / INCLUDE / Names > 6 characters
C
C
C   Possible future upgrades
C   ------------------------
C   - Allow a fractional offset between images before combination, with 
C     linear interpolation of pixel values.
C   - Purging of the error array when void values are present. At present,
C     this would require use of DSA common block data and routines in the
C     NON-shareable DSA library. Hint, hint, Keith?
C
C   Author/s
C   --------
C   Nick Fuller  RGO  (RGVAD::NMJF or NMJF@UK.AC.RGO.STAR)
C   Julian Gold  RGO  (CAVAD::GOLDJIL or GOLDJIL@UK.AC.CAM.AST-STAR)
C
C
C   History
C   -------
C   01-FEB-1989   - Original program
C   29-AUG-1990   - Bug which sometimes caused the output file to be mapped 
C                   as the wrong type was fixed.  A few typos were also
C                   corrected.  (JRL)
C   10-AUG-1991   - Quality and error handling implemented (GOLDJIL)
C   16-SEP-1991   - Bug which led to erroneous output if IMAGE 
C                   contained SHORT data and IMAGE1 FLOAT data fixed.
C                   (GOLDJIL)
C   06-OCT-1994   - Removed a Trojan Horse message. Also ensured that an
C                   infinite loop does not occur when an improper operation is
C                   requested. Removed unused variables. (GJP) 
C
1 axflip
  Reverses an image in one direction and reverses the relevant axis
  array. Currently handles 3-D images only. FIGARO programs IREVX and IREVY
  may be used on 1 or 2-D images.
2 IMAGE
   NAME    IM(AGE)
   TYPE    FILE
   OPTIONS INPUT
   PROMPT  "(IMage) Name of input image"
   TEXT    ----------------------------------------------------------------
           IMAGE is the name of the structure containing the image to be
           reversed along a specified axis. The image may have from one 
           to six dimensions.
           ----------------------------------------------------------------
2 AXIS
   NAME    AXIS
   TYPE    INT
   PROMPT  "(AXIS) Axis to be reversed"
   TEXT    ----------------------------------------------------------------
           AXIS is the number of the dimension along which the data array 
           and the relevant axis will be reversed. For example, if an
           XYZ-sorted image is to be reversed in Z, AXIS=3.
           ----------------------------------------------------------------
2 OUTPUT
   NAME    OUT(PUT)
   TYPE    FILE
   OPTIONS OUTPUT
   PROMPT  "(OUTput) Name of output image"
   TEXT    ----------------------------------------------------------------
           OUTPUT is the name of the structure which will contain the
           output image. If OUTPUT already exists, a new version will be
           created. If OUTPUT is the same as IMAGE, a new version of IMAGE
           will be created. 
           ----------------------------------------------------------------
2 TUNE
   NAME    TUNE
   TYPE    FLOAT
   OPTIONS NOPROMPT
   PROMPT  "(TUNE) Tuning factor"
   TEXT    ----------------------------------------------------------------
           TUNE adjusts the number of image planes which are read as a 
           group and tranposed together. It has a small effect on the
           performance of the program.
           ----------------------------------------------------------------
2 SOURCE_COMMENTS
C+
C
C   -----------
C   A X F L I P
C   -----------
C
C   Description
C   -----------
C   Reverses an image along a specified axis.
C
C
C   Scope of program
C   ----------------
C   - Currently handles 3-D images only.
C   - Data array types SHORT and FLOAT supported; others converted to FLOAT.
C   - Subsetting not supported.
C   - Magic values not supported since not relevant.
C   - Quality and error arrays supported.
C   - Batch execution supported.
C
C
C   Environment
C   -----------
C   FIGARO
C
C
C   Parameters (read or written)
C   ----------------------------
C   IMAGE   Name of the structure containing the input image. (character)
C           (prompted for).
C
C   AXIS    Number of the axis along which the image is to be reversed.
C           (integer)(prompted for).
C
C   OUTPUT  Name of the structure containing the output image. May be the 
C           same as IMAGE. (character)(prompted for).
C
C   TUNE    Tuning factor which adjusts the number of image planes read into
C           the work array at one time. Has a small effect on performance. 
C           (real)(hidden parameter).
C
C
C   Keywords
C   --------
C   None.
C
C
C   Propagation of data structure
C   -----------------------------
C   - All standard objects are copied from IMAGE.
C   - Data array and one axis are modified.
C
C
C   Method
C   ------
C   - The structure IMAGE is copied to OUTPUT.
C   - The required axis array is reversed in OUTPUT.
C   - A subroutine appropriate to the data type is called to reverse the 
C     OUTPUT data array.
C   - The program checks the process page count so that it can deal with the
C     input data array in pieces which fit into the working set. This 
C     minimizes page faulting and improves efficiency.
C
C
C   External functions & subroutines called
C   ---------------------------------------
C   Library DSA:
C     DSA_CLOSE
C     DSA_DATA_SIZE
C     DSA_FREE_WORKSPACE
C     DSA_GET_WORKSPACE
C     DSA_GET_WORK_ARRAY
C     DSA_INPUT
C     DSA_MAP_AXIS_DATA
C     DSA_MAP_DATA
C     DSA_MAP_ERRORS
C     DSA_MAP_QUALITY
C     DSA_OPEN
C     DSA_OUTPUT
C     DSA_SEEK_ERRORS
C     DSA_SEEK_QUALITY
C     DSA_TYPESIZE
C     DSA_USE_FLAGGED_VALUES
C     DSA_WRUSER
C
C   Library DYN:
C     DYN_ELEMENT
C
C   Library ICH:
C     ICH_ENCODE
C     ICH_LEN
C
C   Library NDP:
C     NDP_DISPLAY_PROGRESS
C     NDP_GETJPI_PPGCNT
C     NDP_GETJPI_WSEXTENT
C     NDP_GET_IMAGE_INFO
C
C   Library PAR:
C     PAR_RDVAL
C     
C
C   Internal subroutines called
C   ---------------------------
C   AXFLIP_NEWAXIS
C   AXFLIP_3D_W
C   AXFLIP_3D_R
C   AXFLIP_3D_B
C
C   INCLUDE statements
C   ------------------
C   INCLUDE 'DYN_SOURCE:DYNAMIC_MEMORY.INC'
C   INCLUDE 'NDP_SOURCE:NDP_MAGIC_VALUES.INC'
C   INCLUDE 'NDP_SOURCE:NDP_NUMERIC_RANGES.INC'
C                                                
C
C   Extensions to FORTRAN77
C   -----------------------
C   DO WHILE / END DO / IMPLICIT NONE / INCLUDE / Names > 6 characters
C
C
C   Possible future upgrades
C   ------------------------
C   - Only 3-D images are handled at present. Subroutines to be written:
C       AXFLIP_2D_<T>
C       AXFLIP_4D_<T>
C       AXFLIP_5D_<T>
C       AXFLIP_6D_<T>
C                                
C
C   Author/s
C   --------
C   Nick Fuller  RGO  (RGVAD::NMJF or NMJF@UK.AC.RGO.STAR)
C   Jim Lewis    RGO  (CAVAD::JRL or JRL@UK.AC.CAM.AST-STAR)
C   Julian Gold  RGO  (CAVAD::GOLDJIL or GOLDJIL@UK.AC.CAM.AST-STAR)
C
C   History
C   -------
C   01-FEB-1989   - Original program
C   03-AUG-1990   - Fixed so that adjustable array sizes are not passed
C                   as elements of another array.  This practice has been
C                   banned by the v5.2 compiler.  Fixed bug where workspace
C                   had not been allocated before the call to AXFLIP_NEWAXIS.
C                   Also fixed a few loose ends in the prolog.  (JRL)
C   16-OCT-1991   - Quality and error arrays implemented. GENERIC subroutines
C                   written. (GOLDJIL)
C   27-NOV-1992   - Unix version (GOLDJIL)
C   06-OCT-1994   - Removed lots of unused variables. (GJP)
C
C
1 collapse
  Collapses an n-D image or image subset in one or more dimensions to
  create an (n-c)-D image, where c is the number of collapsed dimensions.
2 IMAGE
   NAME    IM(AGE)
   TYPE    FILE
   OPTIONS INPUT
   PROMPT  "(IMage) Name of input image"
   TEXT    ----------------------------------------------------------------
           IMAGE is the name of the structure containing the image to be 
           collapsed in one or more dimensions, i.e. summed along one or 
           more axes. The image may have from two to six dimensions. The 
           resulting image must have at least one dimension.
           ----------------------------------------------------------------
2 AXKEY
   NAME    AXKEY
   TYPE    INT[6]
   PROMPT  "(AXKEY) Keys for dimensions to be collapsed."
   TEXT    ----------------------------------------------------------------
           AXKEY is an array containing the instruction to collapse the 
           image in each dimension. 0 = leave alone, 1 = collapse. 
           ----------------------------------------------------------------
2 WHOLE
   NAME    WH(OLE)
   TYPE    KEY                                               
   PROMPT  "(WHole) Process the whole image?"
   TEXT    ----------------------------------------------------------------
           If WHOLE is specified, the entire area of the image will be 
           processed. Otherwise, a subset of the image may be selected.
           ----------------------------------------------------------------
2 START
   NAME    ST(ART)
   TYPE    FLOAT[6]
   PROMPT  "(STart) Start coordinates of subset."
   TEXT    ----------------------------------------------------------------
           START is an array containing the start coordinate of the subset
           to be processed in each dimension of the image. The first array
           element is the start coordinate in the first dimension of the 
           current sort order (usually X). Each coordinate must be given 
           in axis units if the relevant axis is calibrated, or in pixels 
           if it is not calibrated or the axis structure is not present.  
           ----------------------------------------------------------------
2 END
   NAME    EN(D)
   TYPE    FLOAT[6]
   PROMPT  "(ENd) End coordinates of subset."
   TEXT    ----------------------------------------------------------------
           END is an array containing the end coordinate of the subset
           to be processed in each dimension of the image. The first array
           element is the end coordinate in the first dimension of the 
           current sort order (usually X). Each coordinate must be given 
           in axis units if the relevant axis is calibrated, or in pixels 
           if it is not calibrated or the axis structure is not present.  
           ----------------------------------------------------------------
2 FLOAT
   NAME    FL(OAT)
   TYPE    KEY                                               
   PROMPT  "(FLoat) Create an output data array of type FLOAT?"
   TEXT    ----------------------------------------------------------------
           If FLOAT is specified, the output data array will be of type
           FLOAT, i.e. single precision floating point (REAL*4). This
           feature prevents the overflow errors which often occur when 
           SHORT data is summed over a large area.
           ----------------------------------------------------------------
2 OUTPUT
   NAME    OUT(PUT)
   TYPE    FILE
   OPTIONS OUTPUT
   PROMPT  "(OUTput) Name of output image"
   TEXT    ----------------------------------------------------------------
           OUTPUT is the name of the structure which will contain the
           output image. If OUTPUT already exists, a new version will be 
           created. If OUTPUT is the same as IMAGE, a new version of IMAGE
           will be created.
           ----------------------------------------------------------------
2 SOURCE_COMMENTS
C+
C
C   ---------------
C   C O L L A P S E
C   ---------------
C
C   Description
C   -----------
C   Collapses an n-D image in one or more dimensions to form an (n-c)-D 
C   image, where c is the number of collapsed dimensions. The pixel values
C   are summed along the specified axes. If a magic value pixel is found 
C   while summing it is ignored, but the sum is still valid.
C
C
C   Scope of program
C   ----------------
C   - Images of two to six dimensions accepted.
C   - Data array types SHORT and FLOAT supported; others converted to FLOAT.
C   - Subsetting supported.
C   - Magic values supported.
C   - Quality and error arrays supported.
C   - Batch execution supported.
C
C
C   Environment
C   -----------
C   FIGARO
C
C
C   Parameters (read or written)
C   ----------------------------
C   IMAGE  Name of the structure containing the input image. (character)
C          (prompted for).
C
C   AXKEY  Keys for dimensions along which image is to be collapsed.
C          (integer, array)(prompted for).
C
C   START  Coordinate in each dimension of IMAGE at which the summation is
C          to start. (real, array)(prompted for).
C
C   END    Coordinate in each dimension of IMAGE at which the summation is
C          to end. (real, array)(prompted for).
C
C   OUTPUT Name of the structure containing the output image. May be the 
C          same as IMAGE. (character)(prompted for).
C
C
C   Keywords
C   --------
C   WHOLE  Instructs the program to sum along the whole ranges of the 
C          selected axes, using the whole range of all other dimensions.
C          Otherwise, a subset of each dimension may be selected.
C
C   FLOAT  Instructs the program to create an output structure containing a
C          data array of type FLOAT. Otherwise, the output data array will 
C          be of the same type as the input.
C
C
C   Propagation of data structure
C   -----------------------------
C   - All standard objects except the data array and axes are copied from 
C     IMAGE.
C   - Data array and axes are modified and reshaped.
C
C
C   Method
C   ------
C   - The IMAGE structure is tested for the bad data flag. If is it found 
C     and non-zero, magic values are assumed to be present and are left in 
C     the data.
C   - If the data array in IMAGE is of type SHORT, the option of creating an
C     OUTPUT array of type FLOAT is given, to prevent overflow errors. If 
C     this option is selected, the OUTPUT structure is created using the
C     appropriate structure definition file.
C   - If the OUTPUT array is to be of the same type as the IMAGE array, the
C     structure IMAGE is copied to OUTPUT, with the exception of the data
C     array and axes.  DSA_RESHAPE_ routines are called to modify the 
C     dimensions of the OUTPUT data and axis arrays.
C   - The calibrations, labels, and units of the uncollapsed IMAGE axes are
C     copied to the appropriate OUTPUT axes. 
C   - A subroutine appropriate to the data type, the presence or absence of
C     magic values, and whether or not axis 1 is collapsed is called to 
C     collapse the OUTPUT data array. If axis 1 is not involved, it is more
C     efficient to use a routine which does not test for the fact.
C   - If a magic value pixel is found while summing, it is ignored, but the 
C     sum is still valid. This method differs from the usual treatment of 
C     magic values, since the occurrence of an input magic value pixel 
C     generally renders the corresponding output pixel invalid.  
C     In the case of a quality array, the output pixel is flagged as bad
C     in the quality array if any of the summed pixels is bad.
C
C   External functions & subroutines called
C   ---------------------------------------
C   Library DSA:
C     DSA_CLOSE
C     DSA_CREATE_STRUCTURE
C     DSA_DATA_SIZE 
C     DSA_GET_AXIS_INFO
C     DSA_INPUT
C     DSA_MAP_AXIS_DATA
C     DSA_MAP_DATA
C     DSA_MAP_ERRORS
C     DSA_MAP_QUALITY
C     DSA_OPEN
C     DSA_OUTPUT
C     DSA_RESHAPE_AXIS
C     DSA_RESHAPE_DATA
C     DSA_SEEK_ERRORS
C     DSA_SEEK_QUALITY
C     DSA_SET_AXIS_INFO
C     DSA_SET_STRUCT_VAR
C     DSA_SIMPLE_OUTPUT
C     DSA_TYPESIZE
C     DSA_USE_FLAGGED_VALUES
C     DSA_WRUSER
C
C   Library DYN:
C     DYN_ELEMENT
C
C   Library ICH:
C     ICH_ENCODE
C
C   Library NDP:
C     NDP_AXIS_RANGE
C     NDP_DISPLAY_PROGRESS
C     NDP_ERROR_ARITH_W
C     NDP_ERROR_ARITH_R
C     NDP_GET_IMAGE_INFO
C     NDP_PAR_RDARY
C
C   Library PAR:
C     PAR_RDVAL
C     
C   Library GEN:
C     GEN_FILL
C
C   Internal subroutines called
C   ---------------------------
C   COLLAPSE_NEWAXIS
C   COLLAPSE_AX1COL_W
C   COLLAPSE_AX1COL_WQ
C   COLLAPSE_AX1COL_R
C   COLLAPSE_AX1COL_RQ
C   COLLAPSE_AX1NOTCOL_W
C   COLLAPSE_AX1NOTCOL_WQ
C   COLLAPSE_AX1NOTCOL_R
C   COLLAPSE_AX1NOTCOL_RQ
C
C
C   INCLUDE statements
C   ------------------
C   INCLUDE 'DYN_SOURCE:DYNAMIC_MEMORY.INC'
C   INCLUDE 'NDP_SOURCE:NDP_MAGIC_VALUES.INC'
C   INCLUDE 'NDP_SOURCE:NDP_NUMERIC_RANGES.INC'
C                                                
C
C   Extensions to FORTRAN77
C   -----------------------                           
C   END DO / IMPLICIT NONE / INCLUDE / Names > 6 characters
C
C                           
C   Possible future upgrades
C   ------------------------
C
C
C   Author/s
C   --------
C   Nick Fuller  RGO  (RGVAD::NMJF or NMJF@UK.AC.RGO.STAR)
C   Julian Gold  RGO  (CAVAD::GOLDJIL or GOLDJIL@UK.AC.CAM.AST-STAR)
C
C   History
C   -------
C   01-FEB-1989   - Original program
C   16-OCT-1991   - Quality and error array handling added. Subroutines
C                   written in GENERIC form.
C                   Dependence on .DEF file removed. (GOLDJIL)
C   07-FEB-1992   - DSA_CFILLx calls replaced with GEN_FILL, since the
C                   former is not in the shareable library (GOLDJIL)
C   27-NOV-1992   - Unix version (GOLDJIL).
C   06-OCT-1994   - Removed unused variables. (GJP)
C
1 degamma
  Designed to remove statistically irrelevant data, for example
  cosmic ray events - hence the name. It works by looking for pixels
  that lie more than a prescribed number of standard deviations
  from the mean  value in the z-axis. For these pixels, the neighbouring
  values are examined to see if they lie within a user defined tolerance 
  band. If not, they can be replaced either with a magic value/bad quality 
  value or an interpolated value. 
2 IMAGE
   NAME    IM(AGE)
   TYPE    FILE
   OPTIONS INPUT
   PROMPT  "(IMage) Name of input image"
   TEXT    ---------------------------------------------------------------
           This refers to the image you wish to clean up. Type in its
           file name without any extension (ie no .DST)
           ---------------------------------------------------------------
2 OUTPUT
   NAME    OUT(PUT)
   TYPE    FILE
   OPTIONS OUTPUT
   PROMPT  "(OUTput) Name of output image"
   TEXT    ---------------------------------------------------------------
           OUTPUT is the name of the structure which will contain the
           output image. 
           ---------------------------------------------------------------
2 VERBOSE
   NAME    VERB(OSE)
   TYPE    KEY
   OPTIONS NOPROMPT
   TEXT    ---------------------------------------------------------------
           Specifying this keyword on the command line results in progress
           messages being written to the terminal.
           ---------------------------------------------------------------
2 XYWEIGHT
   NAME    XYW(EIGHT)
   TYPE    FLOAT
   OPTIONS NOPROMPT
   TEXT    ---------------------------------------------------------------
           When neighbouring pixels are compared, it may be more signi-
           ficant that two pixels lie side-by-side than above or below
           each other. This parameter allows you to weight pixels that
           lie next to each other higher than those that lie beneath
           or above when it is > 1.0, or give less weight when < 1.0.
           ---------------------------------------------------------------
2 NDEVS
   NAME    NDEV(S)
   TYPE    FLOAT
   PROMPT  "(NDEVs) Number of standard deviations for a legal pixel"
   TEXT    ---------------------------------------------------------------
           DEGAMMA works by scanning the input image looking for pixels
           whose absolute deviation from the mean pixel value is greater
           than a NDEVS standard deviations. 
           ---------------------------------------------------------------
2 FLAGBAD
   NAME    FLAG(BAD)
   TYPE    KEY
   PROMPT  "(FLAGbad) Set defective pixels' quality as bad?"
   TEXT    --------------------------------------------------------------
           If FLAGBAD is TRUE, pixels eliminated from the array will be
           flagged as bad quality (either by a magic value or non-zero
           quality array entry).
           If FLAGBAD is FALSE, the pixel will be interpolated from its
           neigbours.
           --------------------------------------------------------------  
2 DOEDGE
   NAME    DOEDGE
   TYPE    KEY
   PROMPT  "(DOEDGE) Include edge pixels in the search?"
   TEXT    ---------------------------------------------------------------
           Edge pixels have less information about neigbours than do other
           pixels. Decisions the program may make about validity of
           pixel values may not necessarily be as accurate, therefore.
           If you still wish to include edge pixels in the search,
           set this parameter. Note that edge pixels are still used
           by the program, but they are not tested themselves.
           ---------------------------------------------------------------
2 NNPIX
  NAME     NN(PIX)
  TYPE     FLOAT
  PROMPT   "(NNpix) Number of neighbour pixels to compare."
  TEXT     ---------------------------------------------------------------
           A pixel will in all circumstances be considered valid if a
           number of its neighbours are sufficiently close in value.
           This parameter sets the number of closest pixels needed
           to confirm validity.
           ---------------------------------------------------------------
2 TOL
  NAME    TOL
  TYPE    FLOAT
  PROMPT  "(TOL) Tolerance for pixel equality"
  TEXT    ----------------------------------------------------------------
          Two neighbouring pixels will be considered equal in value if
          their absolute difference is less than this parameter. If
          the parameter's value is small, many pixels may be rejected!
          ---------------------------------------------------------------- 
2 START
  NAME    ST(ART)
  TYPE    FLOAT[6]
  PROMPT  "(STart) Start coordinates of subset."
  TEXT    ----------------------------------------------------------------
          START is an array containing the start coordinate of the subset
          to be processed in each dimension of IMAGE. The first array   
          element is the start coordinate in the first dimension of the 
          current sort order (usually X). Each coordinate must be given 
          in axis units if the relevant axis is calibrated, or in pixels 
          if it is not calibrated or the axis structure is not present.  
          ----------------------------------------------------------------
2 END
  NAME    EN(D)
  TYPE    FLOAT[6]
  PROMPT  "(ENd) End coordinates of subset."
  TEXT    ----------------------------------------------------------------
          END is an array containing the end coordinate of the subset
          to be processed in each dimension of IMAGE. The first array
          element is the end coordinate in the first dimension of the 
          current sort order (usually X). Each coordinate must be given 
          in axis units if the relevant axis is calibrated, or in pixels 
          if it is not calibrated or the axis structure is not present.  
          ----------------------------------------------------------------
2 WHOLE
  NAME    WH(OLE)
  TYPE    KEY
  PROMPT  "(WHole) Process the whole image?"
  TEXT    ----------------------------------------------------------------
          WHOLE is used to indicate that you wish to process the entire
          image rather than a subset of it. If it is set to FALSE, then
          a range of co-ordinate values for the susbset will be asked for.
          ----------------------------------------------------------------
2 POSDEV
  NAME    POS(dev)
  TYPE    KEY
  PROMPT  "(POSdev) Only look for positive deviations from the mean?"
  TEXT    ----------------------------------------------------------------
          Cosmic ray events will cause the deviation from the mean pixel
          value to be positive. Setting this keyword will instruct the
          program to look only for pixels which have large positive
          deviations. Otherwise, all large deviations are examined.
          ----------------------------------------------------------------
2 SOURCE_COMMENTS
C+
C
C   -------------
C   D E G A M M A
C   -------------
C
C   Description
C   -----------
C   This program allows the user to "clean up" an image which has spurious
C   pixel values, perhaps due to cosmic ray events (hence the name).
C
C   Scope of program
C   ----------------
C   - 3D data only, (z,x,y) sorted.
C   - SHORT and FLOAT data accepted, all others mapped to float
C   - Magic values, quality and error arrays supported.
C   - Subsetting supported.
C
C   Environment
C   -----------
C   FIGARO
C
C
C   Parameters (read or written)
C   ----------------------------
C   IMAGE       Name of input image structure (character)
C
C   OUTPUT      Name of the structure containing the output image. (character)
C
C   NDEVS       The number of standard deviations a pixel value can differ from
C               the mean pixel value before we suspect it may not be kosher.
C               (integer)
C
C   TOL         When a suspect pixel is found, we look at its neighbours to
C               see if it's alone or not. This parameter is a tolerance
C               used to decide whether a pixel is similar to any of its
C               neighbours, ie it will be if
C                                 | PIXEL - NEIGHBOUR | < TOL
C               for any neighbour. (float)
C   
C   NNPIX       This is the number of neighbouring pixels we might expect to
C               find similar to the pixel in question. If it's 0, then the
C               suspect pixel will be wiped regardless. If it's n, then the
C               suspect pixel will be wiped if fewer than n neighbours are
C               within the tolerance band. (integer)
C
C   START       Start of image subset (real array)
C
C   END         End of image subset   (real array)
C
C   XYWEIGHT    Weighting to pixels that lie side-by-side rather than above
C               or below eacj other (real, hidden).
C
C   Keywords
C   --------
C   DOEDGE      If true (default) then the edge pixels will be processed. 
C               Since there is less information for an edge pixel, it is
C               more likely to change value when processed.
C
C   FLAGBAD     If this is true, then pixels are simply flagged as bad (either
C               a magic value is placed in the location or a the quality array
C               has a 1 placed in it, dependent on context). If it is false,
C               the program will attempt to find a suitable value for the pixel.
C
C   VERBOSE     If true, the program is more talkative in a soliloquistic
C               sort of way.
C
C   WHOLE       Indicates whether all the image or a subset of the image is
C               to be processed.
C
C   POSDEV      Only count positive deviations from the mean as bad.
C
C   Method
C   ------ 
C   - The file to be processed is opened and relevant attributes are obtained. 
C   - Various processing controls are obtained through the parameter system.
C   - The output file is opened.
C   - The data arrays, quality and variance arrays are mapped as appropriate.
C     Errors are mapped as variances to simplify arithmetic.
C   - The means and standard deviations for every pixel in the x-y plane are
C     computed.
C   - The program scans through each "column" of z values. If a pixel value
C     is found that differs from the mean by more than NDEVS standard dev-
C     iations, that pixel is treated as suspect. If it has fewer than NNPIX
C     neighbours whose value are within TOL of it, then it is considered a
C     spurious value. It is then either replaced with a magic value/non-zero
C     quality array entry or interpolated from its neighbours, depending on
C     the state of FLAGBAD. If there is insufficient data to interpolate from,
C     the average pixel value for that spectrum will be inserted.
C   - If FLAGBAD is true AND there is no quality array present AND pixels
C     were replaced, the bad pixel flag is set in the output structure.
C   - Clean up and exit.
C
C   Possible Improvements
C   ---------------------
C   Consider the "diagonal" neighbours as well for extra information. 
C
C   External functions & subroutines called
C   ---------------------------------------
C   Library DSA:
C      DSA_CLOSE
C      DSA_DATA_SIZE
C      DSA_GET_WORK_ARRAY
C      DSA_INPUT
C      DSA_MAP_AXIS_DATA
C      DSA_MAP_DATA
C      DSA_MAP_QUALITY
C      DSA_MAP_VARIANCE
C      DSA_OPEN
C      DSA_OUTPUT
C      DSA_SEEK_QUALITY
C      DSA_SEEK_VARIANCE
C      DSA_SET_FLAGGED_VALUES
C      DSA_WRUSER
C
C   Library DYN:
C      DYN_ELEMENT
C   
C   Library ICH:
C      ICH_CI
C      ICH_LEN
C
C   Library NDP:
C      NDP_AXIS_RANGE
C      NDP_GET_IMAGE_INFO
C
C   Library PAR:
C      PAR_GIVEN
C      PAR_RDKEY
C      PAR_RDVAL
C
C
C   Internal subroutines called
C   ---------------------------
C   DEGAMMA_FIND_<T>[Q]
C   DEGAMMA_MEAN_<T>[Q]
C   DEGAMMA_SDEV_<T>[Q]
C   DEGAMMA_W_REPLACED
C   DEGAMMA_W_SETBAD
C   DEGAMMA_W_SUBMEAN
C   GET_PIXEL_STATUS
C   REPLACE_PIXEL_<T>[Q]
C 
C   INCLUDE statements
C   ------------------
C   INCLUDE 'DYN_SOURCE:DYNAMIC_MEMORY.INC'       
C   INCLUDE 'NDP_SOURCE:NDP_MAGIC_VALUES.INC'
C   INCLUDE 'NDP_SOURCE:NDP_NUMERIC_RANGES.INC'
C   INCLUDE 'DCV_FUN'
C
C
C   Extensions to FORTRAN77
C   -----------------------
C   END DO / IMPLICIT NONE / INCLUDE / Names > 6 characters
C
C
C   Possible future upgrades
C   ------------------------ 
C
C
C   Author
C   ------
C   Julian Gold  RGO  (CAVAD::GOLDJIL or GOLDJIL@UK.AC.CAM.AST-STAR)
C
C   History
C   -------
C   03-JUN-1992   - Original program. (GOLDJIL)
C   23-OCT-1992   - Added POSDEV option.
C   26-OCT-1992   - Added (hidden) XYWEIGHT parameter.
C   30-NOV-1992   - Unix version.
C   06-OCT-1994   - Removed lots of unused variables. (GJP)
C
1 depict
  Plots a 2-D image or image subset in greyscale or colour on an image
  display device. Optional overplotting with contours of the same 
  or another 2-D image is possible.
2 IMAGE
   NAME    IM(AGE)
   TYPE    FILE
   OPTIONS INPUT
   PROMPT  "(IMage) Name of image to be displayed"
   TEXT    ----------------------------------------------------------------
           IMAGE is the name of the structure containing the image to be 
           displayed. The image must be 2-D.
           ----------------------------------------------------------------
2 WHOLE
   NAME    WH(OLE)
   TYPE    KEY                                               
   PROMPT  "(WHole) Display the whole image?"
   TEXT    ----------------------------------------------------------------
           If WHOLE is specified, the entire 2-D image will be displayed.
           Otherwise, a subset of the image may be selected.
           ----------------------------------------------------------------
2 START
   NAME    ST(ART)
   TYPE    FLOAT[6]
   PROMPT  "(STart) Start coordinates of subset."
   TEXT    ----------------------------------------------------------------
           START is an array containing the start coordinate of the subset
           to be displayed in each dimension of the image. The first array
           element is the start coordinate in the first dimension of the 
           current sort order (usually X). Each coordinate must be given 
           in axis units if the relevant axis is calibrated, or in pixels 
           if it is not calibrated or the axis structure is not present.  
           ----------------------------------------------------------------
2 END
   NAME    EN(D)
   TYPE    FLOAT[6]
   PROMPT  "(ENd) End coordinates of subset."
   TEXT    ----------------------------------------------------------------
           END is an array containing the end coordinate of the subset
           to be displayed in each dimension of the image. The first array
           element is the end coordinate in the first dimension of the 
           current sort order (usually X). Each coordinate must be given 
           in axis units if the relevant axis is calibrated, or in pixels 
           if it is not calibrated or the axis structure is not present.  
           ----------------------------------------------------------------
2 LOW
   NAME    LO(W)
   TYPE    FLOAT
   PROMPT  "(LOw) Lowest value to be displayed"
   TEXT    ----------------------------------------------------------------
           Pixels less than or equal to LOW will be plotted in the lowest
           colour index if a colour table is used, or as black if a grey
           scale is used. This convention applies to screen devices, and 
           is reversed on hard copy devices to conserve ink or toner.
           ----------------------------------------------------------------
                    
2 HIGH
   NAME    HI(GH)
   TYPE    FLOAT
   PROMPT  "(HIgh) Highest value to be displayed"
   TEXT    ----------------------------------------------------------------
           Pixels greater than or equal to HIGH will be plotted in the
           highest colour index if a colour table is used, or as white if 
           a grey scale is used. This convention applies to screen devices,
           and is reversed on hard copy devices to conserve ink or toner.
           ----------------------------------------------------------------
2 PLACE
   NAME    PLACE
   TYPE    CHAR
   PROMPT  "(PLACE) Location of plot"
   TEXT    ----------------------------------------------------------------
           PLACE controls the location of the image on the screen or page. 
           Options are 'BL','BC','BR','LC','CC','RC','TL','TC', and 'TR'.
           ----------------------------------------------------------------
2 MAG
   NAME    MAG
   TYPE    FLOAT
   PROMPT  "(MAG) Magnification of plot"
   TEXT    ----------------------------------------------------------------
           If MAG is 1, the image plot will be fitted to the full display 
           surface. Values less than 1 will reduce both linear dimensions 
           by the same fraction.
           ----------------------------------------------------------------
2 LABEL
   NAME    LAB(EL)
   TYPE    CHAR
   PROMPT  "(LABel) Label for plot"
   TEXT    ----------------------------------------------------------------
           This character string will be placed above the image plot.
           ----------------------------------------------------------------
2 AXES
   NAME    AX(ES)
   TYPE    KEY
   PROMPT  "(AXes) Plot image axes?"
   TEXT    ----------------------------------------------------------------
           If AXES is specified, calibrated axes will be plotted around
           the image. Otherwise, the image will be plotted in a plain box.
           ----------------------------------------------------------------
2 RAMP
   NAME    RAMP
   TYPE    KEY
   PROMPT  "(RAMP) Plot colour or grey scale ramp?"
   TEXT    ----------------------------------------------------------------
           If RAMP is specified, the colour or grey scale, calibrated in 
           image data units, will be plotted to the right of the image.
           ----------------------------------------------------------------
2 CONTOUR
   NAME    CONT(OUR)
   TYPE    KEY
   PROMPT  "(CONTour) Overplot with contours?"
   TEXT    ----------------------------------------------------------------
           If CONTOUR is specified, a contour map of the same or another 
           2-D image will be plotted over the image plot.
           ----------------------------------------------------------------
2 IMAGE1
   NAME    IMAGE1
   TYPE    FILE
   OPTIONS INPUT
   PROMPT  "(IMAGE1) Name of image to be contoured"
   TEXT    ----------------------------------------------------------------
           IMAGE1 is the name of the structure containing the image to be 
           contoured. It need not be the same size as IMAGE, provided the 
           start and end coordinates are chosen so that the two subsets
           are the same size. The image must be 2-D.
           ----------------------------------------------------------------
2 LOW1
   NAME    LOW1
   TYPE    FLOAT
   PROMPT  "(LOW1) Lowest value to be contoured"
   TEXT    ----------------------------------------------------------------
           Pixel values below LOW1 will not be contoured.
           ----------------------------------------------------------------
                    
2 HIGH1
   NAME    HIGH1
   TYPE    FLOAT
   PROMPT  "(HIGH1) Highest value to be contoured"
   TEXT    ----------------------------------------------------------------
           Pixel values above HIGH1 will not be contoured.
           ----------------------------------------------------------------
2 LEVELS
   NAME    LEVELS
   TYPE    INT
   PROMPT  "(LEVELS) Number of contour levels"
   TEXT    ----------------------------------------------------------------
           LEVELS is the number of different contour values, e.g. 
           isophotes, to be drawn. Since this number is commonly 
           overestimated, a small number such as 5 should be chosen as a 
           first test, especially if the image is noisy. The levels will 
           be interpolated at equal intervals between LOW1 and HIGH1.
           ----------------------------------------------------------------
2 HARDCOPY
   NAME    HA(RDCOPY)
   TYPE    KEY
   PROMPT  "(HArdcopy) Produce hardcopy plot?"
   TEXT    ----------------------------------------------------------------
           If HARDCOPY is specified, the image plot will be written to the 
           current hardcopy device. Otherwise, the image will be plotted
           on the current screen device.
           ----------------------------------------------------------------
2 TABLE
   NAME    TAB(LE)
   TYPE    CHAR
   PROMPT  "(TABle) Name of lookup table"
   TEXT    ----------------------------------------------------------------
           TABLE is the name of a file containing red, green, and blue
           intensities for each of 256 colour indices. These form a colour
           table which will be used in the plotting of the 2-D image. The 
           name extension .LUT is assumed, unless TABLE is 'GREY', in 
           which case a grey scale will be constructed without using a 
           table file.
           ----------------------------------------------------------------
2 ERASE
   NAME    ER(ASE)
   TYPE    KEY
   PROMPT  "(ERase) Erase screen before plotting?"
   TEXT    ----------------------------------------------------------------
           If ERASE is specified, the screen will be cleared before the 
           plot is displayed. Otherwise, the current screen display will
           remain. This feature may be used to display several images in
           different areas of the screen.
           ----------------------------------------------------------------
2 SOURCE_COMMENTS
C+
C
C   -----------
C   D E P I C T
C   ----------- 
C
C   Description
C   -----------
C   Plots a 2-D image in greyscale or colour on an image display device,
C   with optional overplotted contours of the same or another 2-D image, and
C   optional hardcopy.
C
C
C   Scope of program
C   ----------------
C   - Handles 2-D images only.
C   - Data array types SHORT and FLOAT supported; others converted to FLOAT.
C   - Subsetting supported.
C   - Magic values and quality arrays supported.
C   - Variance arrays not supported.
C   - Batch execution supported.
C
C
C   Environment
C   -----------
C   FIGARO
C
C
C   Parameters (read or written)
C   ----------------------------
C   IMAGE    Name of the structure containing the image to be displayed. 
C            (character)(prompted for).
C
C   START    Coordinate in each dimension of IMAGE at which the display is
C            to start. (real, array)(prompted for).
C
C   END      Coordinate in each dimension of IMAGE at which the display is
C            to end. (real, array)(prompted for).
C
C   LOW      Data value which is plotted in the lowest colour index or as 
C            black. (real)(prompted for). 
C
C   HIGH     Data value which is plotted in the highest colour index or as
C            white. (real)(prompted for). 
C
C   PLACE    Code for one of nine possible locations on the display surface,
C            being a combination of T, C, or B, and L, C, or R. (character)
C            (prompted for).
C
C   MAG      Magnification of the plot. Magnification 1 fits the plot to the
C            whole display surface. (real)(prompted for).
C
C   LABEL    Text placed centrally above the plot. (character)(prompted 
C            for).
C
C   IMAGE1   Name of the structure containing the image to be contoured, if
C            CONTOUR is true. (character)(prompted for).
C
C   LOW1     Lowest data value to be contoured. (real)(prompted for).
C
C   HIGH1    Highest data value to be contoured. (real)(prompted for).
C
C   LEVELS   Number of contour levels. The first contour is at LOW and the
C            last is at HIGH. The data range HIGH-LOW divided by LEVELS-1 
C            gives the contour interval. (integer)(prompted for).
C
C   TABLE    Name of colour or grey scale lookup table. (character)
C            (prompted for).      
C            
C   SOFTDEV  Current screen device name (character)(read from file).
C
C   HARDDEV  Current hardcopy device name (character)(read from file).
C
C
C   Keywords
C   --------
C   WHOLE    Instruction to display the whole image. Otherwise, a subset of 
C            each dimension may be selected.
C
C   AXES     Instruction to plot calibrated axes. Otherwise, the image is
C            framed with a plain box.
C
C   RAMP     Instruction to plot a calibrated bar of the colour or grey 
C            scale to the right of the image.
C
C   CONTOUR  Instruction to overplot with contours of the same or another
C            2-D image.
C
C   HARDCOPY Instruction to plot on the current hardcopy device.
C
C   ERASE    Instruction to erase screen before plotting. Otherwise, a
C            number of images may be displayed at different places on the
C            same screen.
C
C
C
C   Propagation of data structure
C   -----------------------------
C   Not relevant.
C
C
C   Method
C   ------
C   - The current screen and hardcopy device names are read from the
C     parameter file.
C   - The IMAGE structure is tested for the bad data flag. If it is found
C     and non-zero, magic values are assumed to be present and are left in
C     tha data.
C   - The data array is mapped as FLOAT regardless of its type, because
C     PGPLOT (and ultimately GKS) only handle floating point data.
C   - If magic values are present, they are replaced by a value below the
C     lower threshold as supplied by the user.
C   - The required lookup table is read and stored. This is done by the 
C     routine NDP_IMAGE_LUT.
C   - The mapped array is processed into integer colour indices by
C     NDP_IAMGE_INDEX.
C   - The index array is passed to NDP_IMAGE_PLOT, which calls PGPIXL to
C     plot the image.
C   - If overplotted contours of a different image are required, the data 
C     array is mapped as FLOAT and any magic values are replaced by values
C   - below the user supplied threshold for the contour map.
C   - The mapped array to be contoured is passed to PGCONT without clearing 
C     the screen or changing the PGPLOT viewport, so that the contours are
C     registered with the image.
C
C
C   External functions & subroutines called
C   ---------------------------------------
C   Library DSA:
C     DSA_CLOSE
C     DSA_DATA_SIZE
C     DSA_GET_WORKSPACE
C     DSA_INPUT
C     DSA_MAP_DATA
C     DSA_MAP_QUALITY
C     DSA_OPEN
C     DSA_TYPESIZE
C     DSA_SEEK_QUALITY
C     DSA_USE_FLAGGED_VALUES
C     DSA_WRUSER
C
C   Library DYN:
C     DYN_ELEMENT
C
C   Library GEN:
C     GEN_MOVE
C
C   Library ICH:
C     ICH_LEN
C
C   Library NDP:
C     NDP_AXIS_RANGE
C     NDP_GET_IMAGE_INFO
C     NDP_IMAGE_INDEX
C     NDP_IMAGE_LUT
C     NDP_IMAGE_PLOT
C     NDP_IMAGE_VIEWPORT
C     NDP_REPLACE_MAGIC_R
C     NDP_REPLACE_QUAL_R
C
C   Library PAR:
C     PAR_RDCHAR
C     PAR_RDKEY
C     PAR_RDVAL
C     
C   Library VAR:
C     VAR_GETCHR
C
C   Starlink PGPLOT:
C     PGBEGIN
C     PGCONT
C     PGEND
C     PGVSIZE
C     PGWINDOW
C
C
C   Internal subroutines called
C   ---------------------------
C   DEPICT_CONTOUR
C
C
C   INCLUDE statements
C   ------------------
C   INCLUDE 'DYN_SOURCE:DYNAMIC_MEMORY.INC'
C   INCLUDE 'NDP_SOURCE:NDP_NUMERIC_RANGES.INC'
C   INCLUDE 'NDP_SOURCE:NDP_MAGIC_VALUES.INC'
C                                                
C
C   Extensions to FORTRAN77
C   -----------------------                           
C   END DO / IMPLICIT NONE / INCLUDE / Names > 6 characters
C
C                           
C   Possible future upgrades
C   ------------------------
C
C
C   Author/s
C   --------
C   Nick Fuller  RGO  (RGVAD::NMJF or NMJF@UK.AC.RGO.STAR)
C   Jim Lewis    RGO  (CAVAD::JRL or JRL@UK.AC.CAM.AST-STAR)
C   Julian Gold  RGO  (CAVAD::GOLDJIL or GOLDJIL@UK.AC.CAM.AST-STAR)
C
C
C   History
C   -------
C   01-FEB-1989   - Original program (NMJF)
C   14-JUN-1990   - Parameters in some subroutine calls changed to avoid 
C                   dimensioning arrays with elements of another array.  Also 
C                   included call to new LUT routine.  (Temporary measure as 
C                   NDP_IMAGE_LUT no longer works...) (JRL)
C   29-AUG-1990   - New version of NDP_IMAGE_LUT now included.  (JRL)
C   17-SEP-1990   - No longer replaces magic values with zeros.  This assumes 
C                   that the data is always going to be greater than zero which 
C                   in certain cases (e.g. a velocity map) it may not be.  
C                   They are now replaced by a value which is below the lower
C                   threshold requested for the plot and/or the contour map.  
C                   The magic values are now also replaced only in a direct 
C                   copy of the original file.  This is because if the data 
C                   are mapped directly, then any changes will be copied to the
C                   disk, even if it is mapped READ.  The data pointer for 
C                   non-FLOAT data which has been mapped FLOAT (e.g. type 
C                   converted) will be the pointer for a workspace anyway, 
C                   so the copying only has to be done for FLOAT data which 
C                   has been mapped FLOAT.  (JRL)
C   15-OCT-1991   - Quality arrays implemeted. (GOLDJIL)
C   07-FEB-1992   - Changed to new NDP 2D gfx routines. (GOLDJIL)
C   07-FEB-1992   - Changed to new NDP 2D gfx routines. (GOLDJIL)
C   24-NOV-1992   - Unix version (GOLDJIL)
C
1 dummy
  Creates a new structure containing a data array and axes initialised
  to specific values.
2 OUTPUT
   NAME    OUT(PUT)
   TYPE    FILE
   OPTIONS OUTPUT
   PROMPT  "(OUTput) Name of image to be created"
   TEXT    ----------------------------------------------------------------
           OUTPUT is the name of the structure which will contain the
           dummy image. If OUTPUT already exists, a new version will be
           created.
           ----------------------------------------------------------------
             
2 NDIM
   NAME    NDIM
   TYPE    INT
   PROMPT  "(NDIM) Number of dimensions"
   TEXT    ----------------------------------------------------------------
           The image may have from one to six dimensions.
           ----------------------------------------------------------------
2 SIZE
   NAME    SIZE
   TYPE    INT[6]
   PROMPT  "(SIZE) Dimensions of image."
   TEXT    ----------------------------------------------------------------
           SIZE is an array containing the size of each dimension of the
           image. The first array element is the size of the first
           dimension.
           ----------------------------------------------------------------
2 AXES
   NAME    AX(ES)
   TYPE    KEY                                               
   PROMPT  "(AXes) Calibrate the axes?"
   TEXT    ----------------------------------------------------------------
           If AXES is specified, the axes may be calibrated by assigning
           a start and end value to each. 
           ----------------------------------------------------------------
2 AXKEY
   NAME    AXKEY
   TYPE    INT[6]
   PROMPT  "(AXKEY) Keys for axes to be calibrated."
   TEXT    ----------------------------------------------------------------
           AXKEY is an array containing the instruction to leave alone or
           calibrate each axis. 0 = leave alone, 1 = calibrate. 
           ----------------------------------------------------------------
2 AXSTART
   NAME    AXST(ART)
   TYPE    FLOAT[6]
   PROMPT  "(AXSTart) Start values of axes."
   TEXT    ----------------------------------------------------------------
           AXSTART is an array containing the start calibration value of 
           each axis. The first array element is the start value of the
           first axis.
           ----------------------------------------------------------------
2 AXEND
   NAME    AXEN(D)
   TYPE    FLOAT[6]
   PROMPT  "(AXENd) End values of axes."
   TEXT    ----------------------------------------------------------------
           AXEND is an array containing the end calibration value of each 
           axis. The first array element is the end value of the first
           axis.
           ----------------------------------------------------------------
2 AXLOG
   NAME    AXLOG
   TYPE    INT[6]
   PROMPT  "(AXLOG) Keys for logarithmic scaling."
   TEXT    ----------------------------------------------------------------
           AXLOG is an array containing the instruction for linear or log-
           arithmic calibration of each axis. 0 = linear, 1 = logarithmic. 
           ----------------------------------------------------------------
2 EXTRA
   NAME    EXTRA
   TYPE    CHAR
   PROMPT  "(EXtra) (M)agic values, (Q)uality arrays or (E)rror arrays?"
   TEXT    --------------------------------------------------------------- 
           Specify an M to include magic values in the data, a Q to set
           up a quality array, an E to construct an error array or any
           other character for the data alone.
           ---------------------------------------------------------------
2 VALUE
   NAME    VAL(UE)
   TYPE    FLOAT
   PROMPT  "(VALue) Value to be assigned to every pixel"
   TEXT    ----------------------------------------------------------------
           Every pixel of the image will be assigned this value.
           ----------------------------------------------------------------
2 DTYPE
   NAME    DTY(PE)
   TYPE    CHAR
   PROMPT  "(DTYpe) Choose data type as B(yte), S(hort) or F(loat)"
   TEXT    ----------------------------------------------------------------
           Type one character to indicate the type of the structure data.
           The default data type is SHORT.
           ----------------------------------------------------------------
2 ERRVAL
   NAME    ERRV(AL)
   TYPE    FLOAT
   PROMPT  "(ERRVal) Value to be assigned to the error array"
   TEXT    ---------------------------------------------------------------
           Every pixel of the image will have this error value.
           ---------------------------------------------------------------
2 QVAL
   NAME    QV(AL)
   TYPE    BYTE
   PROMPT  "(QVal) Value to be assigned to the quality array"
   TEXT    ---------------------------------------------------------------
           Every pixel of the image will have this quality value.
           ---------------------------------------------------------------
2 SOURCE_COMMENTS
C+
C
C   ---------
C   D U M M Y
C   ---------
C
C   Description
C   -----------
C   Creates a new structure containing a data array and axes. The data
C   array may be of type BYTE, SHORT, or FLOAT, and may be filled with a 
C   specified value or with magic values. Error arrays and/or quality arrays
C   can also be included.
C
C
C   Scope of program
C   ----------------
C   - Images of up to six dimensions may be created.
C   - Data array types BYTE, SHORT, and FLOAT may be created.
C   - Subsetting not supported since not relevant.
C   - Magic values supported (a data array of magic values may be created).
C   - Quality and error arrays supported.
C   - Batch execution supported.
C
C
C   Environment
C   -----------
C   FIGARO
C
C
C   Parameters (read or written)
C   ----------------------------
C   OUTPUT  Name of the structure containing the output image. (character)
C           (prompted for).
C
C   NDIM    Number of dimensions in the image. (integer)(prompted for).
C
C   SIZE    Size of each dimension of the image. (integer, array)
C           (prompted for).
C
C   AXKEY   Keys for axes to be calibrated. (integer, array)(prompted for).
C
C   AXSTART Start calibration value for each axis. (real, array)
C           (prompted for). 
C
C   AXEND   End calibration value for each axis. (real, array)
C           (prompted for). 
C
C   AXLOG   Keys for axes to be calibrated logarithmically.
C           (integer, array)(prompted for).
C
C   VALUE   Value to be assigned to every data array element. (real)
C           (prompted for).
C
C   EXTRA   Request for Quality arrays,error arrays or Magic values
C           to be part of the structure.(character, prompted)
C
C   DTYPE   Data type (float, byte or short). (character, prompted)
C
C   ERRVAL  Value to be assigned to the error array (float, prompted)
C
C   QVAL    Value to be assigned to the quality array (byte, prompted)
C      
C   Keywords
C   --------
C   AXES    Instruction to calibrate the axes of the image.
C
C
C   Propagation of data structure
C   -----------------------------
C   Not relevant.
C
C
C   Method
C   ------ 
C   - The dimensions, data type and the presence of magic values, quality
C     arrays and error arrays are obtained from the user.
C   - If it is required to calibrate the axes, the structure variable for
C     axis calibration is set, and the axis number(s), start and end 
C     value(s), and linear/logarithmic flag(s) are prompted for. The axes 
C     are then calibrated.
C   - Unless it is required to assign the magic value to every pixel, a
C     specific value is prompted for. The data array is filled with the 
C     dummy value.
C   - The bad data flag is set if the magic value was used.
C   - A quality or error array is created if requested.
C
C   External functions & subroutines called
C   ---------------------------------------
C   Library DSA:
C      DSA_CLOSE
C      DSA_MAP_AXIS_DATA
C      DSA_MAP_DATA
C      DSA_MAP_ERRORS
C      DSA_MAP_QUALITY
C      DSA_OPEN
C      DSA_OUTPUT
C      DSA_SIMPLE_OUTPUT
C      DSA_WRUSER
C
C   Library DYN:
C      DYN_ELEMENT
C   
C   Library GEN:
C      GEN_CFILL
C      GEN_FILL
C
C   Library ICH:
C      ICH_CI
C      ICH_DELIM
C      ICH_FOLD
C      ICH_LEN
C
C   Library NDP:
C      NDP_PAR_RDARY
C      NDP_SET_AXES
C      NDP_SET_BAD_PIXEL
C
C   Library PAR:
C      PAR_GIVEN
C      PAR_RDKEY
C      PAR_RDVAL
C
C
C   Internal subroutines called
C   ---------------------------
C   DUMMY_FILL_W
C
C 
C   INCLUDE statements
C   ------------------
C   INCLUDE 'DYN_SOURCE:DYNAMIC_MEMORY.INC'       
C   INCLUDE 'NDP_SOURCE:NDP_MAGIC_VALUES.INC'
C   INCLUDE 'NDP_SOURCE:NDP_NUMERIC_RANGES.INC'
C
C
C   Extensions to FORTRAN77
C   -----------------------
C   END DO / IMPLICIT NONE / INCLUDE / Names > 6 characters
C
C
C   Possible future upgrades
C   ------------------------ 
C   - Prompt for the label and units of each axis.
C
C
C   Author/s
C   --------
C   Nick Fuller  RGO  (RGVAD::NMJF or NMJF@UK.AC.RGO.STAR)
C   Julian Gold  RGO  (CAVAD::GOLDJIL or GOLDJIL@UK.AC.CAM.AST-STAR)
C
C   History
C   -------
C   01-FEB-1989   - Original program. (NMJF)
C   19-APR-1991   - Quality and error array handling added. (GOLDJIL)
C   04-JLY-1991   - Data type parameter acquisition re-written to specify
C                   by entering a single character.
C                   Removal of dependence on .DEF file constructs.
C                   Ability to specify any desired quality/error value.
C                   General tidy-up. (GOLDJIL)
C   18-MAR-1992   - Changed to link with shareable library. (GOLDJIL)
C
1 hilite
  Plots a 2-D image or image subset with a narrow colour table which
  moves through the data range, so that all pixels with a particular
  value are illuminated at the same time. Pixels not equal to the current 
  highlighted value are displayed as black. This is an effective way of
  finding the data values associated with features of interest. 
2 IMAGE
   NAME    IM(AGE)
   TYPE    FILE
   OPTIONS INPUT
   PROMPT  "(IMage) Name of image to be displayed"
   TEXT    ----------------------------------------------------------------
           IMAGE is the name of the structure containing the 2-D image to
           be progressively highlighted through a selected data range. 
           This is accomplished with a rotating lookup table which is 
           primarily black, but contains a small region of colour. As the
           lookup table rotates, all the image pixels of a particular 
           value become visible and then disappear as their value is 
           passed by the region of colour. This is an effective way of
           identifying which data values are associated with features of 
           interest, which might otherwise be difficult to see in a static
           image. It also looks very jolly.
           ----------------------------------------------------------------
2 WHOLE
   NAME    WH(OLE)
   TYPE    KEY                                               
   PROMPT  "(WHole) Display the whole image?"
   TEXT    ----------------------------------------------------------------
           If WHOLE is specified, the entire 2-D image will be displayed.
           Otherwise, a subset of the image may be selected.
           ----------------------------------------------------------------
2 START
   NAME    ST(ART)
   TYPE    FLOAT[6]
   PROMPT  "(STart) Start coordinates of subset."
   TEXT    ----------------------------------------------------------------
           START is an array containing the start coordinate of the subset
           to be displayed in each dimension of the image. The first array
           element is the start coordinate in the first dimension of the 
           current sort order (usually X). Each coordinate must be given 
           in axis units if the relevant axis is calibrated, or in pixels 
           if it is not calibrated or the axis structure is not present.  
           ----------------------------------------------------------------
2 END
   NAME    EN(D)
   TYPE    FLOAT[6]
   PROMPT  "(ENd) End coordinates of subset."
   TEXT    ----------------------------------------------------------------
           END is an array containing the end coordinate of the subset
           to be displayed in each dimension of the image. The first array
           element is the end coordinate in the first dimension of the 
           current sort order (usually X). Each coordinate must be given 
           in axis units if the relevant axis is calibrated, or in pixels 
           if it is not calibrated or the axis structure is not present.  
           ----------------------------------------------------------------
2 LOW
   NAME    LO(W)
   TYPE    FLOAT
   PROMPT  "(LOw) Lowest value to be displayed"
   TEXT    ----------------------------------------------------------------
           Pixels less than or equal to LOW will be plotted in the lowest
           colour index if a colour table is used, or as black if a grey
           scale is used. This convention applies to screen devices, and is
           reversed on hard copy devices to conserve ink or toner.
           ----------------------------------------------------------------
                    
2 HIGH
   NAME    HI(GH)
   TYPE    FLOAT
   PROMPT  "(HIgh) Highest value to be displayed"
   TEXT    ----------------------------------------------------------------
           Pixels greater than or equal to HIGH will be plotted in the
           highest colour index if a colour table is used, or as white if
           a grey scale is used. This convention applies to screen devices,
           and is reversed on hard copy devices to conserve ink or toner.
           ----------------------------------------------------------------
2 PLACE
   NAME    PLACE
   TYPE    CHAR
   PROMPT  "(PLACE) Location of plot"
   TEXT    ----------------------------------------------------------------
           PLACE controls the location of the image on the screen or page. 
           Options are 'BL','BC','BR','LC','CC','RC','TL','TC', and 'TR'.
           ----------------------------------------------------------------
2 MAG
   NAME    MAG
   TYPE    FLOAT
   PROMPT  "(MAG) Magnification of plot"
   TEXT    ----------------------------------------------------------------
           If MAG is 1, the image plot will be fitted to the full display 
           surface. Values less than 1 will reduce both linear dimensions 
           by the same fraction.
           ----------------------------------------------------------------
2 LABEL
   NAME    LAB(EL)
   TYPE    CHAR
   PROMPT  "(LABel) Label for plot"
   TEXT    ----------------------------------------------------------------
           This character string will be placed above the image plot.
           ----------------------------------------------------------------
2 AXES
   NAME    AX(ES)
   TYPE    KEY
   PROMPT  "(AXes) Plot image axes?"
   TEXT    ----------------------------------------------------------------
           If AXES is specified, calibrated axes will be plotted around
           the image. Otherwise, the image will be plotted in a plain box.
           ----------------------------------------------------------------
2 RAMP
   NAME    RAMP
   TYPE    KEY
   PROMPT  "(RAMP) Plot colour or grey scale ramp?"
   TEXT    ----------------------------------------------------------------
           If RAMP is specified, the colour or grey scale, calibrated in 
           image data units, will be plotted to the right of the image.
           ----------------------------------------------------------------
2 DATA
   NAME    DATA
   TYPE    KEY
   PROMPT  "(DATA) Plot data values?"
   TEXT    ----------------------------------------------------------------
           If DATA is specified, the value of the image pixels currently
           being highlighted will be displayed.
           ----------------------------------------------------------------
2 SHOWS
   NAME    SHOWS
   TYPE    INT
   PROMPT  "(SHOWS) Number of shows"
   TEXT    ----------------------------------------------------------------
           SHOWS is the number of times the full data range will be 
           highlighted, i.e. the number of rotations of the lookup table.
           ----------------------------------------------------------------
2 ERASE
   NAME    ER(ASE)
   TYPE    KEY
   PROMPT  "(ERase) Erase screen before plotting?"
   TEXT    ----------------------------------------------------------------
           If ERASE is specified, the screen will be cleared before the 
           plot is displayed. Otherwise, the current screen display will
           remain. This feature may be used to display several images in
           different areas of the screen.
           ----------------------------------------------------------------
2 SOURCE_COMMENTS
C+
C
C   -----------
C   H I L I T E
C   ----------- 
C
C   Description
C   -----------
C   Plots a 2-D image on an image display device, progressively highlighting
C   pixels through a selected data range. This is accomplished with a
C   rotating lookup table which is primarily black, but contains a small 
C   region of colour. As the program runs, all the image pixels of one
C   particular value become visible at the same time and then disappear. 
C   The intention is to show with one program the locations of data values 
C   which might be obscured if a large data range were mapped onto a static
C   lookup table in a standard image display program.
C
C
C   Scope of program
C   ----------------
C   - Handles 2-D images only.
C   - Data array types SHORT and FLOAT supported; others converted to FLOAT.
C   - Subsetting supported.
C   - Magic values and quality arrays supported.
C   - Variance arrays not supported.
C   - Batch execution not supported.
C
C
C   Environment
C   -----------
C   FIGARO
C
C
C   Parameters (read or written)
C   ----------------------------
C   IMAGE    Name of the structure containing the image to be displayed. 
C            (character)(prompted for).
C
C   START    Coordinate in each dimension of IMAGE at which the display is
C            to start. (real, array)(prompted for).
C
C   END      Coordinate in each dimension of IMAGE at which the display is
C            to end. (real, array)(prompted for).
C
C   LOW      Data value which is plotted in the lowest colour index or as 
C            black. (real)(prompted for). 
C
C   HIGH     Data value which is plotted in the highest colour index or as
C            white. (real)(prompted for). 
C
C   PLACE    Code for one of nine possible locations on the display surface,
C            being a combination of T, C, or B, and L, C, or R. (character)
C            (prompted for).
C
C   MAG      Magnification of the plot. Magnification 1 fits the plot to the
C            whole display surface. (real)(prompted for).
C
C   LABEL    Text placed centrally above the plot. (character)(prompted 
C            for).
C
C   SHOWS    Number of cycles through the data. (integer)(prompted for).
C
C   SOFTDEV  Current screen device name (character)(read from file).
C
C
C   Keywords
C   --------
C   WHOLE    Instruction to display the whole image. Otherwise, a subset of 
C            each dimension may be selected.
C
C   AXES     Instruction to plot calibrated axes. Otherwise, the image is
C            framed with a plain box.
C
C   RAMP     Instruction to plot a calibrated bar of the colour or grey 
C            scale to the right of the image. This actually produces an
C            interesting thermometer-like pointer which moves up the ramp
C            as the program runs.
C
C   DATA     Instruction to display the data value currently being 
C            highlighted.
C
C   ERASE    Instruction to erase screen before plotting. Otherwise, a
C            number of images may be displayed at different places on the
C            same screen.
C
C
C
C   Propagation of data structure
C   -----------------------------
C   Not relevant.
C
C
C   Method
C   ------
C   - The current screen and hardcopy device names are read from the
C     parameter file.
C   - The IMAGE structure is tested for the bad data flag. If it is found
C     and non-zero, magic values are assumed to be present and are left in
C     tha data.
C   - The data array is mapped as FLOAT regardless of its type, because
C     PGPLOT (and ultimately GKS) only handle floating point data.
C   - If magic values are present, they are replaced by a value which is
C     is lower than the lower threshold supplied by the user.
C   - A small lookup table based on one period of a sine wave is computed.
C   - The mapped array is passed to NDP_IMAGE_INDEX, which processes the
C     data values directly into integer color indices.
C   - The index array is passed to NDP_IMAGE_PLOT, which calls PGPIXL to
C     plot the image. At first nothing is seen because the GKS colour
C     indices are all initialized with black. 
C   - The small lookup table is progressively cycled through the colour 
C     indices. As it moves to higher indices it is replaced by black. The 
C     effect on the image is to illuminate the pixels in a small part of the
C     data range for a brief time, and then to move on slightly in the data 
C     range and repeat the process.
C   - As the pixels are highlighted on the image device, their data values 
C     are output to the alphanumeric device. This enables the display to be 
C     paused and restarted with CTRL-S and CTRL-Q. The data value shown is
C     approximate, being the middle of the data interval mapped on to the 
C     current colour index.
C
C
C   External functions & subroutines called
C   ---------------------------------------
C   Library DSA:
C     DSA_CLOSE                     
C     DSA_DATA_SIZE
C     DSA_GET_WORKSPACE
C     DSA_INPUT
C     DSA_MAP_DATA
C     DSA_MAP_QUALITY
C     DSA_OPEN
C     DSA_SEEK_QUALITY
C     DSA_TYPESIZE
C     DSA_USE_FLAGGED_VALUES
C     DSA_WRUSER
C
C   Library DYN:
C     DYN_ELEMENT
C
C   Library GEN:
C     GEN_MOVE
C
C   Library ICH:
C     ICH_ENCODE
C     ICH_LEN
C
C   Library NDP:
C     NDP_AXIS_RANGE
C     NDP_DEVICE_INDEX
C     NDP_GET_IMAGE_INFO
C     NDP_IMAGE_INDEX
C     NDP_IMAGE_PLOT
C     NDP_IMAGE_VIEWPORT
C     NDP_REPLACE_QUAL_R
C
C   Library PAR:
C     PAR_RDCHAR
C     PAR_RDKEY
C     PAR_RDVAL
C     
C   Library VAR:
C     VAR_GETCHR
C
C   Starlink PGPLOT:
C     PGBEGIN
C     PGEND
C     PGMTEXT
C     PGSCH
C     PGSCI
C     PGSCR
C
C   Internal subroutines called
C   ---------------------------
C   None.
C
C
C   INCLUDE statements
C   ------------------
C   INCLUDE 'DYN_SOURCE:DYNAMIC_MEMORY.INC'
C   INCLUDE 'NDP_SOURCE:NDP_NUMERIC_RANGES.INC'
C   INCLUDE 'NDP_SOURCE:NDP_MAGIC_VALUES.INC'                  
C                                             
C
C   Extensions to FORTRAN77
C   -----------------------                           
C   END DO / IMPLICIT NONE / INCLUDE / Names > 6 characters
C
C                        
C   Possible future upgrades
C   ------------------------
C
C
C   Author/s
C   --------
C   Nick Fuller  RGO  (RGVAD::NMJF or NMJF@UK.AC.RGO.STAR)
C   Jim Lewis    RGO  (CAVAD::JRL or JRL@UK.AC.CAM.AST-STAR)
C   Julian Gold  RGO  (CAVAD::GOLDJIL or GOLDJIL@UK.AC.CAM.AST-STAR)
C
C
C   History
C   -------
C   01-FEB-1989   - Original program
C   14-JUN-1990   - Parameters in call to NDP_IMAGE_PLOT changed.  (JRL)
C   17-SEP-1990   - No longer replaces magic values with zeros.  This assumes 
C                   that the data is always going to be greater than zero which 
C                   in certain cases (e.g. a velocity map) it may not be.  
C                   They are now replaced by a value which is below the lower
C                   threshold requested for the plot and/or the contour map.  
C                   The magic values are now also replaced only in a direct 
C                   copy of the original file.  This is because if the data 
C                   are mapped directly, then any changes will be copied to the
C                   disk, even if it is mapped READ.  The data pointer for 
C                   non-FLOAT data which has been mapped FLOAT (e.g. type 
C                   converted) will be the pointer for a workspace anyway, 
C                   so the copying only has to be done for FLOAT data which 
C                   has been mapped FLOAT.  (JRL)
C   15-OCT-1991   - Quality arrays implemented. (GOLDJIL)
C   02-MAR-1992   - Removed GKS stuff and PGPLOT common block references. 
C                   Added NDP_IMAGE_INDEX call. (GOLDJIL)
C   24-NOV-1992   - Unix version. (GOLDJIL)
C   02-OCT-1994   - Removed variable c0 since it was being used before
C                   being defined. Have now defined the colour blue
C                   to be red(i) - should generate shades of grey. (GJP)
C   06-OCT-1994   - Removed unused variables. (GJP)
C
1 logic1
  Bitwise logical combination of an INTEGER*2 image or image subset
  with a scalar.
2 IMAGE
   NAME    IM(AGE)
   TYPE    FILE
   OPTIONS INPUT
   PROMPT  "(IMage) Name of input image"
   TEXT    ----------------------------------------------------------------
           IMAGE is the name of the structure containing the image to be 
           arithmetically combined with a scalar. The image may have from
           one to six dimensions.
           ----------------------------------------------------------------
2 WHOLE
   NAME    WH(OLE)
   TYPE    KEY                                               
   PROMPT  "(WHole) Process the whole image?"
   TEXT    ----------------------------------------------------------------
           If WHOLE is specified, the entire area of the image will be 
           processed. Otherwise, a subset of the image may be selected.
           ----------------------------------------------------------------
2 START
   NAME    ST(ART)
   TYPE    FLOAT[6]
   PROMPT  "(STart) Start coordinates of subset."
   TEXT    ----------------------------------------------------------------
           START is an array containing the start coordinate of the subset
           to be processed in each dimension of the image. The first array
           element is the start coordinate in the first dimension of the 
           current sort order (usually X). Each coordinate must be given 
           in axis units if the relevant axis is calibrated, or in pixels 
           if it is not calibrated or the axis structure is not present.  
           ----------------------------------------------------------------
2 END
   NAME    EN(D)
   TYPE    FLOAT[6]
   PROMPT  "(ENd) End coordinates of subset."
   TEXT    ----------------------------------------------------------------
           END is an array containing the end coordinate of the subset
           to be processed in each dimension of the image. The first array
           element is the end coordinate in the first dimension of the 
           current sort order (usually X). Each coordinate must be given 
           in axis units if the relevant axis is calibrated, or in pixels 
           if it is not calibrated or the axis structure is not present.  
           ----------------------------------------------------------------
2 OPER
   NAME    OP(ER)
   TYPE    CHAR
   PROMPT  "(OPer) AND,OR,XOR,NAND,NOR,NXOR"
   TEXT   
           ---------------------------------------------------------------
           Choose one of the bitwise logical operations to perform on
           the image and the scalar:
           AND  :  1 AND 1 = 1, 1 AND 0 = 0, 0 AND 1 = 0, 0 AND 0 = 0
           OR   :  1 OR 1 = 1, 1 OR 0 = 1, 0 OR 1 = 1, 0 OR 0 = 0
           XOR  :  1 XOR 1 = 0, 1 XOR 0 = 1, 0 XOR 1 = 1, 0 XOR 0 = 0
           NAND :  A NAND B = A AND (NOT B)
           NOR  :  A NOR B = A OR (NOT B)
           NXOR :  A NXOR B = A XOR (NOT B)
           ---------------------------------------------------------------
2 VALUE
   NAME    VAL(UE)
   TYPE    FLOAT
   PROMPT  "(VALue) Scalar or power value"
   TEXT    ----------------------------------------------------------------
           Every pixel of the image will be combined with this value.
           ----------------------------------------------------------------
2 OUTPUT
   NAME    OUT(PUT)
   TYPE    FILE
   OPTIONS OUTPUT
   PROMPT  "(OUTput) Name of output image"
   TEXT    ----------------------------------------------------------------
           OUTPUT is the name of the structure which will contain the
           output image. If OUTPUT already exists, a new version will be 
           created. If OUTPUT is the same as IMAGE, a new version of IMAGE
           will be created.
           ----------------------------------------------------------------
2 ERR_ACT
   NAME    ERR_ACT
   TYPE    CHAR
   PROMPT  "(ERR_ACT) (R)eplace void values or (L)eave"
   TEXT    ---------------------------------------------------------------
           When an operation inserts a new value for a pixel in the image,
           the error associated with that pixel is then undefined (void).
           Responding R will replace void  values with a constant of your
           choice. L or any other character will leave the error array 
           unchanged.
           ---------------------------------------------------------------
2 ERR_VAL
   NAME    ERR_VAL
   TYPE    FLOAT
   PROMPT  "(ERR_VAL) Value to replace void errors with"
   TEXT    ---------------------------------------------------------------
           When an operation inserts a new value for a pixel in the image,
           the error associated with that pixel is then undefined (void).
           Enter the value you wish to replace void errors with.
           ---------------------------------------------------------------
2 SOURCE_COMMENTS
C+
C
C   ---------
C   C O M B 1
C   ---------
C
C   Description
C   -----------
C   This routine services the following commands:
C
C     ARITH1 - Arithmetic operations between an image and a scalar. The 
C              operations supported are: +, -, *, /, **.
C
C     LOGIC1 - Bitwise logical operations between an image and a scalar. The
C              operations supported are: AND, OR, XOR, NAND, NOR, NXOR.
C
C     MASK1  - Masking operations between an image and a scalar. The 
C              operations supported are: MAX, MIN, replace where IMAGE is 
C              non-magic (or good quality), replace where IMAGE is magic
C              (or bad quality).
C
C
C   Scope of program
C   ----------------
C   - Images of up to six dimensions accepted.
C   - Data array types SHORT and FLOAT supported; others converted to FLOAT.
C     (bitwise logical operations accept SHORT array type only).
C   - Subsetting supported.
C   - Magic values supported.
C   - Quality and error arrays supported.
C   - Batch execution supported.
C
C
C   Environment
C   -----------
C   FIGARO
C
C                                               
C   Parameters (read or written)
C   ----------------------------
C   IMAGE    Name of the structure containing the input image. (character)
C            (prompted for).
C
C   START    Coordinate in each dimension of IMAGE at which the operation is
C            to start. (real, array)(prompted for).
C
C   END      Coordinate in each dimension of IMAGE at which the operation is
C            to end. (real, array)(prompted for).
C
C   OPER     Operation to be performed. (character)(prompted for).
C
C   VALUE    Scalar to be combined with IMAGE. (real)(prompted for).
C
C   OUTPUT   Name of the structure containing the output image. May be the 
C            same as IMAGE. (character)(prompted for).     
C
C   ERR_ACT  Action to be taken with a void error array (character,prompted)
C
C   ERR_VAL  Value to replace void errors with (real, prompted)
C
C
C   Keywords
C   --------
C   WHOLE    Instructs the program to operate on the whole image. Otherwise,
C            a subset of the image may be selected.
C
C
C   Propagation of data structure
C   -----------------------------
C   - Principal structure is IMAGE.
C   - All standard objects are copied from IMAGE.
C   - Data array is modified.
C
C
C   Method
C   ------
C   - The IMAGE structure is tested for the bad data flag. If it is found 
C     and non-zero, magic values are assumed to be present and are left in
C     the data.
C   - The structure IMAGE is copied to OUTPUT.
C   - A subroutine appropriate to the required operation, the data type,
C     and the presence or absence of magic values is called to operate on
C     the OUTPUT data array.
C
C   Note
C   ----
C
C     Lines commented with 'C*' indicate the current non-compatibility
C     of quality arrays and magic values, and have been included for
C     forward compatibilty.
C
C   External functions & subroutines called
C   ---------------------------------------
C   Library DSA:
C      DSA_CLOSE
C      DSA_DATA_SIZE
C      DSA_INPUT
C      DSA_MAP_DATA
C      DSA_MAP_ERRORS
C      DSA_MAP_QUALITY
C      DSA_OPEN          
C      DSA_OUTPUT
C      DSA_USE_FLAGGED_VALUES
C      DSA_WRUSER
C
C   Library DYN:
C      DYN_ELEMENT
C
C   Library ICH:
C      ICH_FOLD
C      ICH_LEN
C
C   Library NDP:
C      NDP_AXIS_RANGE
C      NDP_GET_IMAGE_INFO
C      NDP_SET_BAD_PIXEL
C
C   Library PAR:
C      PAR_COMMAND
C      PAR_RDCHAR
C      PAR_RDVAL
C
C
C   Internal subroutines called
C   ---------------------------
C   COMB1_AC_W
C   COMB1_AC_WQ
C   COMB1_AC_R
C   COMB1_AC_RQ
C   COMB1_B_W
C   COMB1_B_WQ
C   REPLACE_ERRORS_R
C   REPLACE_ERRORS_W
C      
C
C   INCLUDE statements
C   ------------------
C   INCLUDE 'DYN_SOURCE:DYNAMIC_MEMORY.INC'
C   INCLUDE 'NDP_SOURCE:NDP_MAGIC_VALUES.INC'
C   INCLUDE 'NDP_SOURCE:NDP_NUMERIC_RANGES.INC'
C   INCLUDE 'NDP_SOURCE:NDP_QUALITY_MASK.INC'
C   INCLUDE 'DCV_FUN'
C
C
C   Extensions to FORTRAN 77
C   ------------------------
C   END DO / IMPLICIT NONE / INCLUDE / Names > 6 characters
C
C
C   Possible future upgrades
C   ------------------------
C   - Allow a fractional offset between images before combination, with 
C     linear interpolation of pixel values.
C
C
C   Author/s
C   --------
C   Nick Fuller  RGO  (RGVAD::NMJF or NMJF@UK.AC.RGO.STAR)
C   Chris Benn  RGO  (RGVAD::CRB or CRB@UK.AC.RGO.STAR)
C   Julian Gold RGO (CAVAD::GOLDJIL or GOLDJIL@UK.AC.CAM.AST-STAR)
C
C
C   History
C   -------
C   01-FEB-1989  - Original program
C   12-JLY-1991  - Quality and error arrays implemented, with new options:
C                  REP1 replace data when quality is good
C                  REP4 replace data when quality is bad
C                  (only applicable when quality arrays exist). (GOLDJIL)
C   20-AUG-1991  - Why oh why did the author compare COMMAND with 'ACOMB1'
C                  etc when the command names are 'LOGIC1' etc ? Fixed now.
C                  Sigh...
C   30-NOV-1992  - Unix version. Changed REP1 to REPG, REP4 to REPB which
C                  are a tad less cryptic. (GOLDJIL)
C   06-OCT-1994  - Removed a Trojan Horse message. Also ensured that an
C                  infinite loop does not occur when an improper operation is
C                  requested. Removed unused variables. (GJP)
C   13-OCT-1994  - Modified code to avoid an eternal loop
C                  when attempting to divide by zero in ARITH1. (GJP)
C
C
C
1 logic2
  Bitwise logical combination of two INTEGER*2 images.
2 IMAGE
   NAME    IM(AGE)
   TYPE    FILE
   OPTIONS INPUT
   PROMPT  "(IMage) Name of first input image"
   TEXT    ----------------------------------------------------------------
           IMAGE is the name of the structure containing the image to be 
           arithmetically combined with a second image. The image may have
           from one to six dimensions. The dimensions of the output image
           will be the same as those of the first input image.
           ----------------------------------------------------------------
2 IMAGE1
   NAME    IMAGE1
   TYPE    FILE
   OPTIONS INPUT
   PROMPT  "(IMAGE1) Name of second input image"
   TEXT    ----------------------------------------------------------------
           IMAGE1 is the name of the structure containing the second image.
           The image may have from one to six dimensions.
           ----------------------------------------------------------------
2 WHOLE
   NAME    WH(OLE)
   TYPE    KEY                                               
   PROMPT  "(WHole) Process the whole of the first image?"
   TEXT    ----------------------------------------------------------------
           If WHOLE is specified, the entire area of IMAGE will be 
           processed. Otherwise, a subset of the image may be selected.
           ----------------------------------------------------------------
2 START
   NAME    ST(ART)
   TYPE    FLOAT[6]
   PROMPT  "(STart) Start coordinates of subset."
   TEXT    ----------------------------------------------------------------
           START is an array containing the start coordinate of the subset
           to be processed in each dimension of IMAGE. The first array
           element is the start coordinate in the first dimension of the 
           current sort order (usually X). Each coordinate must be given 
           in axis units if the relevant axis is calibrated, or in pixels 
           if it is not calibrated or the axis structure is not present.  
           ----------------------------------------------------------------
2 END
   NAME    EN(D)
   TYPE    FLOAT[6]
   PROMPT  "(ENd) End coordinates of subset."
   TEXT    ----------------------------------------------------------------
           END is an array containing the end coordinate of the subset
           to be processed in each dimension of IMAGE. The first array
           element is the end coordinate in the first dimension of the 
           current sort order (usually X). Each coordinate must be given 
           in axis units if the relevant axis is calibrated, or in pixels 
           if it is not calibrated or the axis structure is not present.  
           ----------------------------------------------------------------
2 OPER
   NAME    OP(ER)
   TYPE    CHAR
   PROMPT  "(OPer) AND,OR,XOR,NAND,NOR,NXOR"
   TEXT    ----------------------------------------------------------------
           Choose one of the bitwise logical operations to perform on
           the images:
           AND  :  1 AND 1 = 1, 1 AND 0 = 0, 0 AND 1 = 0, 0 AND 0 = 0
           OR   :  1 OR 1 = 1, 1 OR 0 = 1, 0 OR 1 = 1, 0 OR 0 = 0
           XOR  :  1 XOR 1 = 0, 1 XOR 0 = 1, 0 XOR 1 = 1, 0 XOR 0 = 0
           NAND :  A NAND B = A AND (NOT B)
           NOR  :  A NOR B = A OR (NOT B)
           NXOR :  A NXOR B = A XOR (NOT B)
           ----------------------------------------------------------------
2 OUTPUT
   NAME    OUT(PUT)
   TYPE    FILE
   OPTIONS OUTPUT
   PROMPT  "(OUTput) Name of output image"
   TEXT    ----------------------------------------------------------------
           OUTPUT is the name of the structure which will contain the
           output image. It will have the same dimensions as IMAGE. If 
           OUTPUT already exists, a new version will be created. If OUTPUT
           is the same as IMAGE or IMAGE1, a new version of IMAGE or 
           IMAGE1 will be created.
           ----------------------------------------------------------------
2 ERR_ACT
   NAME    ERR_ACT
   TYPE    CHAR
   PROMPT  "(ERR_ACT) (R)eplace void values or (L)eave"
   TEXT    ---------------------------------------------------------------
           When an operation inserts a new value for a pixel in the image,
           the error associated with that pixel is then undefined (void).
           Responding R will replace void values with a constant of your 
           choice. L or any other character will leave the error array 
           unchanged.
           ---------------------------------------------------------------
2 ERR_VAL
   NAME    ERR_VAL
   TYPE    FLOAT
   PROMPT  "(ERR_VAL) Value to replace void errors with"
   TEXT    ---------------------------------------------------------------
           When an operation inserts a new value for a pixel in the image,
           the error associated with that pixel is then undefined (void).
           Enter the value you wish to replace void errors with.
           ---------------------------------------------------------------
2 SOURCE_COMMENTS
C+
C
C   ---------
C   C O M B 2
C   ---------
C
C   Description
C   -----------
C   This routine services the following commands:
C
C     ARITH2 - Arithmetic operations between two images. The operations 
C              supported are: +, -, *, /, **.
C
C     LOGIC2 - Bitwise logical operations between two images. The operations
C              supported are: AND, OR, XOR, NAND, NOR, NXOR.
C
C     MASK2  - Masking operations between two images. The operations 
C              supported are: MAX, MIN, replace where IMAGE is non-magic, 
C              replace where IMAGE1 is non-magic, replace where IMAGE and 
C              IMAGE1 are both non-magic, replace where IMAGE is magic.
C              (Read bad quality for magic if quality data is present)
C
C   If the input images have different dimensionalities, the one with the 
C   larger number of dimensions must be given first, as IMAGE. In such a
C   case the combination may be performed repeatedly, starting and ending at
C   given coordinates in the higher dimensions of IMAGE. For example a 2-D
C   IMAGE1 may be combined with several consecutive planes of a 3-D IMAGE.
C
C   The axes of IMAGE1 are aligned with the corresponding axes of IMAGE,
C   i.e. a 1-D IMAGE1 is always combined with the X rows of IMAGE. This is
C   the most efficient way to operate on arrays, producing the lowest number
C   of page faults. If it is required to combine a 1-D IMAGE1 with the Z 
C   rows of a 3-D IMAGE, the XYZ to ZXY transposition of IMAGE may be 
C   achieved by prior use of TRANSPOSE. 
C
C   The output structure will be a copy of the FIRST input structure.
C
C
C   Scope of program
C   ----------------
C   - Images of up to six dimensions accepted.
C   - Data array types SHORT and FLOAT supported; others converted to FLOAT.
C     (bitwise logical operations accept SHORT array type only).
C   - Subsetting supported.
C   - Magic values supported.
C   - Quality and error arrays supported.
C   - Batch execution supported.
C
C
C   Environment
C   -----------
C   FIGARO
C
C                                               
C   Parameters (read or written)
C   ----------------------------
C   IMAGE    Name of the structure containing the first image. (character)
C            (prompted for).
C
C   IMAGE1   Name of the structure containing the second image. (character)
C            (prompted for).  
C
C   START    Coordinate in each dimension of IMAGE at which the operation is
C            to start. (real, array)(prompted for).
C
C   END      Coordinate in each dimension of IMAGE at which the operation is
C            to end. (real, array)(prompted for).
C
C   OPER     Operation to be performed. (character)(prompted for).
C
C   OUTPUT   Name of the structure containing the output image. May be the 
C            same as IMAGE. (character)(prompted for).     
C
C
C   Keywords
C   --------
C   WHOLE    Instructs the program to operate on the whole image. Otherwise,
C            a subset of the image may be selected.
C
C
C   Propagation of data structure
C   -----------------------------
C   - Principal structure is IMAGE.
C   - All standard objects are copied from IMAGE.
C   - Data array is modified.
C
C
C   Method
C   ------
C   - The IMAGE and IMAGE1 structures are tested for the bad data flag. If 
C     either is found and non-zero, magic values are assumed to be present
C     and are left in the data.
C   - A subset of IMAGE is optionally selected by specifying the start and 
C     end coordinates in each dimension. If IMAGE has more dimensions than 
C     IMAGE1, the required start and end coordinates in each of the higher 
C     dimensions are also prompted for. For example, if it is required to 
C     combine a 2-D IMAGE1 with a 3-D IMAGE, the start and end pixels in the
C     third dimension of IMAGE control which XY planes of IMAGE are combined
C     with IMAGE1.         
C   - The structure IMAGE is copied to OUTPUT. If the data array of either 
C     IMAGE or IMAGE1 is of type FLOAT, then both IMAGE and IMAGE1 are 
C     mapped as FLOAT.
C   - Error and quality arrays are mapped as appropriate.
C   - A subroutine appropriate to the required operation, the data type, and
C     the presence or absence of magic values is called to operate on the
C     IMAGE1 and OUTPUT data arrays.
C
C
C   External functions & subroutines called
C   ---------------------------------------
C   Library DSA:
C      DSA_AXIS_RANGE
C      DSA_CLOSE
C      DSA_DATA_SIZE
C      DSA_INPUT
C      DSA_MAP_DATA
C      DSA_MAP_ERRORS
C      DSA_MAP_QUALITY
C      DSA_OPEN          
C      DSA_OUTPUT
C      DSA_USE_FLAGGED_VALUES
C      DSA_WRUSER
C
C   Library DYN:
C      DYN_ELEMENT
C
C   Library ICH:
C      ICH_ENCODE
C      ICH_FOLD
C      ICH_LEN
C
C   Library NDP:
C      NDP_ERROR_ARITH_R
C      NDP_ERROR_ARITH_W
C      NDP_GET_IMAGE_INFO
C      NDP_PAR_RDARY
C      NDP_SET_BAD_PIXEL
C
C   Library PAR:
C      PAR_COMMAND
C      PAR_RDCHAR
C      PAR_RDVAL
C
C
C   Internal subroutines called
C   ---------------------------
C   COMB2_AC_W
C   COMB2_AC_WQ
C   COMB2_AC_R
C   COMB2_AC_RQ
C   COMB2_B_W
C   COMB2_B_WQ
C   REPLACE_ERRORS_R
C   REPLACE_ERRORS_W
C      
C
C   INCLUDE statements
C   ------------------
C   INCLUDE 'DYN_SOURCE:DYNAMIC_MEMORY.INC'
C   INCLUDE 'NDP_SOURCE:NDP_MAGIC_VALUES.INC'
C   INCLUDE 'NDP_SOURCE:NDP_NUMERIC_RANGES.INC'
C   INCLUDE 'DCV_FUN'
C
C
C   Extensions to FORTRAN 77
C   ------------------------
C   END DO / IMPLICIT NONE / INCLUDE / Names > 6 characters
C
C
C   Possible future upgrades
C   ------------------------
C   - Allow a fractional offset between images before combination, with 
C     linear interpolation of pixel values.
C   - Purging of the error array when void values are present. At present,
C     this would require use of DSA common block data and routines in the
C     NON-shareable DSA library. Hint, hint, Keith?
C
C   Author/s
C   --------
C   Nick Fuller  RGO  (RGVAD::NMJF or NMJF@UK.AC.RGO.STAR)
C   Julian Gold  RGO  (CAVAD::GOLDJIL or GOLDJIL@UK.AC.CAM.AST-STAR)
C
C
C   History
C   -------
C   01-FEB-1989   - Original program
C   29-AUG-1990   - Bug which sometimes caused the output file to be mapped 
C                   as the wrong type was fixed.  A few typos were also
C                   corrected.  (JRL)
C   10-AUG-1991   - Quality and error handling implemented (GOLDJIL)
C   16-SEP-1991   - Bug which led to erroneous output if IMAGE 
C                   contained SHORT data and IMAGE1 FLOAT data fixed.
C                   (GOLDJIL)
C   30-NOV-1992   - Unix version (GOLDJIL).
C   06-OCT-1994   - Removed a Trojan Horse message. Also ensured that an
C                   infinite loop does not occur when an improper operation is
C                   requested. Removed unused variables. (GJP)
C
1 look
  Displays the pixel values in a 2-D image or an image subset.
2 IMAGE
   NAME    IM(AGE)
   TYPE    FILE
   OPTIONS INPUT
   PROMPT  "(IMage) Name of image to be displayed"
   TEXT    ----------------------------------------------------------------
           IMAGE is the name of the structure containing the image whose 
           values will be displayed. The image must be 2-D.
           ----------------------------------------------------------------
2 STAPIX
   NAME    STAPIX
   TYPE    INT[6]
   PROMPT  "(STAPIX) Start pixel of subset."
   TEXT    ----------------------------------------------------------------
           STAPIX is an array containing the start pixel number to be 
           displayed in each dimension of the image. The first array 
           element is the start pixel in the first dimension of the 
           current sort order (usually X).
           ----------------------------------------------------------------
2 ENDPIX
   NAME    ENDPIX
   TYPE    INT[6]
   PROMPT  "(ENDPIX) End pixel of subset."
   TEXT    ----------------------------------------------------------------
           ENDPIX is an array containing the end pixel number to be 
           displayed in each dimension of the image. The first array 
           element is the end pixel in the first dimension of the 
           current sort order (usually X). Only one or two elements of 
           ENDPIX may differ from the corresponding elements of STAPIX.
           ----------------------------------------------------------------
2 AGAIN
   NAME    AGAIN
   TYPE    KEY
   PROMPT  "(AGAIN) Look at another subset?"
   TEXT    ----------------------------------------------------------------
           If AGAIN is specified, another set of start and end pixels may 
           be entered. Otherwise, the program finishes. 
           ----------------------------------------------------------------
2 SOURCE_COMMENTS
C+
C
C   -------
C   L O O K 
C   -------
C
C   Description
C   -----------
C   Displays pixel values of a 2-D image or image subset.
C
C
C   Scope of program
C   ----------------
C   - Only 2-D images accepted.
C   - Data array types SHORT and FLOAT supported; others converted to FLOAT.
C   - Subsetting supported.
C   - Magic values supported.
C   - Variance arrays not supported.
C   - Batch execution supported.
C
C
C   Environment
C   -----------
C   FIGARO
C
C
C   Parameters (read or written)
C   ----------------------------
C   IMAGE   Name of the structure containing the image. (character)
C           (prompted for).
C
C   STAPIX  Start pixel in each dimension of the subset to be inspected. 
C          (real, array)(prompted for).
C
C   ENDPIX  End pixel in each dimension of the subset to be inspected. 
C           (real, array)(prompted for).
C
C
C   Keywords
C   --------
C   AGAIN   Instruction to display another subset.
C
C
C   Propagation of data structure
C   -----------------------------
C   Not relevant.
C
C
C   Method
C   ------
C   - The IMAGE structure is tested for the bad pixel flag. If it is found 
C     and non-zero, magic values are assumed to be present and are left in 
C     the data.
C   - The minimum and maximum values in the selected image subset are 
C     obtained by calling the appropriate NDP_STATS routine. These are used
C     to determine the maximum string length required to write out a data 
C     value.
C   - A subroutine appropriate to the data type is called to display the 
C     data values. Dimension 2 of the array is accessed in reverse so that
C     the display appears with the correct orientation.
C
C
C   External functions & subroutines called
C   ---------------------------------------
C   Library DSA:
C      DSA_CLOSE
C      DSA_DATA_SIZE
C      DSA_INPUT
C      DSA_MAP_DATA
C      DSA_MAP_QUALITY
C      DSA_OPEN
C      DSA_OUTPUT
C      DSA_SEEK_QUALITY
C      DSA_USE_FLAGGED_VALUES
C      DSA_WRUSER
C
C   Library DYN:
C      DYN_ELEMENT
C
C   Library ICH:
C      ICH_ENCODE
C
C   Library PAR:
C      PAR_CNPAR
C      PAR_RDARY
C      PAR_RDCHAR
C      PAR_RDKEY
C      PAR_WRUSER
C
C   Library NDP:
C      NDP_GET_IMAGE_INFO
C      NDP_PAR_RDARY
C      NDP_STATS_W
C      NDP_STATS_WQ
C      NDP_STATS_R
C      NDP_STATS_RQ
C
C
C   Internal subroutines called
C   ---------------------------
C   LOOK_DATA_W
C   LOOK_DATA_WQ
C   LOOK_DATA_R
C   LOOK_DATA_RQ
C
C
C   INCLUDE statements
C   ------------------
C   INCLUDE 'DYN_SOURCE:DYNAMIC_MEMORY.INC'
C   INCLUDE 'NDP_SOURCE:NDP_MAGIC_VALUES.INC'
C   INCLUDE 'NDP_SOURCE:NDP_NUMERIC_RANGES.INC'
C   INCLUDE 'DCV_FUN'
C
C
C   Extensions to FORTRAN 77
C   ------------------------
C   DO WHILE / END DO / IMPLICIT NONE / INCLUDE / Names > 6 characters
C                       
C
C   Possible future upgrades
C   ------------------------
C   - Input the number of decimal places to be displayed. At present this is
C     hard-coded as 1.
C
C
C   Author/s
C   --------
C   Nick Fuller  RGO  (RGVAD::NMJF or NMJF@UK.AC.RGO.STAR)
C   Peter Allan  Manchester (MAVAD::PMA)
C   Julian Gold  RGO (CAVAD::GOLDJIL or GOLDJIL@UK.AC.CAM.AST-STAR)
C
C   History
C   -------
C   01-FEB-1989  - Original program
C   22-JUL-1990   - Modified to pass the sizes of adjustable arrays to 
C                   subroutines as individual variables rather than as
C                   elements of arrays. This change was made necessary by
C                   the VAX Fortran 5.2 compiler. (PMA)
C   07-OCT-1991   - Processing of quality arrays added (GOLDJIL)
C   08-OCT-1991   - String buffer increased in size in LOOK_DATA_<T>
C                   to avoid string overflow (GOLDJIL)
C   02-DEC-1992   - Unix version (GOLDJIL)
C   06-OCT-1994   - Removed unused variables. (GJP)
C
1 magic
  Replaces pixels of an image or image subset which are outside a
  specified range with the magic value. Sets the bad pixel flag.
2 IMAGE
   NAME    IM(AGE)
   TYPE    FILE
   OPTIONS INPUT
   PROMPT  "(IMage) Name of input image"
   TEXT    ----------------------------------------------------------------
           IMAGE is the name of the structure containing the image in 
           which all pixels with values outside a specified range will be 
           replaced with the magic value. The image may have from one to 
           six dimensions.
           ----------------------------------------------------------------
2 WHOLE
   NAME    WH(OLE)
   TYPE    KEY                                               
   PROMPT  "(WHole) Process the whole image?"
   TEXT    ----------------------------------------------------------------
           If WHOLE is specified, the entire area of the image will be 
           processed. Otherwise, a subset of the image may be selected.
           ----------------------------------------------------------------
2 START
   NAME    ST(ART)
   TYPE    FLOAT[6]
   PROMPT  "(STart) Start coordinates of subset."
   TEXT    ----------------------------------------------------------------
           START is an array containing the start coordinate of the subset
           to be processed in each dimension of the image. The first array
           element is the start coordinate in the first dimension of the 
           current sort order (usually X). Each coordinate must be given 
           in axis units if the relevant axis is calibrated, or in pixels 
           if it is not calibrated or the axis structure is not present.  
           ----------------------------------------------------------------
2 END
   NAME    EN(D)
   TYPE    FLOAT[6]
   PROMPT  "(ENd) End coordinates of subset."
   TEXT    ----------------------------------------------------------------
           END is an array containing the end coordinate of the subset
           to be processed in each dimension of the image. The first array
           element is the end coordinate in the first dimension of the 
           current sort order (usually X). Each coordinate must be given 
           in axis units if the relevant axis is calibrated, or in pixels 
           if it is not calibrated or the axis structure is not present.  
           ----------------------------------------------------------------
2 LOW
   NAME    LO(W)
   TYPE    FLOAT
   PROMPT  "(LOw) Lowest value to be kept"
   TEXT    ----------------------------------------------------------------
           LOW is the lowest value of the range outside which pixel values
           will be replaced with the magic value.
           ----------------------------------------------------------------
2 HIGH
   NAME    HI(GH)
   TYPE    FLOAT
   PROMPT  "(HIgh) Highest value to be kept"
   TEXT    ----------------------------------------------------------------
           HIGH is the highest value of the range outside which pixel
           values will be replaced with the magic value.
           ----------------------------------------------------------------
2 OUTPUT
   NAME    OUT(PUT)
   TYPE    FILE
   OPTIONS OUTPUT
   PROMPT  "(OUTput) Name of output image"
   TEXT    ----------------------------------------------------------------
           OUTPUT is the name of the structure which will contain the
           output image. If OUTPUT already exists, a new version will be 
           created. If OUTPUT is the same as IMAGE, a new version of IMAGE
           will be created.
           ----------------------------------------------------------------
2 SOURCE_COMMENTS
C+
C
C   ---------
C   M A G I C
C   ---------
C
C   Description
C   -----------
C   Replaces all pixels in an image or an image subset, whose values lie 
C   outside a specified range, with the magic value or if a quality
C   array is present, flags bad quality.
C
C
C   Scope of program
C   ----------------
C   - Images of up to six dimensions accepted.
C   - Data array types SHORT and FLOAT supported; others converted to FLOAT.
C   - Subsetting supported.
C   - Magic values supported.
C   - Variance arrays not supported.
C   - Quality arrays supported
C   - Batch execution supported.
C
C
C   Environment
C   -----------
C   FIGARO
C
C
C   Parameters (read or written)
C   ----------------------------
C   IMAGE   Name of the structure containing the image to be inspected
C           (character)(prompted for).
C
C   START   Coordinate in each dimension of IMAGE at which the edit
C           operation is to start (real, array)(prompted for).
C
C   END     Coordinate in each dimension of IMAGE at which the edit
C           operation is to end (real, array)(prompted for).
C
C   LOW     Lowest value of range outside which pixel values will be
C           replaced with the magic value (real)(prompted for).
C
C   HIGH    Highest value of range outside which pixel values will be
C           replaced with the magic value (real)(prompted for).
C
C   OUTPUT  Name of the structure containing the output image. May be the 
C           same as IMAGE (character)(prompted for).
C
C   Keywords
C   --------
C   WHOLE   Instructs the program to edit the whole image. Otherwise, a
C           subset of the image may be selected.
C
C
C   Propagation of data structure
C   -----------------------------
C   - All standard objects are copied from IMAGE.
C   - Data array is modified.
C
C
C   Method
C   ------
C   - The IMAGE structure is tested for the bad data flag. If it is found
C     and non-zero, magic values are assumed to be present and are left in 
C     the data.
C   - The IMAGE structure is copied to OUTPUT.
C   - A subroutine appropriate to the data type and the presence or absence
C     of magic values is called to edit the OUTPUT data array.
C   - The OUTPUT bad data flag is set if any pixels were changed to the 
C     magic value.
C
C
C   External functions & subroutines called
C   ---------------------------------------
C   Library DSA:
C     DSA_CLOSE
C     DSA_DATA_SIZE
C     DSA_GET_RANGE
C     DSA_INPUT
C     DSA_MAP_DATA
C     DSA_MAP_QUALITY
C     DSA_OPEN
C     DSA_OUTPUT
C     DSA_SEEK_QUALITY
C     DSA_SEEK_RANGE
C     DSA_USE_FLAGGED_VALUES
C     DSA_WRUSER
C
C   Library DYN:
C     DYN_ELEMENT
C
C   Library ICH:
C     ICH_ENCODE
C     ICH_LEN
C
C   Library NDP:
C     NDP_AXIS_RANGE
C     NDP_DISPLAY_PROGRESS
C     NDP_GET_IMAGE_INFO
C     NDP_SET_BAD_PIXEL
C
C
C   Internal subroutines called
C   ---------------------------
C   MAGIC_DATA_W
C   MAGIC_DATA_WQ
C   MAGIC_DATA_R
C   MAGIC_DATA_RQ
C
C
C   INCLUDE statements
C   ------------------
C   INCLUDE 'DYN_SOURCE:DYNAMIC_MEMORY.INC'
C   INCLUDE 'NDP_SOURCE:NDP_MAGIC_VALUES.INC'
C   INCLUDE 'NDP_SOURCE:NDP_NUMERIC_RANGES.INC'
C                                             
C
C   Extensions to FORTRAN77
C   -----------------------
C   IMPLICIT NONE / INCLUDE / Names > 6 characters
C
C
C   Possible future upgrades
C   ------------------------
C
C
C   Author/s
C   --------
C   Nick Fuller  RGO  (RGVAD::NMJF or NMJF@UK.AC.RGO.STAR)
C   Jim Lewis    RGO  (CAVAD::JRL or JRL@UK.AC.CAM.AST-STAR)
C   Julian Gold  RGO  (CAVAD::GOLDJIL or GOLDJIL@UK.AC.CAM.AST-STAR)
C
C
C   History
C   -------
C   01-FEB-1988   - Original program
C   03-AUG-1990   - Fixed typo which kept the real/magic_value routine
C                   from ever being called.  (JRL)
C   12-DEC-1991   - Quality array processing added.
C                   Code re-written in GENERIC format. (GOLDJIL)
C   02-DEC-1992   - Unix version (GOLDJIL)
C   06-OCT-1994   - Removed lots of unused variables. (GJP)
C
C
1 mask1
  Masking of an image or image subset with a scalar (MAX, MIN, various
  replacements).
2 IMAGE
   NAME    IM(AGE)
   TYPE    FILE
   OPTIONS INPUT
   PROMPT  "(IMage) Name of input image"
   TEXT    ----------------------------------------------------------------
           IMAGE is the name of the structure containing the image to be 
           arithmetically combined with a scalar. The image may have from
           one to six dimensions.
           ----------------------------------------------------------------
2 WHOLE
   NAME    WH(OLE)
   TYPE    KEY                                               
   PROMPT  "(WHole) Process the whole image?"
   TEXT    ----------------------------------------------------------------
           If WHOLE is specified, the entire area of the image will be 
           processed. Otherwise, a subset of the image may be selected.
           ----------------------------------------------------------------
2 START
   NAME    ST(ART)
   TYPE    FLOAT[6]
   PROMPT  "(STart) Start coordinates of subset."
   TEXT    ----------------------------------------------------------------
           START is an array containing the start coordinate of the subset
           to be processed in each dimension of the image. The first array
           element is the start coordinate in the first dimension of the 
           current sort order (usually X). Each coordinate must be given 
           in axis units if the relevant axis is calibrated, or in pixels 
           if it is not calibrated or the axis structure is not present.  
           ----------------------------------------------------------------
2 END
   NAME    EN(D)
   TYPE    FLOAT[6]
   PROMPT  "(ENd) End coordinates of subset."
   TEXT    ----------------------------------------------------------------
           END is an array containing the end coordinate of the subset
           to be processed in each dimension of the image. The first array
           element is the end coordinate in the first dimension of the 
           current sort order (usually X). Each coordinate must be given 
           in axis units if the relevant axis is calibrated, or in pixels 
           if it is not calibrated or the axis structure is not present.  
           ----------------------------------------------------------------
2 VALUE
   NAME    VAL(UE)
   TYPE    FLOAT
   PROMPT  "(VALue) Scalar or power value"
   TEXT    ----------------------------------------------------------------
           Every pixel of the image will be combined with this value.
           ----------------------------------------------------------------
2 OPER
   NAME    OP(ER)
   TYPE    CHAR
   PROMPT  "(OPer) MAX, MIN, REP1, REP4"
   TEXT    ----------------------------------------------------------------
           Masking operations:
           MAX  - Pixel becomes maximum of current value or scalar
           MIN  - Pixel becomes minimum of current value and scalar
           REP1 - Replace pixel by scalar if pixel quality is good
           REP4 - Replace pixel by scalar if pixel quality us bad
           ----------------------------------------------------------------
2 OUTPUT
   NAME    OUT(PUT)
   TYPE    FILE
   OPTIONS OUTPUT
   PROMPT  "(OUTput) Name of output image"
   TEXT    ----------------------------------------------------------------
           OUTPUT is the name of the structure which will contain the
           output image. If OUTPUT already exists, a new version will be 
           created. If OUTPUT is the same as IMAGE, a new version of IMAGE
           will be created.
           ----------------------------------------------------------------
2 ERR_ACT
   NAME    ERR_ACT
   TYPE    CHAR
   PROMPT  "(ERR_ACT) (R)eplace void values or (L)eave"
   TEXT    ---------------------------------------------------------------
           When an operation inserts a new value for a pixel in the image,
           the error associated with that pixel is then undefined (void).
           Responding R will replace void  values with a constant of your
           choice. L or any other character will leave the error array 
           unchanged.
           ---------------------------------------------------------------
2 ERR_VAL
   NAME    ERR_VAL
   TYPE    FLOAT
   PROMPT  "(ERR_VAL) Value to replace void errors with"
   TEXT    ---------------------------------------------------------------
           When an operation inserts a new value for a pixel47:20ge,
           the error associated with that pixel is then undefined (void).
           Enter the value you wish to replace void errors with.
           ---------------------------------------------------------------
2 SOURCE_COMMENTS
C+
C
C   ---------
C   C O M B 1
C   ---------
C
C   Description
C   -----------
C   This routine services the following commands:
C
C     ARITH1 - Arithmetic operations between an image and a scalar. The 
C              operations supported are: +, -, *, /, **.
C
C     LOGIC1 - Bitwise logical operations between an image and a scalar. The
C              operations supported are: AND, OR, XOR, NAND, NOR, NXOR.
C
C     MASK1  - Masking operations between an image and a scalar. The 
C              operations supported are: MAX, MIN, replace where IMAGE is 
C              non-magic (or good quality), replace where IMAGE is magic
C              (or bad quality).
C
C
C   Scope of program
C   ----------------
C   - Images of up to six dimensions accepted.
C   - Data array types SHORT and FLOAT supported; others converted to FLOAT.
C     (bitwise logical operations accept SHORT array type only).
C   - Subsetting supported.
C   - Magic values supported.
C   - Quality and error arrays supported.
C   - Batch execution supported.
C
C
C   Environment
C   -----------
C   FIGARO
C
C                                               
C   Parameters (read or written)
C   ----------------------------
C   IMAGE    Name of the structure containing the input image. (character)
C            (prompted for).
C
C   START    Coordinate in each dimension of IMAGE at which the operation is
C            to start. (real, array)(prompted for).
C
C   END      Coordinate in each dimension of IMAGE at which the operation is
C            to end. (real, array)(prompted for).
C
C   OPER     Operation to be performed. (character)(prompted for).
C
C   VALUE    Scalar to be combined with IMAGE. (real)(prompted for).
C
C   OUTPUT   Name of the structure containing the output image. May be the 
C            same as IMAGE. (character)(prompted for).     
C
C   ERR_ACT  Action to be taken with a void error array (character,prompted)
C
C   ERR_VAL  Value to replace void errors with (real, prompted)
C
C
C   Keywords
C   --------
C   WHOLE    Instructs the program to operate on the whole image. Otherwise,
C            a subset of the image may be selected.
C
C
C   Propagation of data structure
C   -----------------------------
C   - Principal structure is IMAGE.
C   - All standard objects are copied from IMAGE.
C   - Data array is modified.
C
C
C   Method
C   ------
C   - The IMAGE structure is tested for the bad data flag. If it is found 
C     and non-zero, magic values are assumed to be present and are left in
C     the data.
C   - The structure IMAGE is copied to OUTPUT.
C   - A subroutine appropriate to the required operation, the data type,
C     and the presence or absence of magic values is called to operate on
C     the OUTPUT data array.
C
C   Note
C   ----
C
C     Lines commented with 'C*' indicate the current non-compatibility
C     of quality arrays and magic values, and have been included for
C     forward compatibilty.
C
C   External functions & subroutines called
C   ---------------------------------------
C   Library DSA:
C      DSA_CLOSE
C      DSA_DATA_SIZE
C      DSA_INPUT
C      DSA_MAP_DATA
C      DSA_MAP_ERRORS
C      DSA_MAP_QUALITY
C      DSA_OPEN          
C      DSA_OUTPUT
C      DSA_USE_FLAGGED_VALUES
C      DSA_WRUSER
C
C   Library DYN:
C      DYN_ELEMENT
C
C   Library ICH:
C      ICH_FOLD
C      ICH_LEN
C
C   Library NDP:
C      NDP_AXIS_RANGE
C      NDP_GET_IMAGE_INFO
C      NDP_SET_BAD_PIXEL
C
C   Library PAR:
C      PAR_COMMAND
C      PAR_RDCHAR
C      PAR_RDVAL
C
C
C   Internal subroutines called
C   ---------------------------
C   COMB1_AC_W
C   COMB1_AC_WQ
C   COMB1_AC_R
C   COMB1_AC_RQ
C   COMB1_B_W
C   COMB1_B_WQ
C   REPLACE_ERRORS_R
C   REPLACE_ERRORS_W
C      
C
C   INCLUDE statements
C   ------------------
C   INCLUDE 'DYN_SOURCE:DYNAMIC_MEMORY.INC'
C   INCLUDE 'NDP_SOURCE:NDP_MAGIC_VALUES.INC'
C   INCLUDE 'NDP_SOURCE:NDP_NUMERIC_RANGES.INC'
C   INCLUDE 'NDP_SOURCE:NDP_QUALITY_MASK.INC'
C   INCLUDE 'DCV_FUN'
C
C
C   Extensions to FORTRAN 77
C   ------------------------
C   END DO / IMPLICIT NONE / INCLUDE / Names > 6 characters
C
C
C   Possible future upgrades
C   ------------------------
C   - Allow a fractional offset between images before combination, with 
C     linear interpolation of pixel values.
C
C
C   Author/s
C   --------
C   Nick Fuller  RGO  (RGVAD::NMJF or NMJF@UK.AC.RGO.STAR)
C   Chris Benn  RGO  (RGVAD::CRB or CRB@UK.AC.RGO.STAR)
C   Julian Gold RGO (CAVAD::GOLDJIL or GOLDJIL@UK.AC.CAM.AST-STAR)
C
C
C   History
C   -------
C   01-FEB-1989  - Original program
C   12-JLY-1991  - Quality and error arrays implemented, with new options:
C                  REP1 replace data when quality is good
C                  REP4 replace data when quality is bad
C                  (only applicable when quality arrays exist). (GOLDJIL)
C   20-AUG-1991  - Why oh why did the author compare COMMAND with 'ACOMB1'
C                  etc when the command names are 'LOGIC1' etc ? Fixed now.
C                  Sigh...
C   30-NOV-1992  - Unix version. Changed REP1 to REPG, REP4 to REPB which
C                  are a tad less cryptic. (GOLDJIL)
C   06-OCT-1994  - Removed a Trojan Horse message. Also ensured that an
C                  infinite loop does not occur when an improper operation is
C                  requested. Removed unused variables. (GJP)
C   13-OCT-1994  - Modified code to avoid an eternal loop
C                  when attempting to divide by zero in ARITH1. (GJP)
C
C
1 mask2
  Masking of an image or image subset with another (MAX, MIN, various
  replacements).
2 IMAGE
   NAME    IM(AGE)
   TYPE    FILE
   OPTIONS INPUT
   PROMPT  "(IMage) Name of first input image"
   TEXT    ----------------------------------------------------------------
           IMAGE is the name of the structure containing the image to be 
           arithmetically combined with a second image. The image may have
           from one to six dimensions. The dimensions of the output image
           will be the same as those of the first input image.
           ----------------------------------------------------------------
2 IMAGE1
   NAME    IMAGE1
   TYPE    FILE
   OPTIONS INPUT
   PROMPT  "(IMAGE1) Name of second input image"
   TEXT    ----------------------------------------------------------------
           IMAGE1 is the name of the structure containing the second image.
           The image may have from one to six dimensions.
           ----------------------------------------------------------------
2 WHOLE
   NAME    WH(OLE)
   TYPE    KEY                                               
   PROMPT  "(WHole) Process the whole of the first image?"
   TEXT    ----------------------------------------------------------------
           If WHOLE is specified, the entire area of IMAGE will be 
           processed. Otherwise, a subset of the image may be selected.
           ----------------------------------------------------------------
2 START
   NAME    ST(ART)
   TYPE    FLOAT[6]
   PROMPT  "(STart) Start coordinates of subset."
   TEXT    ----------------------------------------------------------------
           START is an array containing the start coordinate of the subset
           to be processed in each dimension of IMAGE. The first array
           element is the start coordinate in the first dimension of the 
           current sort order (usually X). Each coordinate must be given 
           in axis units if the relevant axis is calibrated, or in pixels 
           if it is not calibrated or the axis structure is not present.  
           ----------------------------------------------------------------
2 END
   NAME    EN(D)
   TYPE    FLOAT[6]
   PROMPT  "(ENd) End coordinates of subset."
   TEXT    ----------------------------------------------------------------
           END is an array containing the end coordinate of the subset
           to be processed in each dimension of IMAGE. The first array
           element is the end coordinate in the first dimension of the 
           current sort order (usually X). Each coordinate must be given 
           in axis units if the relevant axis is calibrated, or in pixels 
           if it is not calibrated or the axis structure is not present.  
           ----------------------------------------------------------------
2 OPER
   NAME    OP(ER)
   TYPE    CHAR
   PROMPT  "(OPer) MAX,MIN,REP1,REP2,REP3,REP4"
   TEXT    ----------------------------------------------------------------
           Masking Operations:
           MAX  : Output pixel = maximum of two input pixels
           MIN  : Output pixel = minimum of two input pixels
           REP1 : Replace IMAGE with IMAGE1 at valid pixels in IMAGE
           REP2 : Replace IMAGE with IMAGE1 at valid pixels in IMAGE1
           REP3 : Replace IMAGE with IMAGE1 when both pixels are valid
           REP4 : Replace IMAGE with IMAGE1 when neither pixel is valid
           (Valid means either good quality if a quality array is present,
            or non-magic if magic values are present)
           ----------------------------------------------------------------
2 OUTPUT
   NAME    OUT(PUT)
   TYPE    FILE
   OPTIONS OUTPUT
   PROMPT  "(OUTput) Name of output image"
   TEXT    ----------------------------------------------------------------
           OUTPUT is the name of the structure which will contain the
           output image. It will have the same dimensions as IMAGE. If 
           OUTPUT already exists, a new version will be created. If OUTPUT
           is the same as IMAGE or IMAGE1, a new version of IMAGE or 
           IMAGE1 will be created.
           ----------------------------------------------------------------
2 ERR_ACT
   NAME    ERR_ACT
   TYPE    CHAR
   PROMPT  "(ERR_ACT) (R)eplace void values or (L)eave"
   TEXT    ---------------------------------------------------------------
           When an operation inserts a new value for a pixel in the image,
           the error associated with that pixel is then undefined (void).
           Responding R will replace void values with a constant of your 
           choice. L or any other character will leave the error array 
           unchanged.
           ---------------------------------------------------------------
2 ERR_VAL
   NAME    ERR_VAL
   TYPE    FLOAT
   PROMPT  "(ERR_VAL) Value to replace void errors with"
   TEXT    ---------------------------------------------------------------
           When an operation inserts a new value for a pixel in the image,
           the error associated with that pixel is then undefined (void).
           Enter the value you wish to replace void errors with.
           ---------------------------------------------------------------
2 SOURCE_COMMENTS
C+
C
C   ---------
C   C O M B 2
C   ---------
C
C   Description
C   -----------
C   This routine services the following commands:
C
C     ARITH2 - Arithmetic operations between two images. The operations 
C              supported are: +, -, *, /, **.
C
C     LOGIC2 - Bitwise logical operations between two images. The operations
C              supported are: AND, OR, XOR, NAND, NOR, NXOR.
C
C     MASK2  - Masking operations between two images. The operations 
C              supported are: MAX, MIN, replace where IMAGE is non-magic, 
C              replace where IMAGE1 is non-magic, replace where IMAGE and 
C              IMAGE1 are both non-magic, replace where IMAGE is magic.
C              (Read bad quality for magic if quality data is present)
C
C   If the input images have different dimensionalities, the one with the 
C   larger number of dimensions must be given first, as IMAGE. In such a
C   case the combination may be performed repeatedly, starting and ending at
C   given coordinates in the higher dimensions of IMAGE. For example a 2-D
C   IMAGE1 may be combined with several consecutive planes of a 3-D IMAGE.
C
C   The axes of IMAGE1 are aligned with the corresponding axes of IMAGE,
C   i.e. a 1-D IMAGE1 is always combined with the X rows of IMAGE. This is
C   the most efficient way to operate on arrays, producing the lowest number
C   of page faults. If it is required to combine a 1-D IMAGE1 with the Z 
C   rows of a 3-D IMAGE, the XYZ to ZXY transposition of IMAGE may be 
C   achieved by prior use of TRANSPOSE. 
C
C   The output structure will be a copy of the FIRST input structure.
C
C
C   Scope of program
C   ----------------
C   - Images of up to six dimensions accepted.
C   - Data array types SHORT and FLOAT supported; others converted to FLOAT.
C     (bitwise logical operations accept SHORT array type only).
C   - Subsetting supported.
C   - Magic values supported.
C   - Quality and error arrays supported.
C   - Batch execution supported.
C
C
C   Environment
C   -----------
C   FIGARO
C
C                                               
C   Parameters (read or written)
C   ----------------------------
C   IMAGE    Name of the structure containing the first image. (character)
C            (prompted for).
C
C   IMAGE1   Name of the structure containing the second image. (character)
C            (prompted for).  
C
C   START    Coordinate in each dimension of IMAGE at which the operation is
C            to start. (real, array)(prompted for).
C
C   END      Coordinate in each dimension of IMAGE at which the operation is
C            to end. (real, array)(prompted for).
C
C   OPER     Operation to be performed. (character)(prompted for).
C
C   OUTPUT   Name of the structure containing the output image. May be the 
C            same as IMAGE. (character)(prompted for).     
C
C
C   Keywords
C   --------
C   WHOLE    Instructs the program to operate on the whole image. Otherwise,
C            a subset of the image may be selected.
C
C
C   Propagation of data structure
C   -----------------------------
C   - Principal structure is IMAGE.
C   - All standard objects are copied from IMAGE.
C   - Data array is modified.
C
C
C   Method
C   ------
C   - The IMAGE and IMAGE1 structures are tested for the bad data flag. If 
C     either is found and non-zero, magic values are assumed to be present
C     and are left in the data.
C   - A subset of IMAGE is optionally selected by specifying the start and 
C     end coordinates in each dimension. If IMAGE has more dimensions than 
C     IMAGE1, the required start and end coordinates in each of the higher 
C     dimensions are also prompted for. For example, if it is required to 
C     combine a 2-D IMAGE1 with a 3-D IMAGE, the start and end pixels in the
C     third dimension of IMAGE control which XY planes of IMAGE are combined
C     with IMAGE1.         
C   - The structure IMAGE is copied to OUTPUT. If the data array of either 
C     IMAGE or IMAGE1 is of type FLOAT, then both IMAGE and IMAGE1 are 
C     mapped as FLOAT.
C   - Error and quality arrays are mapped as appropriate.
C   - A subroutine appropriate to the required operation, the data type, and
C     the presence or absence of magic values is called to operate on the
C     IMAGE1 and OUTPUT data arrays.
C
C
C   External functions & subroutines called
C   ---------------------------------------
C   Library DSA:
C      DSA_AXIS_RANGE
C      DSA_CLOSE
C      DSA_DATA_SIZE
C      DSA_INPUT
C      DSA_MAP_DATA
C      DSA_MAP_ERRORS
C      DSA_MAP_QUALITY
C      DSA_OPEN          
C      DSA_OUTPUT
C      DSA_USE_FLAGGED_VALUES
C      DSA_WRUSER
C
C   Library DYN:
C      DYN_ELEMENT
C
C   Library ICH:
C      ICH_ENCODE
C      ICH_FOLD
C      ICH_LEN
C
C   Library NDP:
C      NDP_ERROR_ARITH_R
C      NDP_ERROR_ARITH_W
C      NDP_GET_IMAGE_INFO
C      NDP_PAR_RDARY
C      NDP_SET_BAD_PIXEL
C
C   Library PAR:
C      PAR_COMMAND
C      PAR_RDCHAR
C      PAR_RDVAL
C
C
C   Internal subroutines called
C   ---------------------------
C   COMB2_AC_W
C   COMB2_AC_WQ
C   COMB2_AC_R
C   COMB2_AC_RQ
C   COMB2_B_W
C   COMB2_B_WQ
C   REPLACE_ERRORS_R
C   REPLACE_ERRORS_W
C      
C
C   INCLUDE statements
C   ------------------
C   INCLUDE 'DYN_SOURCE:DYNAMIC_MEMORY.INC'
C   INCLUDE 'NDP_SOURCE:NDP_MAGIC_VALUES.INC'
C   INCLUDE 'NDP_SOURCE:NDP_NUMERIC_RANGES.INC'
C   INCLUDE 'DCV_FUN'
C
C
C   Extensions to FORTRAN 77
C   ------------------------
C   END DO / IMPLICIT NONE / INCLUDE / Names > 6 characters
C
C
C   Possible future upgrades
C   ------------------------
C   - Allow a fractional offset between images before combination, with 
C     linear interpolation of pixel values.
C   - Purging of the error array when void values are present. At present,
C     this would require use of DSA common block data and routines in the
C     NON-shareable DSA library. Hint, hint, Keith?
C
C   Author/s
C   --------
C   Nick Fuller  RGO  (RGVAD::NMJF or NMJF@UK.AC.RGO.STAR)
C   Julian Gold  RGO  (CAVAD::GOLDJIL or GOLDJIL@UK.AC.CAM.AST-STAR)
C
C
C   History
C   -------
C   01-FEB-1989   - Original program
C   29-AUG-1990   - Bug which sometimes caused the output file to be mapped 
C                   as the wrong type was fixed.  A few typos were also
C                   corrected.  (JRL)
C   10-AUG-1991   - Quality and error handling implemented (GOLDJIL)
C   16-SEP-1991   - Bug which led to erroneous output if IMAGE 
C                   contained SHORT data and IMAGE1 FLOAT data fixed.
C                   (GOLDJIL)
C   30-NOV-1992   - Unix version (GOLDJIL).
C   06-OCT-1994   - Removed a Trojan Horse message. Also ensured that an
C                   infinite loop does not occur when an improper operation is
C                   requested. Removed unused variables. (GJP)
C
1 moments
  Computes moments for the emmision features in each spectrum of a 
  ZXY sorted SLDC. Stores its results in a structure comprising both 
  data and errors.
2 IMAGE
   NAME    IM(AGE)
   TYPE    FILE
   OPTIONS INPUT
   PROMPT  "(IMage) Name of image (ZXY-sorted)"
   TEXT    ----------------------------------------------------------------
           IMAGE is the name of the structure containing the image for
           which moments are to be computed. The image must be 3-D and 
           ZXY-sorted.
           ----------------------------------------------------------------
2 USEMASK
   NAME    USEM(ASK)
   TYPE    KEY
   PROMPT  "(USEMask) Use a mask image?"
   TEXT    ----------------------------------------------------------------
           If USEMASK is specified, a mask image will be used. This must 
           be a 2-D image with the same X and Y dimensions as the image to
           be processed. It will be expected to contain magic values. 
           Where a mask pixel has the magic value, the spectrum at the  
           corresponding position in the input image will not be used in
           the moments computation.
           ----------------------------------------------------------------
2 MASK
   NAME    MASK
   TYPE    FILE
   OPTIONS INPUT
   PROMPT  "(MASK) Name of mask image"
   TEXT    ----------------------------------------------------------------
           MASK is the name of the structure containing the image to be
           used as a mask to select spectra for moments computation. The 
           image must be 2-D and is expected to contain magic values.
           ----------------------------------------------------------------
2 FINDSEQ
   NAME    FINDSEQ
   TYPE    KEY
   OPTIONS NOPROMPT
   PROMPT  "(FINDSEQ) Find peaks in sequence from pixel 1?"
   TEXT    ----------------------------------------------------------------
           If FINDSEQ is specified, the spectrum will be searched from 
           pixel 1 and the peaks will be processed in the sequence in 
           which they are encountered. A peak is identified if the flux
           rises to a maximum and then drops below THRESH. The WIDTH of
           peaks and the GAP between them are used to avoid areas where
           valid peaks are not likely to be found. This is not the most
           usual method, but in a case where two peaks have more or less
           equal strength, it has the advantage of delivering them in a
           definite order. If FINDSEQ is not specified, each peak will be
           located by finding the maximum pixel over the whole spectrum. 
           An area of pixels around the peak, governed by WIDTH, will then
           be masked and the next peak will be found over the remaining 
           pixels.
           ----------------------------------------------------------------
2 PEAKS
   NAME    PEAKS
   TYPE    INT
   PROMPT  "(PEAKS) Number of peaks to be found"
   TEXT    ----------------------------------------------------------------
           PEAKS is the number of emission components to be found. The 
           results file will contain PEAKS component structures.
           ----------------------------------------------------------------
2 THRESH
   NAME    THRESH
   TYPE    FLOAT
   PROMPT  "(THRESH) Threshold pixel value for peak search"
   TEXT    ----------------------------------------------------------------
           THRESH is the threshold pixel value above which a feature will 
           be identified as a valid peak. Increasing THRESH reduces the
           likelihood of noise features being identified as peaks.
           ----------------------------------------------------------------
2 WIDTH
   NAME    WIDTH
   TYPE    FLOAT
   PROMPT  "(WIDTH) Width of peaks in pixels"
   TEXT    ----------------------------------------------------------------
           WIDTH is the expected width at base of each peak. An area of
           WIDTH pixels, centred on the maximum pixel of a peak, will be 
           used in the computation of moments.
           ----------------------------------------------------------------
2 GAP
   NAME    GAP
   TYPE    FLOAT
   PROMPT  "(GAP) Minimum separation of peaks in pixels"
   TEXT    ----------------------------------------------------------------
           GAP is the expected separation of the centres of adjacent peaks.
           The area between peaks (allowing for their width) will not be 
           searched, so the likelihood of wrong identifications in this 
           region is reduced. GAP is disregarded if PEAKS is 1.
           ----------------------------------------------------------------
2 BIN
   NAME    BIN
   TYPE    INT
   PROMPT  "(BIN) Binning factor in XY plane"
   TEXT    ----------------------------------------------------------------
           BIN is the size of the XY area of spectra which will be summed
           and averaged for each moments computation. This may improve the
           signal/noise ratio.
           ----------------------------------------------------------------
2 RESULTS
   NAME    RESULTS
   TYPE    FILE
   OPTIONS OUTPUT
   PROMPT  "(RESULTS) Name of results structure"
   TEXT    ----------------------------------------------------------------
           RESULTS is the name of the structure in which the array(s) of
           data computed by this program will be stored.  
           ----------------------------------------------------------------
2 SOURCE_COMMENTS
C+
C
C   -------------
C   M O M E N T S
C   -------------
C
C   Description
C   -----------
C   Calculates the moments (total flux, position, variance, skewness,
C   and kurtosis) of spectral emission components in a ZXY-sorted image. 
C   The spectra may be binned in the spatial directions to improve 
C   signal/noise. A mask image may be used to avoid parts of the image.
C   The moments results are written to a results structure.
C
C
C   Scope of program
C   ----------------
C   - Specific to three dimensions.
C   - Data array types SHORT and FLOAT supported; others converted to FLOAT.
C   - Subsetting not supported.
C   - Magic values supported.
C   - Quality and variance arrays supported.
C   - Batch execution supported.
C
C
C   Environment
C   -----------
C   FIGARO
C
C
C   Parameters (read or written)
C   ----------------------------
C   IMAGE    Name of the structure containing the image. (character)
C            (prompted for).
C
C   MASK     Name of the structure containing the mask image. (character)
C            (prompted for).
C
C   PEAKS    Number of peaks to be found. (integer)(prompted for).
C
C   THRESH   Threshold pixel value for peak search. (real)(prompted for).
C
C   WIDTH    Width of peaks in pixels. (real)(prompted for).
C
C   GAP      Minimum separation of peaks. (real)(prompted for).
C
C   BIN      Binning factor in the XY plane. (integer)(prompted for).
C
C   RESULTS  Name of the results structure. (character)(prompted for).
C
C
C   Keywords
C   --------
C   USEMASK  If specified, a mask image is used to select spectra.
C
C   FINDSEQ  If specified, the spectrum will be searched from the first pixel 
C            and peaks will be processed in the sequence in which they are 
C            encountered. A peak is identified if the flux rises to a maximum
C            and then drops below THRESH. The WIDTH of peaks and the GAP 
C            between them will be used to avoid areas where valid peaks are not
C            likely to be found. If FINDSEQ is not specified, peaks will be 
C            located by finding the maximum pixel in the spectrum. A number of
C            pixels around the peak, governed by WIDTH, will then be masked and
C            the next maximum will be found among the pixels remaining. 
C            (hidden keyword).
C                       
C   WEIGHT   Flag to determine whether to weight statistics with variance
C            values (if applicable). 
C
C   Propagation of data structure
C   -----------------------------
C   Not relevant.
C
C
C   Method
C   ------
C   - The IMAGE structure is tested for the bad data flag, a quality array
C     and an error array. If no quality array is present, and the bad pixel
C     value is non-zero, magic values are assumed to be present and are left in
C     the data. If a quality array is present, the DSA routines are used
C     to convert these to equivalent magic values.
C   - If a mask image is requested, the dimensions of its data array must
C     match the dimensions of IMAGE which have been designated X and Y, in
C     this case dimensions 2 and 3 since IMAGE is ZXY-sorted.
C   - The results structure for MOMENTS is created.
C   - The IMAGE data array may be binned in the spatial dimensions to 
C     improve signal/noise. The bin average is computed at each pixel in the
C     spectral dimension. MOMENTS_MASKBIN performs binning and masking. If
C     masking is requested, a spectrum only contributes to the average in 
C     a bin if the relevant MASK pixel is clear, i.e. non-magic. A 3-D work 
C     array containing the binned and/or masked data is used in subsequent 
C     operations. If the binning interval is 1 and a mask is not used, 
C     MOMENTS_MASKBIN is skipped and the IMAGE array is mapped directly. 
C   - Once the masking has been done, the MASK array is unmapped and the
C     structure is closed. This is because the maximum number of structures 
C     which may be referenced at one time is eight, set by the MAX_REFS 
C     parameter in the DSA common block.
C   - Peaks may be found in two ways. MOMENTS_FINDMAX locates a peak by 
C     looking for the maximum pixel over the whole spectrum, regardless of 
C     where it is. MOMENTS_FINDSEQ starts at pixel 1 and identifies a peak 
C     if the flux rises to a maximum and then drops below the required 
C     threshold. The first method is more commonly used, but if there are 
C     two or more emissions of more or less equal strength, the second 
C     delivers them in a definite order. Once a peak has been found, both 
C     routines store the pixel number of its maximum value in a 2-D work 
C     array, and then mask the required width of spectrum around the peak by
C     flagging the corresponding pixels in a 3-D work array.
C
C   External functions & subroutines called
C   ---------------------------------------
C   Library DSA:
C     DSA_CLOSE
C     DSA_DATA_SIZE
C     DSA_GET_WORKSPACE
C     DSA_INPUT
C     DSA_MAP_AXIS_DATA
C     DSA_MAP_DATA
C     DSA_MAP_VARIANCE
C     DSA_OPEN         
C     DSA_SEEK_ERRORS
C     DSA_SEEK_QUALITY                              
C     DSA_SIMPLE_OUTPUT
C     DSA_TYPESIZE
C     DSA_UNMAP
C     DSA_USE_FLAGGED_VALUES
C     DSA_WRUSER
C
C   Library DYN:
C     DYN_ELEMENT
C
C   Library GEN:
C     GEN_FILL
C
C   Library ICH:
C     ICH_CI
C     ICH_ENCODE
C     ICH_LEN
C
C   Library NDP:
C     NDP_GET_IMAGE_INFO
C     NDP_MATCH_SIZES
C     NDP_SET_BAD_PIXEL
C
C   Library PAR:
C     PAR_RDCHAR
C     PAR_RDKEY
C     
C   Library VAR:
C     VAR_GETNUM
C     VAR_SETNUM
C
C
C   Internal subroutines called
C   ---------------------------
C     MOMENTS_MASKBIN_W
C     MOMENTS_MASKBIN_WQ
C     MOMENTS_MASKBIN_R
C     MOMENTS_MASKBIN_RQ
C     MOMENTS_COMPUTE_R
C     MOMENTS_COMPUTE_RQ
C     MOMENTS_COMPUTE_RV
C     MOMENTS_COMPUTE_RQV
C     MOMENTS_FINDMAX_R
C     MOMENTS_FINDMAX_RQ
C     MOMENTS_FINDSEQ_R
C     MOMENTS_FINDSEQ_RQ
C
C
C   INCLUDE statements
C   ------------------
C   INCLUDE 'DYN_SOURCE:DYNAMIC_MEMORY.INC'
C   INCLUDE 'NDP_SOURCE:NDP_MAGIC_VALUES.INC'
C   INCLUDE 'NDP_SOURCE:NDP_NUMERIC_RANGES.INC'
C                                             
C
C   Extensions to FORTRAN77
C   -----------------------
C   END DO / IMPLICIT NONE / INCLUDE / Names > 6 characters
C
C
C   Possible future upgrades
C   ------------------------
C
C
C   Author/s
C   --------
C   Nick Fuller  RGO  (RGVAD::NMJF or NMJF@UK.AC.RGO.STAR)
C   Jim Lewis    RGO  (CAVAD::JRL or JRL@UK.AC.CAM.AST-STAR)
C   Julian Gold  RGO  (CAVAD::GOLDJIL or GOLDJIL@UK.AC.CAM.AST-STAR)
C
C   History
C   -------
C   01-FEB-1989   - Original program
C   03-AUG-1990   - Fixed so that adjustable array sizes are not passed
C                   as elements of another array.  This practice has been
C                   banned by the v5.2 compiler.  (JRL)
C   13-NOV-1991   - Oh my god what a mess... I cleared up the messy results
C                   structure, replaced it with a much simpler animal created
C                   using DSA_SIMPLE_OUTPUT. Oi Voi, my life!.... Oh, added
C                   the usual quality and error array processing. (GOLDJIL)
C
C   16-MAR-1992   - Got rid of DSA_ACTNAME and replaced DSA_CFILLx's with
C                   GEN_FILL's.
C   02-DEC-1992   - Unix version.
C   06-OCT-1994   - Unused variables removed. (GJP)
C   10-OCT-1994   - Added section setting up workspace for
C                   component count (suggested by JRL) (GJP)
C
1 movie
  Fast sequential display of the XY planes of an XYZ sorted 3-D image.
2 IMAGE
   NAME    IM(AGE)
   TYPE    FILE
   OPTIONS INPUT
   PROMPT  "(IMage) Name of image to be displayed"
   TEXT    ----------------------------------------------------------------
           IMAGE is the name of the structure containing the image to be 
           displayed. Only a 2-D subset may be displayed, although any of
           the dimensions may be chosen. The image may have from one to
           six dimensions.
           ----------------------------------------------------------------
2 WHOLE
   NAME    WH(OLE)
   TYPE    KEY                                               
   PROMPT  "(WHole) Display the whole image?"
   TEXT    ----------------------------------------------------------------
           If WHOLE is specified, the entire 2-D image will be displayed.
           Otherwise, a subset of the image may be selected.
           ----------------------------------------------------------------
2 START
   NAME    ST(ART)
   TYPE    FLOAT[6]
   PROMPT  "(STart) Start coordinates of subset."
   TEXT    ----------------------------------------------------------------
           START is an array containing the start coordinate of the subset
           to be displayed in each dimension of the image. The first array
           element is the start coordinate in the first dimension of the 
           current sort order (usually X). Each coordinate must be given 
           in axis units if the relevant axis is calibrated, or in pixels 
           if it is not calibrated or the axis structure is not present.  
           ----------------------------------------------------------------
2 END
   NAME    EN(D)
   TYPE    FLOAT[6]
   PROMPT  "(ENd) End coordinates of subset."
   TEXT    ----------------------------------------------------------------
           END is an array containing the end coordinate of the subset
           to be displayed in each dimension of the image. The first array
           element is the end coordinate in the first dimension of the 
           current sort order (usually X). Each coordinate must be given 
           in axis units if the relevant axis is calibrated, or in pixels 
           if it is not calibrated or the axis structure is not present.  
           ----------------------------------------------------------------
2 STEP
   NAME    STEP
   TYPE    INT
   PROMPT  "(STEP) Frame step"
   TEXT    ----------------------------------------------------------------
           STEP is the increment between displayed frames.
           ----------------------------------------------------------------
2 LOW
   NAME    LO(W)
   TYPE    FLOAT
   PROMPT  "(LOw) Lowest value to be displayed"
   TEXT    ----------------------------------------------------------------
           Pixels less than or equal to LOW will be plotted in the lowest
           colour index if a colour table is used, or as black if a grey
           scale is used. This convention applies to screen devices, and 
           is reversed on hard copy devices to conserve ink or toner.
           ----------------------------------------------------------------
                    
2 HIGH
   NAME    HI(GH)
   TYPE    FLOAT
   PROMPT  "(HIgh) Highest value to be displayed"
   TEXT    ----------------------------------------------------------------
           Pixels greater than or equal to HIGH will be plotted in the
           highest colour index if a colour table is used, or as white if
           a grey scale is used. This convention applies to screen devices,
           and is reversed on hard copy devices to conserve ink or toner.
           ----------------------------------------------------------------
2 PLACE
   NAME    PLACE
   TYPE    CHAR 
   PROMPT  "(PLACE) Location of plot"
   TEXT    ----------------------------------------------------------------
           PLACE controls the location of the image on the screen or page. 
           Options are 'BL','BC','BR','LC','CC','RC','TL','TC', and 'TR'.
           ----------------------------------------------------------------
2 MAG
   NAME    MAG
   TYPE    FLOAT
   PROMPT  "(MAG) Magnification of plot"
   TEXT    ----------------------------------------------------------------
           If MAG is 1, the image plot will be fitted to the full display 
           surface. Values less than 1 will reduce both linear dimensions 
           by the same fraction.
           ----------------------------------------------------------------
2 LABEL
   NAME    LAB(EL)
   TYPE    CHAR
   PROMPT  "(LABel) Label for plot"
   TEXT    ----------------------------------------------------------------
           This character string will be placed above the image plot.
           ----------------------------------------------------------------
2 AXES
   NAME    AX(ES)
   TYPE    KEY
   PROMPT  "(AXes) Plot image axes?"
   TEXT    ----------------------------------------------------------------
           If AXES is specified, calibrated axes will be plotted around
           the image. Otherwise, the image will be plotted in a plain box.
           ----------------------------------------------------------------
2 RAMP
   NAME    RAMP
   TYPE    KEY
   PROMPT  "(RAMP) Plot ramp of colour or grey scale?"
   TEXT    ----------------------------------------------------------------
           If RAMP is specified, the colour or grey scale, calibrated in 
           image data units, will be plotted to the right of the image.
           ----------------------------------------------------------------
2 TABLE
   NAME    TAB(LE)
   TYPE    CHAR
   PROMPT  "(TABle) Name of lookup table"
   TEXT    ----------------------------------------------------------------
           TABLE is the name of a file containing red, green, and blue
           intensities for each of 256 colour indices. These form a colour
           table which will be used in the plotting of the 2-D image. The 
           name extension .LUT is assumed, unless TABLE is 'GREY', in
           which case a grey scale will be constructed without using a 
           table file.
           ----------------------------------------------------------------
2 ERASE
   NAME    ER(ASE)
   TYPE    KEY
   PROMPT  "(ERase) Erase screen before plotting?"
   TEXT    ----------------------------------------------------------------
           If ERASE is specified, the screen will be cleared before the 
           plot is displayed. Otherwise, the current screen display will
           remain. This feature may be used to display several images in
           different areas of the screen.
           ----------------------------------------------------------------
2 SOURCE_COMMENTS
C+
C
C   ---------
C   M O V I E
C   --------- 
C
C   Description
C   -----------
C   Plots successive planes (in dimensions 1 and 2) of a 3-D image in 
C   greyscale or colour on an image display device. The speed is acceptable
C   on the Ikon but very slow on the ARGS.
C
C
C   Scope of program
C   ----------------
C   - Handles 2-D images only.
C   - Data array types SHORT and FLOAT supported; others converted to FLOAT.
C   - Subsetting supported.
C   - Magic values and quality arrays supported.
C   - Variance arrays not supported.
C   - Batch execution not supported.
C
C
C   Environment
C   -----------
C   FIGARO
C
C
C   Parameters (read or written)
C   ----------------------------
C   IMAGE    Name of the structure containing the image to be displayed. 
C            (character)(prompted for).
C
C   START    Coordinate in each dimension of IMAGE at which the display is
C            to start. (real, array)(prompted for).
C
C   END      Coordinate in each dimension of IMAGE at which the display is
C            to end. (real, array)(prompted for).
C
C   STEP     Number of planes to increment between each display. (integer) 
C            (prompted for). 
C
C   LOW      Data value which is plotted in the lowest colour index or as 
C            black. (real)(prompted for). 
C
C   HIGH     Data value which is plotted in the highest colour index or as
C            white. (real)(prompted for). 
C
C   PLACE    Code for one of nine possible locations on the display surface,
C            being a combination of T, C, or B, and L, C, or R. (character)
C            (prompted for).
C
C   MAG      Magnification of the plot. Magnification 1 fits the plot to the
C            whole display surface. (real)(prompted for).
C
C   LABEL    Text placed centrally above the plot. (character)(prompted 
C            for).
C
C   TABLE    Name of colour or grey scale lookup table. (character)
C            (prompted for).      
C            
C   SOFTDEV  Current screen device name (character)(read from file).
C
C
C   Keywords
C   --------
C   WHOLE    Instruction to display the whole image. Otherwise, a subset of 
C            each dimension may be selected.
C
C   AXES     Instruction to plot calibrated axes. Otherwise, the image is
C            framed with a plain box.
C
C   RAMP     Instruction to plot a calibrated bar of the colour or grey 
C            scale to the right of the image.
C
C   ERASE    Instruction to erase screen before plotting. Otherwise, a
C            number of images may be displayed at different places on the
C            same screen.
C
C
C
C   Propagation of data structure
C   -----------------------------
C   Not relevant.
C
C
C   Method
C   ------
C   - The current screen device name is read from the parameter file.
C   - The IMAGE structure is tested for the bad data flag. If it is found
C     and non-zero, magic values are assumed to be present and are left in
C     the data.
C   - The start and end coordinates in each dimension of the image are
C     prompted for. The coordinates in dimension 3 give the range of planes 
C     to be displayed. The parameter STEP allows planes to to be skipped.
C   - The required lookup table is read and stored. This is done by the 
C     routine NDP_IMAGE_LUT. 
C   - A subroutine appropriate to the data type is called to display the 
C     data. The method is to extract planes from the 3-D array into a 
C     2-D floating point work array, which is processed into colour index
C     values by NDP_IMAGE_INDEX and then plotted using PGPIXL.
C   - If magic values are present, they are replaced by a value below the
C     low plotting threshold.
C   - As the planes are displayed on the image device, the frame numbers are
C     output to the alphanumeric device. This enables the movie to be paused
C     and restarted with CTRL-S and CTRL-Q.
C
C
C   External functions & subroutines called
C   ---------------------------------------
C   Library DSA:
C     DSA_CLOSE
C     DSA_DATA_SIZE
C     DSA_GET_WORKSPACE
C     DSA_INPUT
C     DSA_MAP_DATA
C     DSA_MAP_QUALITY
C     DSA_OPEN
C     DSA_TYPESIZE
C     DSA_SEEK_QUALITY
C     DSA_USE_FLAGGED_VALUES
C     DSA_WRUSER
C
C   Library DYN:
C     DYN_ELEMENT
C
C   Library ICH:
C     ICH_ENCODE
C     ICH_LEN
C
C   Library NDP:
C     NDP_AXIS_RANGE
C     NDP_GET_IMAGE_INFO
C     NDP_IMAGE_LUT
C     NDP_IMAGE_RAMP
C     NDP_IMAGE_VIEWPORT
C     NDP_REPLACE_MAGIC_R
C     NDP_REPLACE_QUAL_R
C     
C   Library PAR:
C     PAR_RDCHAR
C     PAR_RDKEY
C     PAR_RDVAL
C
C   Library VAR:
C     VAR_GETCHR
C
C   Starlink PGPLOT:
C     PGBEGIN
C     PGBOX
C     PGEND
C     PGLABEL
C     PGMTEXT
C     PGPIXL
C     PGSCH
C     PGSCI
C     PGVSIZE
C     PGWINDOW
C
C
C   Internal subroutines called
C   ---------------------------
C   MOVIE_DISPLAY_W
C   MOVIE_DISPLAY_R
C
C
C   INCLUDE statements
C   ------------------
C   INCLUDE 'DYN_SOURCE:DYNAMIC_MEMORY.INC'
C   INCLUDE 'NDP_SOURCE:NDP_NUMERIC_RANGES.INC'
C   INCLUDE 'NDP_SOURCE:NDP_MAGIC_VALUES.INC'
C   INCLUDE 'DCV_FUN'
C                                             
C
C   Extensions to FORTRAN77
C   -----------------------                           
C   END DO / IMPLICIT NONE / INCLUDE / Names > 6 characters
C
C                        
C   Possible future upgrades
C   ------------------------
C
C
C   Author/s
C   --------
C   Nick Fuller  RGO  (RGVAD::NMJF or NMJF@UK.AC.RGO.STAR)
C   Jim Lewis    RGO  (CAVAD::JRL or JRL@UK.AC.CAM.AST-STAR)
C   Julian Gold  RGO  (CAVAD::GOLDJIL or GOLDJIL@UK.AC.CAM.AST-STAR)
C
C   History
C   -------
C   01-FEB-1989   - Original program
C   10-JUL-1990   - Parameters in some subroutine calls changed to avoid 
C                   dimensioning arrays with elements of another array.  Also 
C                   included call to new LUT routine.  (Temporary measure as 
C                   NDP_IMAGE_LUT no longer works...) (JRL)
C   29-JUL-1990   - New version of NDP_IMAGE_LUT included. (JRL)
C   18-SEP-1990   - No longer replaces magic values with zeros.  This assumes 
C                   that the data are always going to be greater than zero 
C                   which in certain cases (e.g. a velocity map) it may not be.
C                   They are now replaced by a value which is below the lower 
C                   threshold requested for the plot.  The magic values are 
C                   now also replaced plane by plane in the subroutine 
C                   MOVIE_DISPLAY. This subroutine has a one plane workspace 
C                   where these changes can be made without any danger
C                   of the changes being written directly to disk. (JRL)
C   14-OCT-1991   - Quality arrays now implemeted and code written in GENERIC
C                   form. (GOLDJIL)
C   07-FEB-1992   - 2D gfx calls updated (GOLDJIL)
C   03-DEC-1992   - Unix version (GOLDJIL)
C   06-OCT-1994   - Removed unused variables. (GJP)
C
C
1 peek
  Displays the values of a specified image pixels and its immediate 
  neighbours.
2 IMAGE
   NAME    IM(AGE)
   TYPE    FILE
   OPTIONS INPUT
   PROMPT  "(IMage) Name of image to be displayed"
   TEXT    ----------------------------------------------------------------
           IMAGE is the name of the structure containing the image whose 
           value at a specified pixel will be displayed. For 1-D, 2-D, 
           and 3-D images, the values of the adjacent pixels are also 
           displayed. The image may have from one to six dimensions.
           ----------------------------------------------------------------
2 PIXEL
   NAME    PIX(EL)
   TYPE    INT[6]
   PROMPT  "(PIXel) Pixel number."
   TEXT    ----------------------------------------------------------------
           START is an array containing the number of the pixel to be 
           displayed in each dimension of the image. The first array 
           element is the pixel number in the first dimension of the
           current sort order (usually X). 
           ----------------------------------------------------------------
2 AGAIN
   NAME    AGAIN
   TYPE    KEY
   PROMPT  "(AGAIN) Display another pixel?"
   TEXT    ----------------------------------------------------------------
           If AGAIN is specified, another pixel number may be entered. 
           Otherwise, the program finishes. 
           ----------------------------------------------------------------
2 SOURCE_COMMENTS
C+
C
C   -------
C   P E E K 
C   -------
C
C   Description
C   -----------
C   Displays individual pixel values in an n-D image. If n = 1, 2 or 3, 
C   the values of adjacent pixels are also displayed.
C
C
C   Scope of program
C   ----------------
C   - Images of up to six dimensions accepted.
C   - Data array types SHORT and FLOAT supported; others converted to FLOAT.
C   - Subsetting not supported since not relevant.
C   - Magic values supported.
C   - Variance arrays not supported.
C   - Batch execution supported.
C
C
C   Environment
C   -----------
C   FIGARO
C
C
C   Parameters (read or written)
C   ----------------------------
C   IMAGE  Name of the structure containing the image. (character)
C          (prompted for)
C
C   PIXEL  Coordinates if the pixel to be inspected. (integer,array)
C          (prompted for)
C
C
C   Keywords
C   --------
C   AGAIN  Instruction to inspect another pixel.
C
C
C   Propagation of data structure
C   -----------------------------
C   Not relevant.
C
C
C   Method
C   ------
C   - The IMAGE structure is tested for the bad pixel flag. If it is found 
C     and non-zero, magic values are assumed to be present and are left in 
C     the data.
C   - An image subset is computed, consisting of the required pixel plus
C     its two neighbours in each dimension.
C   - The minimum and maximum values in the selected image subset are 
C     obtained by calling the appropriate NDP_STATS routine. These are used
C     to determine the maximum string length required to write out a data 
C     value.
C   - A subroutine appropriate to the data type is called to display the 
C     pixel value. For dimensionalities of 1, 2, and 3 the neighbouring
C     values are also displayed. In such cases, dimensions above 1 are 
C     accessed in reverse so that the display appears with the correct 
C     orientation.
C
C
C   External functions & subroutines called
C   ---------------------------------------
C   Library DSA:
C      DSA_CLOSE
C      DSA_DATA_SIZE
C      DSA_INPUT
C      DSA_MAP_DATA
C      DSA_MAP_QUALITY
C      DSA_OPEN
C      DSA_OUTPUT
C      DSA_SEEK_QUALITY
C      DSA_USE_FLAGGED_VALUES
C      DSA_WRUSER
C
C   Library DYN:
C      DYN_ELEMENT
C
C   Library ICH:
C      ICH_ENCODE
C      ICH_LEN
C
C   Library NDP:
C      NDP_GET_IMAGE_INFO
C      NDP_PAR_RDARY
C      NDP_STATS_W
C      NDP_STATS_WQ
C      NDP_STATS_R
C      NDP_STATS_RQ
C
C   Library PAR:
C      PAR_CNPAR
C      PAR_RDARY
C      PAR_RDCHAR
C      PAR_RDKEY
C      PAR_WRUSER
C
C
C   Internal subroutines called
C   ---------------------------
C   PEEK_DATA_W
C   PEEK_DATA_WQ
C   PEEK_DATA_R
C   PEEK_DATA_RQ
C
C
C   INCLUDE statements
C   ------------------
C   INCLUDE 'DYN_SOURCE:DYNAMIC_MEMORY.INC'
C   INCLUDE 'NDP_SOURCE:NDP_MAGIC_VALUES.INC'
C   INCLUDE 'NDP_SOURCE:NDP_NUMERIC_RANGES.INC'
C   INCLUDE 'DCV_FUN'
C
C
C   Extensions to FORTRAN 77
C   ------------------------
C   DO WHILE / END DO / IMPLICIT NONE / INCLUDE / Names > 6 characters
C                       
C
C   Possible future upgrades
C   ------------------------
C   - Display adjacent pixel values for dimensionalities > 3 ?
C
C
C   Author/s
C   --------
C   Nick Fuller  RGO  (RGVAD::NMJF or NMJF@UK.AC.RGO.STAR)
C   Chris Benn   RGO  (RGVAD::CRB or CRB@UK.AC.RGO.STAR)
C   Julian Gold  RGO  (CAVAD::GOLDJIL or GOLDJIL@UK.AC.CAM.AST-STAR)
C      
C   History
C   -------
C   01-FEB-1989  - Original program
C   07-Oct-1991  - Quality arrays now processed (GOLDJIL)
C   03-DEC-1992  - Unix version (GOLDJIL)
C   06-OCT-1994  - Removed unused variables. (GJP)
C
1 plots
  Displays spectra extracted from a ZXY-sorted SLDC. A range of XY
  coordinates is indicated with the cursor on a plot of a 2-D image
  (derived from an XY plane of the SLDC). All the spectra extracted
  within the range are displayed together on a single plot.
  Optional hardcopy and output of spectra to data structures.
2 IMAGE
   NAME    IM(AGE)
   TYPE    FILE
   OPTIONS INPUT
   PROMPT  "(IMage) Name of 3-D image (ZXY-sorted)"
   TEXT    ----------------------------------------------------------------
           IMAGE is the name of the structure containing the 3-D image to
           be inspected by extracting and displaying spectra. The data 
           array must be ZXY-sorted, i.e. the spectral dimension must be 
           first in the sort order.
           ----------------------------------------------------------------
2 IMAGE1
   NAME    IMAGE1
   TYPE    FILE
   OPTIONS INPUT
   PROMPT  "(IMAGE1) Name of 2-D image to be displayed"
   TEXT    ----------------------------------------------------------------
           IMAGE1 is the name of the structure containing the 2-D image to 
           be displayed. The required rectangular area of extraction from 
           IMAGE will be indicated on it using the cursor or input through 
           the keyboard. IMAGE1 is usually produced by compacting a few XY 
           frames of IMAGE (although any 2-D image with the same X and Y 
           dimensions as IMAGE may be used).
           ----------------------------------------------------------------
2 SCALE
   NAME    SC(ALE)
   TYPE    KEY                                               
   PROMPT  "(SCale) Use a common scale for the spectrum plots?"
   TEXT    ----------------------------------------------------------------
           If SCALE is specified, all the plots of extracted spectra will
           be scaled according to a common data range. This will default 
           to the minimum and maximum of the 3-D image, if this can be 
           obtained from the range structure. Otherwise, each spectrum 
           will be scaled according to its own range.
           ----------------------------------------------------------------
2 SLOW
   NAME    SLO(W)
   TYPE    FLOAT
   PROMPT  "(SLOw) Low value of spectrum plots"
   TEXT    ----------------------------------------------------------------
           SLOW is the low value which will be used for all spectrum plots.
           ----------------------------------------------------------------
                    
2 SHIGH
   NAME    SHI(GH)
   TYPE    FLOAT
   PROMPT  "(SHIgh) High value of spectrum plots"
   TEXT    ----------------------------------------------------------------
           SHIGH is the high value which will be used for all spectrum 
           plots.
           ----------------------------------------------------------------
2 WHOLE
   NAME    WH(OLE)
   TYPE    KEY                                               
   PROMPT  "(WHole) Display the whole 2-D image?"
   TEXT    ----------------------------------------------------------------
           If WHOLE is specified, the entire 2-D image will be displayed.
           Otherwise, a subset of the image may be selected.
           ----------------------------------------------------------------
2 START
   NAME    ST(ART)
   TYPE    FLOAT[6]
   PROMPT  "(STart) Start coordinates of subset."
   TEXT    ----------------------------------------------------------------
           START is an array containing the start coordinate of the subset
           to be displayed in each dimension of the image. The first array
           element is the start coordinate in the first dimension of the 
           current sort order (usually X). Each coordinate must be given 
           in axis units if the relevant axis is calibrated, or in pixels 
           if it is not calibrated or the axis structure is not present.  
           ----------------------------------------------------------------
2 END
   NAME    EN(D)
   TYPE    FLOAT[6]
   PROMPT  "(ENd) End coordinates of subset."
   TEXT    ----------------------------------------------------------------
           END is an array containing the end coordinate of the subset
           to be displayed in each dimension of the image. The first array
           element is the end coordinate in the first dimension of the 
           current sort order (usually X). Each coordinate must be given 
           in axis units if the relevant axis is calibrated, or in pixels 
           if it is not calibrated or the axis structure is not present.  
           ----------------------------------------------------------------
2 LOW
   NAME    LO(W)
   TYPE    FLOAT
   PROMPT  "(LOw) Lowest value to be displayed"
   TEXT    ----------------------------------------------------------------
           Pixels less than or equal to LOW will be plotted in the lowest
           colour index if a colour table is used, or as black if a grey
           scale is used. This convention applies to screen devices, and 
           is reversed on hard copy devices to conserve ink or toner.
           ----------------------------------------------------------------
                    
2 HIGH
   NAME    HI(GH)
   TYPE    FLOAT
   PROMPT  "(HIgh) Highest value to be displayed"
   TEXT    ----------------------------------------------------------------
           Pixels greater than or equal to HIGH will be plotted in the
           highest colour index if a colour table is used, or as white if
           a grey scale is used. This convention applies to screen devices,
           and is reversed on hard copy devices to conserve ink or toner.
           ----------------------------------------------------------------
2 TABLE
   NAME    TAB(LE)
   TYPE    CHAR
   PROMPT  "(TABle) Lookup table for image plot"
   TEXT    ----------------------------------------------------------------
           TABLE is the name of a file containing red, green, and blue
           intensities for each of 256 colour indices. These form a lookup
           table which will be used in the plotting of the 2-D image. The 
           name extension .LUT is assumed, unless TABLE is 'GREY', in
           which case a grey scale will be constructed without using a 
           table file.
           ----------------------------------------------------------------
2 SLABEL
   NAME    SLAB(EL)
   TYPE    CHAR
   PROMPT  "(SLABel) Label for spectrum plots"
   TEXT    ----------------------------------------------------------------
           This character string will be placed below the spectrum plots.
           ----------------------------------------------------------------
2 XPIX
   NAME    XPIX
   TYPE    INT[2]
   PROMPT  "(XPIX) X pixel(s)."
   TEXT    ----------------------------------------------------------------
           XPIX is an array containing the pixel number(s) of the 
           extraction rectangle in the X dimension.
           ----------------------------------------------------------------
2 YPIX
   NAME    YPIX
   TYPE    INT[2]
   PROMPT  "(YPIX) Y pixel(s)."
   TEXT    ----------------------------------------------------------------
           YPIX is an array containing the pixel numbers of the extraction
           rectangle in the Y dimension.
           ----------------------------------------------------------------
2 MAG
   NAME    MAG
   TYPE    FLOAT
   PROMPT  "(MAG) Magnification of image plot"
   TEXT    ----------------------------------------------------------------
           If MAG is 1, the image plot will be fitted to the full display 
           surface. Values less than 1 will reduce both linear dimensions 
           by the same fraction.
           ----------------------------------------------------------------
2 BIN
   NAME    BIN
   TYPE    INT
   PROMPT  "(BIN) Binning interval for averaging of spectra"
   TEXT    ----------------------------------------------------------------
           If BIN is 1, every spectrum within the defined rectangle will
           be plotted individually. If BIN is greater than 1, the spectra
           will be averaged at this interval, and one plot will be 
           produced for each average. Only complete intervals will be 
           averaged and plotted, i.e. partial bins at the edges of the 
           defined rectangle will be ignored.
           ----------------------------------------------------------------
2 AXES
   NAME    AX(ES)
   TYPE    KEY                                               
   PROMPT  "(AXes) Plot spectra with axes and labels?"
   TEXT    ----------------------------------------------------------------
           If AXES is specified, annotated axes and a label consisting of 
           the XY pixel coordinate range will be plotted for each spectrum.
           Otherwise, the spectra will appear in plain boxes.
           ----------------------------------------------------------------
2 WRITE
   NAME    WR(ITE)
   TYPE    KEY                                               
   PROMPT  "(WRite) Write extracted spectra to data structures?"
   TEXT    ----------------------------------------------------------------
           If WRITE is specified, each extracted spectrum will be written
           to a data structure named via SPECTRUM.
           ----------------------------------------------------------------
2 SPECTRUM
   NAME    SP(ECTRUM)
   TYPE    CHAR
   PROMPT  "(SPectrum) Name of structure to contain spectrum"
   TEXT    ----------------------------------------------------------------
           SPECTRUM is the name of the structure which will contain the
           extracted spectrum.
           ----------------------------------------------------------------
2 SOURCE_COMMENTS
C+
C
C   ---------
C   P L O T S
C   ---------
C
C   Description
C   -----------
C   Displays spectra extracted from the first (spectral) dimension of a
C   ZXY-sorted 3-D image.
C
C
C   Scope of program
C   ----------------
C   - The image from which spectra are extracted must be 3-D and the
C     image used as a map must be 2-D.
C   - Data array types SHORT and FLOAT supported; others converted to FLOAT.
C   - Subsetting supported for the 2-D image.
C   - Magic values supported for the 3-D image.
C   - Quality and variance arrays not supported.
C   - Batch execution not supported.
C
C
C   Environment
C   -----------
C   FIGARO
C
C
C   Parameters (read or written)
C   ----------------------------
C
C   The following are prompted for in the preamble before the main menu:
C
C   IMAGE     Name of the structure containing the 3-D image from which
C             spectra are extracted. (character)(prompted for).
C
C   IMAGE1    Name of the structure containing the 2-D image to be used as
C             a map. (character)(prompted for).
C
C   SLOW      Lowest value which will be plotted in the spectra extracted
C             from the 3-D image (real)(prompted for).
C
C   SHIGH     Highest value which will be plotted in the spectra extracted
C             from the 3-D image (real)(prompted for).
C
C   START     Start coordinate in each dimension of the 2-D image subset to
C             be displayed. (real, array)(prompted for).
C
C   END       End coordinate in each dimension of the 2-D image subset to
C             be displayed. (real, array)(prompted for).
C
C   LOW       Value in the 2-D compacted image which is plotted in the
C             lowest colour index or as black. (real)(prompted for).
C
C   HIGH      Value in the 2-D compacted image which is plotted in the
C             highest colour index or as white. (real)(prompted for).
C
C   TABLE     Name of the lookup table. (character)(prompted for).
C
C   SLABEL    Text string placed below the spectrum plots. (character)
C             (prompted for).
C
C   The following are prompted for when main menu options are selected:
C
C   MAG       Magnification of the image plot relative to the full display
C             surface. (real)(prompted for).
C
C   XPIX      Pixel number in the X dimension of each point of extraction.
C             (integer, array)(prompted for).
C
C   YPIX      Pixel number in the Y dimension of each point of extraction.
C             (integer, array)(prompted for).
C
C   BIN       Binning interval used for averaging the spectra within a
C             defined rectangle. (integer)(prompted for).
C
C   SPECTRUM  Name of the structure to which an extracted spectrum is to be
C             written. (character)(prompted for).
C
C   SOFTDEV   Current screen device name. (character)(read from file).
C
C   HARDDEV   Current hardcopy device name. (character)(read from file).
C
C
C   Keywords
C   --------
C   SCALE     Instructs the program to scale all the plots of extracted
C             spectra according to a supplied data range. Otherwise, each
C             plot will be scaled according to its own range.
C
C   WHOLE     Instructs the program to display the whole 2-D image.
C             Otherwise, a subset of the image may be selected.
C
C   AXES      Instructs the program to plot axes and a label for each
C             spectrum. Otherwise, each spectrum will appear in a plain box.
C
C   WRITE     Instructs the program to write each extracted spectrum to a
C             data structure.
C
C
C   Propagation of data structure
C   -----------------------------
C   Not relevant.
C
C
C   Method
C   ------
C   - A 2-D image, which is usually produced by compacting the 3-D image in
C     the Z direction (although any image with the same X and Y dimensions
C     as the 3-D image may be used), or a subset thereof, is plotted in
C     colour or grey scale, depending on TABLE, on the current SOFT device.
C     The data range is selected via LOW and HIGH. The magnification of the
C     plot relative to the full display surface may be selected via MAG.
C   - The image plot is used as a map for selecting the locations of the
C     spectra to be extracted from the ZXY-sorted 3-D image. Two cursor
C     points are indicated on the plot, at the diagonal corners of a
C     rectangle. The points may also be entered through the keyboard. The
C     coordinates of the points are used to address the second and third
C     dimensions of the 3-D image, so that spectra are extracted within
C     the rectangle, being averaged at the binning interval BIN. The average
C     spectrum in one bin is displayed as one plot. If SCALE is true, all
C     the spectra are plotted at the same vertical scale, defined by SLOW
C     and SHIGH. Otherwise each is scaled according to its own data range.
C   - The spectrum plots are all displayed together in a rectangular array,
C     using the multiple virtual device feature of PGPLOT. The number of
C     plots in each dimension of the display is determined by the size of
C     the rectangle selected and by BIN. If a magic value pixel is found in
C     a spectrum, the line string is broken at that point. If the keyword
C     WRITE is true, each spectrum is written to a data structure named via
C     SPECTRUM and the current plot number.
C   - A hard copy of the spectrum plots may be produced. The spectra defined
C     by the most recent pair of points or single point are plotted on the
C     current HARD device.
C
C
C   External functions & subroutines called
C   ---------------------------------------
C   Library DSA:
C     DSA_CLOSE
C     DSA_CLOSE_STRUCTURE
C     DSA_CREATE_STRUCTURE
C     DSA_DATA_SIZE
C     DSA_GET_RANGE
C     DSA_GET_WORKSPACE
C     DSA_INPUT
C     DSA_MAP_AXIS_DATA
C     DSA_MAP_DATA
C     DSA_MAP_QUALITY
C     DSA_OPEN
C     DSA_SEEK_RANGE
C     DSA_SPECIFIC_STRUCTURE
C     DSA_TYPESIZE
C     DSA_UNMAP
C     DSA_USE_FLAGGED_VALUES
C     DSA_USE_QUALITY
C     DSA_WRUSER
C
C   Library DTA:
C     DTA_CRNAM
C     DTA_CRVAR
C     DTA_WRVARC
C     DTA_WRVARI
C
C   Library DYN:
C     DYN_ELEMENT
C
C   Library FIG:
C     FIG_HELP
C
C   Library GEN:
C     GEN_MOVE
C     GEN_RANGEF
C
C   Library ICH:
C     ICH_CI
C     ICH_ENCODE
C     ICH_FOLD
C     ICH_KEY
C     ICH_LEN
C
C   Library NDP:
C     NDP_ADD
C     NDP_AXIS_RANGE
C     NDP_GET_IMAGE_INFO
C     NDP_IMAGE_CURSOR
C     NDP_IMAGE_INDEX
C     NDP_IMAGE_LUT
C     NDP_IMAGE_PLOT
C     NDP_IMAGE_VIEWPORT
C     NDP_MATCH_SIZES
C     NDP_PAR_RDARY
C     NDP_PGBIN
C     NDP_RANGE
C     NDP_SET_BAD_PIXEL
C
C   Library PAR:
C     PAR_CNPAR
C     PAR_RDCHAR
C     PAR_RDKEY
C     PAR_RDUSER
C     PAR_RDVAL
C
C   Library VAR:
C     VAR_GETCHR
C     VAR_GETNUM
C
C   Starlink PGPLOT:
C     PGASK
C     PGADVANCE
C     PGBEGIN
C     PGBOX
C     PGDRAW
C     PGEND
C     PGLABEL
C     PGMOVE
C     PGSLW
C     PGVSIZE
C     PGWINDOW
C
C
C   Internal subroutines called
C   ---------------------------
C   GET_POLYGON_MASK
C   MAGIC_ZAP
C   PLOTS_SELECT
C   PLOTS_SPLOT_W
C   PLOTS_SPLOT_WQ
C   PLOTS_SPLOT_R
C   PLOTS_SPLOT_RQ
C   PLOTS_WRITE
C
C
C   INCLUDE statements
C   ------------------
C   INCLUDE 'DYN_SOURCE:DYNAMIC_MEMORY.INC'
C   INCLUDE 'NDP_SOURCE:NDP_MAGIC_VALUES.INC'
C   INCLUDE 'NDP_SOURCE:NDP_NUMERIC_RANGES.INC'
C
C
C   Extensions to FORTRAN77
C   -----------------------
C   DO WHILE / END DO / IMPLICIT NONE / INCLUDE / Names > 6 characters
C
C
C   Possible future upgrades
C   ------------------------
C   - Batch version of program, with pixel numbers input and hardcopy
C     output.
C   - Use a build file instead of direct hardcopy. This would make the
C     hardcopy option much faster, but would require major modifications
C     to the DSK_ system common blocks so as to enable multiple plot
C     divisions.
C
C
C   Author/s
C   --------
C   Nick Fuller  RGO  (RGVAD::NMJF or NMJF@UK.AC.RGO.STAR)
C   Jim Lewis    RGO  (CAVAD::JRL or JRL@UK.AC.CAM.AST-STAR)
C   Julian Gold  RGO  (CAVAD::GOLDJIL or GOLDJIL@UK.AC.CAM.AST-STAR)
C
C   History
C   -------
C   01-FEB-1989   - Original program
C   21-MAR-1989   - Corrected bug which produced hardcopy instead of screen
C                   plot.
C   14-JUN-1990   - Parameters in call to NDP_IMAGE_PLOT changed.  Also replaced
C                   NDP_IMAGE_LUT with IMAGE_LUT as a temporary measure since 
C                   the former no longer works.  Also fixed arguments in 
C                   subroutine calls so that arrays aren't dimensioned with
C                   elements of other array.
C   29-AUG-1990   - New version of NDP_IMAGE_LUT added in. (JRL)
C   18-SEP-1990   - The program now deals with magic values in the 2-d array by
C                   replacing the flagged pixels with a value which is below
C                   the lower threshold for the plot.  To do this a quality 
C                   array is used so that it can be remembered which elements 
C                   were magic if the user decides to change the plot limits.
C                   Formerly the values were all replaced by zeros which won't 
C                   do if there is data with a value less than zero (which 
C                   is always possible). The data were also changed straight 
C                   into the mapped array, which then changed the values in 
C                   the disk file if the array was mapped and not type 
C                   converted.  Using a copy of the data array in such a case
C                   solves the problem.  (JRL)
C   20-NOV-1991   - Now accepts polygonal regions to average spectra over.
C                   (GOLDJIL)
C   10-MAR-1992   - PGPLOT common block removed. (GOLDJIL)
C   24-MAR-1992   - The output spectra are now written to sequential files
C                   with names given by appending the spectrum number to
C                   the parameter name. Eg PLOT1.DST, PLOT2.DST etc. The
C                   output contains extra header information to locate the
C                   spectrum:
C                     FILE {
C                       .PLOTS
C                         .X    INT    x-coord of extraction
C                         .Y    INT    y-coord of extraction
C                         .BIN  INT    bin size
C                         .MODE STRING Either 'rectangle' or 'polygon'
C                      .
C                      .
C                      .
C                    }
C                    In addition, a file FILE_DAT.DST is created containing
C                    common information about the extraction, such as the
C                    polygon mask (if polygonal extraction was performed) or
C                    the size of the rectangle (if rectangular extraction was
C                    performed). (GOLDJIL)
C   03-DEC-1992    - Unix version (GOLDJIL)
C   06-OCT-1994    - Removed lots of unused variables. (GJP)
C
C
1 setaxes
  Re-calibrates one or more of the axes of an image.
2 IMAGE
   NAME    IM(AGE)
   TYPE    FILE
   OPTIONS INPUT
   PROMPT  "(IMage) Name of input image"
   TEXT    ----------------------------------------------------------------
           IMAGE is the name of the structure containing the axis or axes 
           to be modified. The image may have from one to six dimensions.
           ----------------------------------------------------------------
2 OUTPUT
   NAME    OUT(PUT)
   TYPE    FILE
   OPTIONS OUTPUT
   PROMPT  "(OUTput) Name of output image"
   TEXT    ----------------------------------------------------------------
           OUTPUT is the name of the structure which will contain the
           output image. Important note: if OUTPUT already exists, the
           most recent version will be overwritten. This also applies if 
           OUTPUT is the same as IMAGE - the most recent version of IMAGE
           will be overwritten.
           ----------------------------------------------------------------
2 AXKEY
   NAME    AXKEY
   TYPE    INT[6]
   PROMPT  "(AXKEY) Keys for axes to be calibrated."
   TEXT    ----------------------------------------------------------------
           AXKEY is an array containing the instruction to leave alone or
           calibrate each axis. 0 = leave alone, 1 = calibrate. 
           ----------------------------------------------------------------
2 AXSTART
   NAME    AXST(ART)
   TYPE    FLOAT[6]
   PROMPT  "(AXSTart) Start values of axes."
   TEXT    ----------------------------------------------------------------
           AXSTART is an array containing the start calibration value of 
           each axis. The first array element is the start value of the
           first axis.
           ----------------------------------------------------------------
2 AXEND
   NAME    AXEN(D)
   TYPE    FLOAT[6]
   PROMPT  "(AXENd) End values of axes."
   TEXT    ----------------------------------------------------------------
           AXEND is an array containing the end calibration value of each 
           axis. The first array element is the end value of the first
           axis.
           ----------------------------------------------------------------
2 AXLOG
   NAME    AXLOG
   TYPE    INT[6]
   PROMPT  "(AXLOG) Keys for logarithmic scaling."
   TEXT    ----------------------------------------------------------------
           AXLOG is an array containing the instruction for linear or log-
           arithmic calibration of each axis. 0 = linear, 1 = logarithmic. 
           ----------------------------------------------------------------
2 SOURCE_COMMENTS
C+
C
C   -------------
C   S E T A X E S
C   -------------
C
C   Description:
C   ------------
C   Modifies one or more of the axis structures in an image structure.
C
C
C   Scope of program:
C   -----------------
C   - Images of up to six dimensions accepted.
C   - Data array types not relevant.
C   - Subsetting not relevant.
C   - Magic values not relevant.
C   - Quality, variance, and error arrays not relevant.
C   - Batch execution supported.
C
C
C   Environment:
C   ------------
C   FIGARO
C
C
C   Parameters (read or written):
C   -----------------------------
C   IMAGE   Name of the structure containing the axes to be modified.
C           (character)(prompted for).
C
C   OUTPUT  Name of the structure containing the output image. May be the 
C           same as IMAGE. (character)(prompted for).
C
C   AXKEY   Key to axes to be modified. (integer, array)(prompted for).
C
C   AXSTART Start calibration value for each axis. (real, array)
C           (prompted for). 
C
C   AXEND   End calibration value for each axis. (real, array)
C           (prompted for). 
C
C   AXLOG   Logarithmic flag for each axis. (integer, array)(prompted for).
C
C
C   Keywords:
C   ---------
C   None.
C
C
C   Propagation of data structure:
C   ------------------------------
C   - All standard objects are copied from IMAGE.
C   - One of the axis structures is modified.
C
C
C   Method:
C   -------
C   - If OUTPUT is the same as IMAGE, the IMAGE structure is modified in 
C     situ, i.e. a new version of the container file is not created.
C   - NDP_SET_AXES prompts for the axes to be modified, and fills each with
C     a linear or logarithmic scale between the required limits. A flag is
C     set in the axis structure if the scale is logarithmic.
C
C
C   External functions & subroutines called:
C   ----------------------------------------
C   Library DSA 
C      DSA_CLOSE
C      DSA_INPUT
C      DSA_DATA_SIZE
C      DSA_MAP_AXIS_DATA
C      DSA_OPEN
C      DSA_OUTPUT
C
C   Library NDP
C      NDP_SET_AXES
C
C
C   Internal subroutines called:
C   ----------------------------
C   None.
C
C
C   INCLUDE statements:
C   -------------------
C   INCLUDE 'DYN_SOURCE:DYNAMIC_MEMORY.INC'
C                                             
C
C   Extensions to FORTRAN 77:
C   -------------------------
C   IMPLICIT NONE / Names > 6 characters
C
C
C   Possible future upgrades:
C   -------------------------
C
C
C   Author/s:
C   ---------
C   Nick Fuller  RGO  (RGVAD::NMJF or NMJF@UK.AC.RGO.STAR)
C
C
C   History:
C   --------
C   01-FEB-1988   - Original program
C   04-DEC-1992   - Unix version (GOLDJIL)
C
C
1 slice3d
  Takes a 3-D data cube and allows the user to extract any rectangular
  subset from it. It has a simple, interactive graphical interface to allow
  choice of the extraction plane. The extracted subset can then be written 
  to a new structure.
2 IMAGE
   NAME    IM(AGE)
   TYPE    FILE
   OPTIONS INPUT
   PROMPT  "(IMage) Name of image to be displayed"
   TEXT    ----------------------------------------------------------------
           IMAGE is the name of the structure containing the image to be 
           displayed. The image must be 2-D.
           ----------------------------------------------------------------
2 OUTPUT
   NAME    OUT(PUT)
   TYPE    FILE
   OPTIONS OUTPUT
   PROMPT  "(OUTput) Name of file to save slice to"
   TEXT    ---------------------------------------------------------------
           If you specify the WRITE keyword, then the current slice will
           be written to a file. OUTPUT specifies the name of that file.
           ---------------------------------------------------------------
2 LOW
   NAME    LO(W)
   TYPE    FLOAT
   PROMPT  "(LOw) Lowest value to be displayed"
   TEXT    ----------------------------------------------------------------
           Pixels less than or equal to LOW will be plotted in the lowest
           colour index if a colour table is used, or as black if a grey
           scale is used. This convention applies to screen devices, and 
           is reversed on hard copy devices to conserve ink or toner.
           ----------------------------------------------------------------
                    
2 HIGH
   NAME    HI(GH)
   TYPE    FLOAT
   PROMPT  "(HIgh) Highest value to be displayed"
   TEXT    ----------------------------------------------------------------
           Pixels greater than or equal to HIGH will be plotted in the
           highest colour index if a colour table is used, or as white if 
           a grey scale is used. This convention applies to screen devices,
           and is reversed on hard copy devices to conserve ink or toner.
           ----------------------------------------------------------------
2 PLACE
   NAME    PLACE
   TYPE    CHAR
   PROMPT  "(PLACE) Location of plot"
   TEXT    ----------------------------------------------------------------
           PLACE controls the location of the image on the screen or page. 
           Options are 'BL','BC','BR','LC','CC','RC','TL','TC', and 'TR'.
           ----------------------------------------------------------------
2 MAG
   NAME    MAG
   TYPE    FLOAT
   PROMPT  "(MAG) Magnification of plot"
   TEXT    ----------------------------------------------------------------
           If MAG is 1, the image plot will be fitted to the full display 
           surface. Values less than 1 will reduce both linear dimensions 
           by the same fraction.
           ----------------------------------------------------------------
2 AXES
   NAME    AX(ES)
   TYPE    KEY
   PROMPT  "(AXes) Plot image axes?"
   TEXT    ----------------------------------------------------------------
           If AXES is specified, calibrated axes will be plotted around
           the image. Otherwise, the image will be plotted in a plain box.
           ----------------------------------------------------------------
2 RAMP
   NAME    RAMP
   TYPE    KEY
   PROMPT  "(RAMP) Plot colour or grey scale ramp?"
   TEXT    ----------------------------------------------------------------
           If RAMP is specified, the colour or grey scale, calibrated in 
           image data units, will be plotted to the right of the image.
           ----------------------------------------------------------------
2 TABLE
   NAME    TAB(LE)
   TYPE    CHAR
   PROMPT  "(TABle) Name of lookup table"
   TEXT    ----------------------------------------------------------------
           TABLE is the name of a file containing red, green, and blue
           intensities for each of 256 colour indices. These form a colour
           table which will be used in the plotting of the 2-D image. The 
           name extension .LUT is assumed, unless TABLE is 'GREY', in 
           which case a grey scale will be constructed without using a 
           table file.
           ----------------------------------------------------------------
2 ERASE
   NAME    ER(ASE)
   TYPE    KEY
   PROMPT  "(ERase) Erase screen before plotting?"
   TEXT    ----------------------------------------------------------------
           If ERASE is specified, the screen will be cleared before the 
           plot is displayed. Otherwise, the current screen display will
           remain. This feature may be used to display several images in
           different areas of the screen.
           ----------------------------------------------------------------
2 WRITE
   NAME    WRITE
   TYPE    KEY
   PROMPT  "(WRITE) Write slice to a file?"
   TEXT    ---------------------------------------------------------------
           Specifying YES for WRITE will allow you to save the current 
           slice in a file.
           ---------------------------------------------------------------
2 VIEW
   NAME    VIEW
   TYPE    FLOAT
   PROMPT  "(VIEW) Which axis will you view the cube along?"
   TEXT    ---------------------------------------------------------------
           SLICE allows you to view your datacube along any of the three
           axes. VIEW selects which axis to look along. Specify 1,2 or 3.
           The cube will be temporarily collapsed along that axis.
           ---------------------------------------------------------------
2 ACTION
   NAME    ACTION
   TYPE    CHAR
   PROMPT  "(T)ry again or (Q)uit?"
   TEXT    ---------------------------------------------------------------
           Entering 'T' will allow you to slice the original cube again.
           Entering 'Q' will exit the program.
           ---------------------------------------------------------------
2 VERBOSE
   NAME    VERB(OSE)
   TYPE    KEY
   OPTIONS NOPROMPT
   TEXT    ---------------------------------------------------------------
           Specifying this keyword on the command line results in progress
           messages being written to the terminal.
           ---------------------------------------------------------------
   
2 SOURCE_COMMENTS
C+
C
C   -------------
C   S L I C E 3 D
C   -------------   
C
C   Description
C   -----------
C   SLICE3D will take a 3-D datacube and extract/display any rectangular subset
C   thereof. It has a simple graphic interface to simplify the choice of
C   extraction plane. The extracted data (plus quality and errors) can be
C   optionally written to a new structure.
C
C   Scope of program
C   ----------------
C   - Handles 3-D images only.
C   - Data array types SHORT and FLOAT supported - others mapped to FLOAT.
C   - Subsetting irrelevant.
C   - Magic values, error and quality arrays supported.
C
C
C   Environment
C   -----------
C   FIGARO
C
C
C   Parameters (read or written)
C   ----------------------------
C   IMAGE    Name of the structure containing the image to be displayed. 
C            (character)(prompted for).
C
C   OUTPUT   Name of file the slice is to be written to. (character)
C
C   LOW      Data value which is plotted in the lowest colour index or as 
C            black. (real)(prompted for). 
C
C   HIGH     Data value which is plotted in the highest colour index or as
C            white. (real)(prompted for). 
C
C   PLACE    Code for one of nine possible locations on the display surface,
C            being a combination of T, C, or B, and L, C, or R. (character)
C            (prompted for).
C
C   MAG      Magnification of the plot. Magnification 1 fits the plot to the
C            whole display surface. (real)(prompted for).
C
C   TABLE    Name of colour or grey scale lookup table. (character)
C            (prompted for).      
C            
C   SOFTDEV  Current screen device name (character)(read from file).
C
C   VIEW     Axis to view cube along. (integer)
C
C   ACTION   Allows user to try another slice or exit at will (character).
C
C   Keywords
C   --------
C   AXES     Instruction to plot calibrated axes. Otherwise, the image is
C            framed with a plain box.
C   RAMP     Instruction to plot a calibrated bar of the colour or grey 
C            scale to the right of the image.
C
C   ERASE    Instruction to erase screen before plotting. 
C
C   VERBOSE  Make the program garrulous in the extreme. (Hidden)
C
C   WRITE    Instruction to write the slice to disk.
C
C   Propagation of data structure
C   -----------------------------
C   Not relevant.
C
C
C   Method
C   ------
C   - The program obtains the name of an image. This MUST be a 3D image.
C   - Information about data type, error arrays etc is obtained.
C   - The view axis is obtained from the user. The cube is then collapsed
C     (summed) over that axis.
C   - The collapsed cube is then plotted. The plotting is handled similarly
C     to (cf) DEPICT.
C   - The user can then select 2 points using the cursor which define the 
C     slice.
C   - The display is cleared and the slice is plotted.
C   - If the user is happy with this, he/she can save the slice to a file.
C   - The user then has the option of quitting or slicing again. If the
C     latter, all output and slice arrays are unmapped.
C
C   External functions & subroutines called
C   ---------------------------------------
C   Library DSA:
C     DSA_CLOSE
C     DSA_DATA_SIZE
C     DSA_FREE_WORKSPACE
C     DSA_GET_WORKSPACE
C     DSA_GET_WORK_ARRAY
C     DSA_INPUT
C     DSA_MAP_DATA
C     DSA_MAP_ERRORS
C     DSA_MAP_QUALITY
C     DSA_OPEN
C     DSA_TYPESIZE
C     DSA_SEEK_ERRORS
C     DSA_SEEK_QUALITY
C     DSA_UNMAP
C     DSA_USE_FLAGGED_VALUES
C     DSA_WRUSER
C
C   Library DYN:
C     DYN_ELEMENT
C
C   Library GEN:
C     GEN_ELEMF
C     GEN_MOVE
C
C   Library ICH:
C     ICH_CI
C     ICH_FOLD
C     ICH_LEN
C
C   Library NDP:
C     NDP_GET_IMAGE_INFO
C     NDP_IMAGE_INDEX
C     NDP_IMAGE_LUT
C     NDP_IMAGE_PLOT
C     NDP_IMAGE_VIEWPORT
C
C   Library PAR:
C     PAR_CNPAR
C     PAR_RDCHAR
C     PAR_RDKEY
C     PAR_RDVAL
C     
C   Library VAR:
C     VAR_GETCHR
C
C   Starlink PGPLOT:
C     PGADVANCE
C     PGBEGIN
C     PGCONT
C     PGEND
C     PGPOINT
C     PGVSIZE
C     PGWINDOW
C
C
C   Internal subroutines called
C   ---------------------------
C   CRUSH_AXIS1
C   CRUSH_AXIS2
C   CRUSH_AXIS3
C   CRUSH_AXIS1Q
C   CRUSH_AXIS2Q
C   CRUSH_AXIS3Q
C   SLICE_AXIS1
C   SLICE_AXIS2
C   SLICE_AXIS3
C   SLICE_COPY_W
C   SLICE_COPY_R
C
C   INCLUDE statements
C   ------------------
C   INCLUDE 'DYN_SOURCE:DYNAMIC_MEMORY.INC'
C   INCLUDE 'NDP_SOURCE:NDP_NUMERIC_RANGES.INC'
C   INCLUDE 'NDP_SOURCE:NDP_MAGIC_VALUES.INC'
C                                                
C
C   Extensions to FORTRAN77
C   -----------------------                           
C   END DO / IMPLICIT NONE / INCLUDE / Names > 6 characters  / WHILE
C
C                           
C   Possible future upgrades
C   ------------------------
C   Have the slice and original view displayed simultaneously.
C
C   Author/s
C   --------
C   Julian Gold  RGO  (CAVAD::GOLDJIL or GOLDJIL@UK.AC.CAM.AST-STAR)
C
C
C   History
C   -------
C   22-JUN-1992   - Original program (GOLDJIL)
C   04-DEC-1992   - Unix version.
C   06-OCT-1994   - Removed lots of unused variables. (GJP)
C
1 smooth
  Smooths an image or image subset in 1, 2 or 3 diemnsions by
  convolution with a top hat, Gaussian, or sinc function.
  Also has the Moffat function for 1-D images. Currently only
  handles 1,2 or 3-D data only.
2 IMAGE
   NAME    IM(AGE)
   TYPE    FILE
   OPTIONS INPUT
   PROMPT  "(IMage) Name of input image"
   TEXT    ----------------------------------------------------------------
           IMAGE is the name of the structure containing the image to be 
           smoothed by convolution with a top hat, Gaussian, or sinc
           function. The image may have from one to six dimensions, but 
           the maximum dimensionality of the smoothing functions is three.
           ----------------------------------------------------------------
2 WHOLE
   NAME    WH(OLE)
   TYPE    KEY                                               
   PROMPT  "(WHole) Process the whole image?"
   TEXT    ----------------------------------------------------------------
           If WHOLE is specified, the entire area of the image will be 
           processed. Otherwise, a subset of the image may be selected.
           ----------------------------------------------------------------
2 START
   NAME    ST(ART)
   TYPE    FLOAT[6]
   PROMPT  "(STart) Start coordinates of subset."
   TEXT    ----------------------------------------------------------------
           START is an array containing the start coordinate of the subset
           to be processed in each dimension of the image. The first array
           element is the start coordinate in the first dimension of the 
           current sort order (usually X). Each coordinate must be given 
           in axis units if the relevant axis is calibrated, or in pixels 
           if it is not calibrated or the axis structure is not present.  
           ----------------------------------------------------------------
2 END
   NAME    EN(D)
   TYPE    FLOAT[6]
   PROMPT  "(ENd) End coordinates of subset."
   TEXT    ----------------------------------------------------------------
           END is an array containing the end coordinate of the subset
           to be processed in each dimension of the image. The first array
           element is the end coordinate in the first dimension of the 
           current sort order (usually X). Each coordinate must be given 
           in axis units if the relevant axis is calibrated, or in pixels 
           if it is not calibrated or the axis structure is not present.  
           ----------------------------------------------------------------
2 SMOOTH
   NAME    SMOOTH
   TYPE    INT
   PROMPT  "(SMOOTH) Smoothing function"
   TEXT    ----------------------------------------------------------------
           SMOOTH is the number of the required smoothing function:
           1 = top hat
           2 = Gaussian
           3 = sinc
           4 = Moffat (1D only)
           ----------------------------------------------------------------
2 FNDIM
   NAME    FNDIM
   TYPE    INT
   PROMPT  "(FNDIM) No. of dims in smoothing function"
   TEXT    ----------------------------------------------------------------
           FNDIM is the number of dimensions in the smoothing function. It
           may be less than or equal to the number of dimensions in the
           image, up to a maximum of three.
           ----------------------------------------------------------------
2 BOX
   NAME    BOX
   TYPE    INT
   PROMPT  "(BOX) Size of function box in pixels"
   TEXT    ----------------------------------------------------------------
           BOX is the size of the smoothing function box. All dimensions
           will be the same size. It must be an odd number, at least 3 and
           no more than the smallest dimension of the image.
           ----------------------------------------------------------------
2 WIDTHS
   NAME    WIDTHS
   TYPE    FLOAT[3]
   PROMPT  "(WIDTHS) Width of function in each dim."
   TEXT    ----------------------------------------------------------------
           WIDTHS is an array containing the width of the function in each
           of its dimensions. This is the sigma of a Gaussian function or 
           the constant k in the sinc function sin(kx)/kx.
           ----------------------------------------------------------------
                                             
2 OUTPUT
   NAME    OUT(PUT)
   TYPE    FILE
   OPTIONS OUTPUT
   PROMPT  "(OUTput) Name of output image"
   TEXT    ----------------------------------------------------------------
           OUTPUT is the name of the structure which will contain the
           output image. If OUTPUT already exists, a new version will be 
           created. If OUTPUT is the same as IMAGE, a new version of IMAGE
           will be created.
           ----------------------------------------------------------------
2 SOURCE_COMMENTS
C+
C
C   -----------
C   S M O O T H
C   -----------
C
C   Description
C   -----------
C   Smooths an image in one, two, or three dimensions by convolution
C   with a top hat, Gaussian, or sinc function. 
C
C
C   Scope of program
C   ----------------
C   - Images of up to six dimensions accepted.
C   - Data array types SHORT and FLOAT supported; others converted to FLOAT.
C   - Subsetting supported.
C   - Magic values supported.
C   - Quality and variance arrays supported.
C   - Batch execution supported.
C
C
C   Environment
C   -----------
C   FIGARO
C
C
C   Parameters (read or written)
C   ----------------------------
C   IMAGE   Name of the structure containing the image to be smoothed.
C           (character)(prompted for).
C
C   START   Coordinate in each dimension of IMAGE at which the smooth
C           operation is to start. (real, array)(prompted for).
C
C   END     Coordinate in each dimension of IMAGE at which the smooth
C           operation is to end. (real, array)(prompted for).
C
C   SMOOTH  Smoothing function. (integer)(prompted for).  
C           1 = top hat
C           2 = Gaussian
C           3 = sinc
C
C   FNDIM   Number of dimensions in the smoothing function, less than or
C           equal to the number in the image, up to a maximum of three.
C           (integer)(prompted for).
C
C   BOX     Size of the function box in pixels. (integer)(prompted for).
C
C   WIDTHS  Width of the function in each dimension. This is either the sigma
C           in a Gaussian function, or the constant k in the sinc function
C           sin(kx)/kx. (real, array)(prompted for).
C
C   OUTPUT  Name of the structure containing the output image. May be the
C           same as IMAGE. (character)(prompted for).
C
C   Keywords
C   --------
C   WHOLE   Instructs the program to smooth the whole image. Otherwise, a
C           subset of the image may be selected.
C
C
C   Propagation of data structure
C   -----------------------------
C   - Principal structure is IMAGE.
C   - All standard objects are copied from IMAGE.
C   - Data array is modified.
C
C
C   Method
C   ------
C   - The IMAGE structure is tested for the bad pixel flag. If it is found
C     and non-zero, magic values are assumed to be present and are left in 
C     the data. Quality and error arrays are tested for.
C   - The dimensionality of the smoothing function may be less than or equal
C     to that of the image unless the image has more than three dimensions,
C     in which case the function has the maximum dimensionality of three.
C   - The size of the smoothing function BOX is restricted to odd numbers in
C     order to simplify the convolution.
C   - If a 3-D smoothing function is to be used, the size of the working 
C     set (WSEXTENT) is tested. If it can accommodate the entire image 
C     there is no problem, but if it cannot accommodate BOX planes it is 
C     too small and will cause excessive page faulting, so the program 
C     terminates. 
C   - The structure IMAGE is copied to OUTPUT.
C   - The smoothing function of the required dimensionality is generated.
C   - A subroutine appropriate to the data type, dimensionality, and
C     presence or absence of magic values is called to convolve the data
C     array with the smoothing function.
C
C
C   External functions & subroutines called
C   ---------------------------------------
C   Library DSA:
C     DSA_CLOSE
C     DSA_INPUT
C     DSA_DATA_SIZE
C     DSA_GET_WORKSPACE
C     DSA_MAP_DATA
C     DSA_OPEN
C     DSA_OUTPUT
C     DSA_TYPESIZE
C     DSA_USE_FLAGGED_VALUES
C     DSA_WRUSER
C
C   Library DYN:
C     DYN_ELEMENT
C
C   Library ICH:
C     ICH_ENCODE
C     ICH_LEN
C
C   Library NDP:
C     NDP_AXIS_RANGE
C     NDP_DISPLAY_PROGRESS
C     NDP_GET_IMAGE_INFO
C     NDP_GETJPI_WSEXTENT
C     NDP_PAR_RDARY
C
C   Library PAR:
C     PAR_CNPAR
C     PAR_RDCHAR
C     PAR_RDKEY
C     PAR_RDVAL
C     
C
C   Internal subroutines called
C   ---------------------------
C   SMOOTH_1DFUNC
C   SMOOTH_1D1D_W
C   SMOOTH_1D1D_WQ
C   SMOOTH_1D1D_R
C   SMOOTH_1D1D_RQ
C   SMOOTH_2DFUNC
C   SMOOTH_2D1D_W
C   SMOOTH_2D1D_WQ
C   SMOOTH_2D1D_R
C   SMOOTH_2D1D_RQ
C   SMOOTH_2D2D_W
C   SMOOTH_2D2D_WQ
C   SMOOTH_2D2D_R
C   SMOOTH_2D2D_RQ
C   SMOOTH_3DFUNC
C   SMOOTH_3D1D_W
C   SMOOTH_3D1D_WQ
C   SMOOTH_3D1D_R
C   SMOOTH_3D1D_RQ
C   SMOOTH_3D2D_W
C   SMOOTH_3D2D_WQ
C   SMOOTH_3D2D_R
C   SMOOTH_3D2D_RQ
C   SMOOTH_3D3D_W
C   SMOOTH_3D3D_WQ
C   SMOOTH_3D3D_R
C   SMOOTH_3D3D_RQ
C
C
C   INCLUDE statements
C   ------------------
C   INCLUDE 'DYN_SOURCE:DYNAMIC_MEMORY.INC'
C   INCLUDE 'NDP_SOURCE:NDP_MAGIC_VALUES.INC'
C   INCLUDE 'NDP_SOURCE:NDP_NUMERIC_RANGES.INC'
C                                             
C
C   Extensions to FORTRAN77
C   -----------------------
C   END DO / IMPLICIT NONE / INCLUDE / Names > 6 characters
C
C
C   Possible future upgrades                 
C   ------------------------
C   - Support higher dimensionalities. Subroutines to be written:
C       SMOOTH_sDFUNC    
C       SMOOTH_nDsD_<T>   n = dimensionality of image
C       SMOOTH_nDsD_IQ    s = dimensionality of smoothing function
C                         and  s .le. n
C
C
C   Author/s
C   --------
C   Nick Fuller  RGO  (RGVAD::NMJF or NMJF@UK.AC.RGO.STAR)
C   Jim Lewis    RGO  (CAVAD::JRL or JRL@UK.AC.CAM.AST-STAR)
C   Julian Gold  RGO  (CAVAD::GOLDJIL or GOLDJIL@UK.AC.CAM.AST-STAR)
C
C
C   History
C   -------                     
C   01-FEB-1989   - Original program
C   03-AUG-1990   - Fixed so that adjustable array sizes are not passed
C                   as elements of another array.  This practice has been
C                   banned by the v5.2 compiler.  (JRL)
C   15-JAN-1991   - Fixed subroutines which generate smoothing functions to
C                   use the correct form for a gaussian. (JRL)
C   22-OCT-1991   - Quality and error arrays implemented, code written in
C                   GENERIC form.
C   07-DEC-1992   - Unix version (GOLDJIL)
C   06-OCT-1994   - Removed lots of unused variables. (GJP)
C
C
1 spectrum
  Display individual spectra extracted from a ZXY sorted SLDC. The XY
  coordinates of the point of extraction are indicated with the cursor on a
  2-D image (derived from an XY plane of the SLDC). The spectra are
  plotted alongside the image; their XY locations are shown with pointer 
  lines. Optional hardcopy and output spectra to data structures.
2 IMAGE
   NAME    IM(AGE)
   TYPE    FILE
   OPTIONS INPUT
   PROMPT  "(IMage) Name of 3-D image (ZXY-sorted)"
   TEXT    ----------------------------------------------------------------
           IMAGE is the name of the structure containing the 3-D image to
           be inspected by extracting and displaying spectra. The data 
           array must be ZXY-sorted, i.e. the spectral dimension must be 
           first in the sort order.
           ----------------------------------------------------------------
2 IMAGE1
   NAME    IMAGE1
   TYPE    FILE
   OPTIONS INPUT
   PROMPT  "(IMAGE1) Name of 2-D image to be displayed"
   TEXT    ----------------------------------------------------------------
           IMAGE1 is the name of the structure containing the 2-D image to 
           be displayed. The required point or rectangle of extraction 
           from IMAGE will be indicated on it using the cursor or input 
           through the keyboard. IMAGE1 is usually produced by compacting
           a few XY frames of IMAGE (although any 2-D image with the same
           X and Y dimensions as IMAGE may be used).
           ----------------------------------------------------------------
2 SCALE
   NAME    SC(ALE)
   TYPE    KEY                                               
   PROMPT  "(SCale) Use a common scale for the spectrum plots?"
   TEXT    ----------------------------------------------------------------
           If SCALE is specified, all the plots of extracted spectra will
           be scaled according to a common data range. This will default 
           to the minimum and maximum of the 3-D image, if this can be 
           obtained from the range structure. Otherwise, each spectrum 
           will be scaled according to its own range.
           ----------------------------------------------------------------
2 SLOW
   NAME    SLO(W)
   TYPE    FLOAT
   PROMPT  "(SLOw) Low value of spectrum plots"
   TEXT    ----------------------------------------------------------------
           SLOW is the low value which will be used for all spectrum plots.
           ----------------------------------------------------------------
                    
2 SHIGH
   NAME    SHI(GH)
   TYPE    FLOAT
   PROMPT  "(SHIgh) High value of spectrum plots"
   TEXT    ----------------------------------------------------------------
           SHIGH is the high value which will be used for all spectrum 
           plots.
           ----------------------------------------------------------------
2 WHOLE
   NAME    WH(OLE)
   TYPE    KEY                                               
   PROMPT  "(WHole) Display the whole 2-D image?"
   TEXT    ----------------------------------------------------------------
           If WHOLE is specified, the entire 2-D image will be displayed.
           Otherwise, a subset of the image may be selected.
           ----------------------------------------------------------------
2 START
   NAME    ST(ART)
   TYPE    FLOAT[6]
   PROMPT  "(STart) Start coordinates of subset."
   TEXT    ----------------------------------------------------------------
           START is an array containing the start coordinate of the subset
           to be displayed in each dimension of the image. The first array
           element is the start coordinate in the first dimension of the 
           current sort order (usually X). Each coordinate must be given 
           in axis units if the relevant axis is calibrated, or in pixels 
           if it is not calibrated or the axis structure is not present.  
           ----------------------------------------------------------------
2 END
   NAME    EN(D)
   TYPE    FLOAT[6]
   PROMPT  "(ENd) End coordinates of subset."
   TEXT    ----------------------------------------------------------------
           END is an array containing the end coordinate of the subset
           to be displayed in each dimension of the image. The first array
           element is the end coordinate in the first dimension of the 
           current sort order (usually X). Each coordinate must be given 
           in axis units if the relevant axis is calibrated, or in pixels 
           if it is not calibrated or the axis structure is not present.  
           ----------------------------------------------------------------
2 LOW
   NAME    LO(W)
   TYPE    FLOAT
   PROMPT  "(LOw) Lowest value to be displayed"
   TEXT    ----------------------------------------------------------------
           Pixels less than or equal to LOW will be plotted in the lowest
           colour index if a colour table is used, or as black if a grey
           scale is used. This convention applies to screen devices, and 
           is reversed on hard copy devices to conserve ink or toner.
           ----------------------------------------------------------------
                    
2 HIGH
   NAME    HI(GH)
   TYPE    FLOAT
   PROMPT  "(HIgh) Highest value to be displayed"
   TEXT    ----------------------------------------------------------------
           Pixels greater than or equal to HIGH will be plotted in the
           highest colour index if a colour table is used, or as white if
           a grey scale is used. This convention applies to screen devices,
           and is reversed on hard copy devices to conserve ink or toner.
           ----------------------------------------------------------------
2 TABLE
   NAME    TAB(LE)
   TYPE    CHAR
   PROMPT  "(TABle) Lookup table for image plot"
   TEXT    ----------------------------------------------------------------
           TABLE is the name of a file containing red, green, and blue
           intensities for each of 256 colour indices. These form a lookup
           table which will be used in the plotting of the 2-D image. The 
           name extension .LUT is assumed, unless TABLE is 'GREY', in 
           which case a grey scale will be constructed without using a 
           table file.
           ----------------------------------------------------------------
2 LABEL
   NAME    LAB(EL)
   TYPE    CHAR
   PROMPT  "(LABel) Label for image plot"
   TEXT    ----------------------------------------------------------------
           This character string will be placed above the image plot.
           ----------------------------------------------------------------
2 SLABEL
   NAME    SLAB(EL)
   TYPE    CHAR
   PROMPT  "(SLABel) Label for spectrum plots"
   TEXT    ----------------------------------------------------------------
           This character string will be placed below the spectrum plots.
           ----------------------------------------------------------------
2 XPIX
   NAME    XPIX
   TYPE    INT[2]
   PROMPT  "(XPIX) X pixel(s), outside to quit."
   TEXT    ----------------------------------------------------------------
           XPIX is an array containing the pixel number(s) of the 
           extraction point or rectangle in the X dimension. If TWOCUR is
           true, two X pixel numbers are required for each extraction. If
           any pixel number is outside the range of displayed pixels, 
           point selection ends. 
           ----------------------------------------------------------------
2 YPIX
   NAME    YPIX
   TYPE    INT[2]
   PROMPT  "(YPIX) Y pixel(s), outside to quit."
   TEXT    ----------------------------------------------------------------
           YPIX is an array containing the pixel number(s) of the 
           extraction point or rectangle in the Y dimension. If TWOCUR is
           true, two Y pixel numbers are required for each extraction. If
           any pixel number is outside the range of displayed pixels, 
           point selection ends.
           ----------------------------------------------------------------
2 MAG
   NAME    MAG                         
   TYPE    FLOAT
   PROMPT  "(MAG) Magnification of image plot"
   TEXT    ----------------------------------------------------------------
           If MAG is 1, the image plot will be fitted to the full display 
           surface. Values less than 1 will reduce both linear dimensions 
           by the same fraction.
           ----------------------------------------------------------------
2 NPLOTS
   NAME    NPLOTS
   TYPE    INT
   PROMPT  "(NPLOTS) Number of spectrum plots"
   TEXT    ----------------------------------------------------------------
           NPLOTS is the number of spectrum plots to be displayed to the 
           right of the image plot. 
           ----------------------------------------------------------------
2 BIN
   NAME    BIN
   TYPE    INT
   PROMPT  "(BIN) Binning interval for averaging of spectra"
   TEXT    ----------------------------------------------------------------
           BIN applies only when TWOCUR is false, i.e. when a single point 
           is used to select each spectrum. If BIN is 1, a single spectrum
           will be extracted at the point. If BIN is greater than 1, it 
           will define a square centred on the point, and the spectra 
           within the square will be averaged. BIN may be odd or even, but
           if it is even, the square will not be exactly centred on the 
           cursor point.
           ----------------------------------------------------------------
2 TWOCUR
   NAME    TWO(CUR)
   TYPE    KEY                                               
   PROMPT  "(TWOCUR) Use two points to select rectangle?"
   TEXT    ----------------------------------------------------------------
           If TWOCUR is specified, two points will be accepted, to define
           a rectangle within which spectra will be extracted and 
           averaged. When TWOCUR is true, BIN is ignored.
           ----------------------------------------------------------------
2 WRITE
   NAME    WR(ITE)
   TYPE    KEY                                               
   PROMPT  "(WRite) Write extracted spectra to data structures?"
   TEXT    ----------------------------------------------------------------
           If WRITE is specified, each extracted spectrum will be written
           to a data structure named via SPECTRUM.
           ----------------------------------------------------------------
2 SPECTRUM
   NAME    SP(ECTRUM)
   TYPE    FILE
   PROMPT  "(SPectrum) Name of file to contain spectrum"
   TEXT    ----------------------------------------------------------------
           SPECTRUM is the name of the file which will contain the
           extracted spectrum's data.
           ----------------------------------------------------------------
2 SOURCE_COMMENTS
C+
C
C   ---------------
C   S P E C T R U M
C   ---------------
C
C   Description
C   -----------
C   Interactive display of spectra extracted from the first (spectral)
C   dimension of a ZXY-sorted 3-D image.
C
C
C   Scope of program
C   ----------------
C   - The image from which spectra are extracted must be 3-D and the
C     image used as a map must be 2-D.
C   - Data array types SHORT and FLOAT supported; others converted to FLOAT.
C   - Subsetting supported for the 2-D image.
C   - Magic values supported for the 3-D image.
C   - Quality and variance arrays not supported.
C   - Batch execution not supported.
C
C
C   Environment
C   -----------
C   FIGARO
C
C
C   Parameters (read or written)
C   ----------------------------
C
C   The following are prompted for in the preamble before the main menu:
C
C   IMAGE     Name of the structure containing the 3-D image from which
C             spectra are extracted. (character)(prompted for).
C
C   IMAGE1    Name of the structure containing the 2-D image to be used as a
C             map. (character)(prompted for).
C
C   SLOW      Lowest value which will be plotted in the spectra extracted
C             from the 3-D image. (real)(prompted for).
C
C   SHIGH     Highest value which will be plotted in the spectra extracted
C             from the 3-D image. (real)(prompted for).
C
C   START     Start coordinate in each dimension of the 2-D image subset to
C             be displayed. (real, array)(prompted for).
C
C   END       End coordinate in each dimension of the 2-D image subset to be
C             displayed. (real, array)(prompted for).
C
C   LOW       Value in the 2-D compacted image which is plotted in the
C             lowest colour index or as black. (real)(prompted for).
C
C   HIGH      Value in the 2-D compacted image which is plotted in the
C             highest colour index or as white. (real)(prompted for).
C
C   TABLE     Name of the lookup table. (character)(prompted for).
C
C   LABEL     Text string placed above the image plot. (character)
C             (prompted for).
C
C   SLABEL    Text string placed below the spectrum plots. (character)
C             (prompted for).
C
C   The following are prompted for when main menu options are selected:
C
C   XPIX      Pixel number in the X dimension of each point of extraction.
C             (integer, array)(prompted for).
C
C   YPIX      Pixel number in the Y dimension of each point of extraction.
C             (integer, array)(prompted for).
C
C   MAG       Magnification of the image plot relative to the full display
C             surface. (real)(prompted for).
C
C   NPLOTS    Number of spectrum plots to be displayed to the right of the
C             image plot. (integer)(prompted for).
C
C   BIN       Side length, in pixels, of a square area around a single point
C             within which spectra will be extracted and averaged. Ignored
C             if TWOCUR is true. (integer)(prompted for).
C
C   SPECTRUM  Name of the structure to which an extracted spectrum is to be
C             written. (character)(prompted for).
C
C   SOFTDEV   Current screen device name. (character)(read from file).
C
C   HARDDEV   Current hardcopy device name. (character)(read from file).
C
C
C   Keywords
C   --------
C   SCALE     Instructs the program to scale all the plots of extracted
C             spectra according to a supplied data range. Otherwise, each
C             plot will be scaled according to its own range.
C
C   WHOLE     Instructs the program to display the whole 2-D image.
C             Otherwise, a subset of the image may be selected.
C
C   TWOCUR    Instructs the program to accept two points to define the area
C             within which spectra will be extracted and averaged. If TWOCUR
C             is true, BIN is ignored.
C
C   WRITE     Instructs the program to write each extracted spectrum to a
C             data structure.
C
C
C   Propagation of data structure
C   -----------------------------
C   Not relevant.
C
C
C   Method
C   ------
C   - A 2-D image, which is usually produced by compacting the 3-D image in
C     the Z direction (although any image with the same X and Y dimensions
C     as the 3-D image may be used), or a subset thereof, is plotted in
C     colour or grey scale, depending on TABLE, on the current SOFT device.
C     The data range is selected via LOW and HIGH. The magnification of the
C     plot relative to the full display surface may be selected via MAG.
C   - The image plot is used as a map for selecting the locations of the
C     spectra to be extracted from the ZXY-sorted 3-D image. Depending on
C     the value of the keyword TWOCUR, either one or two cursor points may
C     indicated on the plot. The points may also be entered through the
C     keyboard. The coordinates of the points are used to address the second
C     and third dimensions of the 3-D image. If TWOCUR is true, two points
C     define a rectangle within which the extracted spectra are averaged. If
C     TWOCUR is false, a single point may address either a single spectrum
C     or the centre of a square of pixels defined by BIN, within which the
C     extracted spectra are averaged. In addition, the user can specify a
c     polygonal region of the image over which to average the spectra.
C   - The spectra are plotted to the right of the image. The number of
C     spectrum plots to be displayed may be selected via NPLOTS. If a
C     further point is selected beyond this number, one of the displayed
C     plots is erased and replaced. If a magic value pixel is encountered in
C     the spectrum array, the line string is broken at that point. If the
C     keyword WRITE is true, each spectrum is written to a data structure
C     named via SPECTRUM. If SCALE is true, all the spectra are plotted at
C     the same vertical scale, defined by SLOW and SHIGH. Otherwise each is
C     scaled according to its own data range.
C   - A hard copy of the image and spectrum plots may be produced. The
C     image defined by LOW, HIGH, and MAG, and the spectra defined by the
C     NPLOTS most recent pairs of points or single points are plotted on the
C     current HARD device.
C
C
C   External functions & subroutines called
C   ---------------------------------------
C   Library DSA:
C     DSA_CLOSE
C     DSA_CLOSE_STRUCTURE
C     DSA_CREATE_STRUCTURE
C     DSA_DATA_SIZE
C     DSA_GET_RANGE
C     DSA_GET_WORKSPACE
C     DSA_INPUT
C     DSA_MAP_AXIS_DATA
C     DSA_MAP_DATA
C     DSA_MAP_QUALITY
C     DSA_OPEN
C     DSA_SEEK_RANGE
C     DSA_SPECIFIC_STRUCTURE
C     DSA_TYPESIZE
C     DSA_UNMAP
C     DSA_USE_FLAGGED_VALUES
C     DSA_USE_QUALITY
C     DSA_WRUSER
C
C   Library DTA:
C     DTA_CRNAM
C     DTA_CRVAR
C     DTA_WRVARC
C     DTA_WRVARI
C
C   Library DYN:
C     DYN_ELEMENT
C
C   Library FIG:
C     FIG_HELP
C
C   Library GEN:
C     GEN_MOVE
C     GEN_RANGEF
C
C   Library ICH:
C     ICH_CI
C     ICH_ENCODE
C     ICH_FOLD
C     ICH_KEY
C     ICH_LEN
C
C   Library NDP:
C     NDP_ADD
C     NDP_AXIS_RANGE
C     NDP_GET_IMAGE_INFO
C     NDP_IMAGE_CURSOR
C     NDP_IMAGE_INDEX
C     NDP_IMAGE_LUT
C     NDP_IMAGE_PLOT
C     NDP_IMAGE_VIEWPORT
C     NDP_MATCH_SIZES
C     NDP_PAR_RDARY
C     NDP_PGBIN
C     NDP_RANGE
C     NDP_SET_BAD_PIXEL
C
C   Library PAR:
C     PAR_CNPAR
C     PAR_RDCHAR
C     PAR_RDKEY
C     PAR_RDUSER
C     PAR_RDVAL
C
C   Library VAR:
C     VAR_GETCHR
C     VAR_GETNUM
C
C   Starlink PGPLOT:
C     PGADVANCE
C     PGASK
C     PGBEGIN
C     PGBOX
C     PGDRAW
C     PGEND
C     PGLABEL
C     PGMOVE
C     PGQVP
C     PGSCI
C     PGSLW
C     PGVSIZE
C     PGVSTAND
C     PGWINDOW
C
C
C   Internal subroutines called
C   ---------------------------
C   MAGIC_ZAP
C   SPECTRUM_HARDCOPY_W
C   SPECTRUM_HARDCOPY_WQ
C   SPECTRUM_HARDCOPY_R
C   SPECTRUM_HARDCOPY_RQ
C   SPECTRUM_SLABEL
C   SPECTRUM_SPLOT_W
C   SPECTRUM_SPLOT_WQ
C   SPECTRUM_SPLOT_R
C   SPECTRUM_SPLOT_RQ
C   SPECTRUM_WRITE
C   GET_POLYGON_MASK
C
C
C   INCLUDE statements
C   ------------------
C   INCLUDE 'DYN_SOURCE:DYNAMIC_MEMORY.INC'
C   INCLUDE 'PGPLOT_DIR:GRECOM.INC'
C   INCLUDE 'NDP_SOURCE:NDP_MAGIC_VALUES.INC'
C   INCLUDE 'NDP_SOURCE:NDP_NUMERIC_RANGES.INC'
C   INCLUDE 'DCV_FUN'
C
C
C   Extensions to FORTRAN77
C   -----------------------
C   DO WHILE / END DO / IMPLICIT NONE / INCLUDE / Names > 6 characters
C
C
C   Possible future upgrades
C   ------------------------
C   - Use a build file instead of direct hardcopy. This would make the
C     hardcopy option much faster, but would require major modifications
C     to the DSK_ system common blocks so as to enable viewport dimensioning
C     via PGQVP and PGVSIZE. The drawing commands PGMOVE, PGDRAW, and PGGRAY
C     would also have to be added.
C   - Improve subroutine structure so that a single routine controls both
C     screen and hardcopy plotting.
C
C
C   Author/s
C   --------
C   Nick Fuller  RGO  (RGVAD::NMJF or NMJF@UK.AC.RGO.STAR)
C   Jim Lewis    RGO  (CAVAD::JRL or JRL@UK.AC.CAM.AST-STAR)
C   Julian Gold  RGO  (CAVAD::GOLDJIL or GOLDJIL@UK.AC.CAM.AST-STAR
C
C
C   History
C   -------
C   01-FEB-1989   - Original program
C   14-JUN-1990   - Some parameters in some subroutine calls have been changed
C                   so that arrays aren't dimensioned with elements of other
C                   arrays Also replaced NDP_IMAGE_LUT with IMAGE_LUT as a
C                   temporary measure as the former no longer works. (JRL).
C   29-AUG-1990   - Included new version of NDP_IMAGE_LUT.  (JRL)
C   18-SEP-1990   - The program now deals with magic values in the 2-d array by
C                   replacing the flagged pixels with a value which is below
C                   the lower threshold for the plot.  To do this a quality
C                   array is used so that it can be remembered which elements
C                   were magic if the user decides to change the plot limits.
C                   Formerly the values were all replaced by zeros which won't
C                   do if there is data with a value less than zero (which
C                   is always possible). The data were also changed straight
C                   into the mapped array, which then changed the values in
C                   the disk file if the array was mapped and not type
C                   converted.  Using a copy of the data array in such a case
C                   solves the problem.  (JRL)
C   30-JAN-1991   - Typo such that magic value line plotting routine wasn't
C                   called when needed for real data. (JRL)
C   20-JUN-1991   - The user can now average spectra over a polygonal region of
C                   the image (GOLDJIL). Also, the source is now in GENERIC
C                   format, split into 2 files: SPECTRUM1.FOR and SPECTRUM2.GEN.
C                   The file SPECTRUM.COM builds the executable.
C   02-MAR-1992   - Fixed to use new, improved Ariel Ultra, no, sorry, the
C                   new-ish PGPLOT routines. Also prompts for a file name
C                   for each spectrum written to disk. (GOLDJIL)
C   24-MAR-1992   - As if the last addition wasn't good enough, SPECTRUM
C                   now writes extra information into the output files:
C                   the co-ords of the spectrum; the bin size; whether
C                   it was extracted by rectangular or polygonal averaging.
C                   If the averaging was over a polygon, the polygon mask is
C                   added to the structure. If the data were averaged over a
C                   rectangle, the width and height will be stored in the
C                   structure.
C                   The output structure is now
C                     FILE {
C                       .Z
C                         .DATA     1D FLOAT spectrum data
C                         .FLAGGED  INT      Bad pixel flag, always 0
C                       .X
C                         .DATA[NX] FLOAT    axis data
C                       .SPECTRUM
C                         .X        INT      x-coord of extraction
C                         .Y        INT      y-coord of extraction
C                         .BIN      INT      bin size
C                         .MODE[16] CHAR     'rectangle','polygon' or 'pixel'
C                         .MASK     2D BYTE  mask array
C                         .WIDTH    INT      Width of averaging rectangle
C                         .HEIGHT   INT      Height "     "         "
C                     }   (GOLDJIL) 
C   25-NOV-1992   - Unix version. (GOLDJIL)
C   02-OCT-1994   - Correct the initialisation of the mask array in
C                   get_polygon_mask. The wrongbounds were used (GJP).
C   06-OCT-1994   - Removed lots of unused variables. (GJP)
C
1 squint
  Displays the pixels values in a 2-D image or image subset, using 
  alphanumeric characters to give a crude eight-level grey scale.
2 IMAGE
   NAME    IM(AGE)
   TYPE    FILE
   OPTIONS INPUT
   PROMPT  "(IMage) Name of image to be displayed"
   TEXT    ----------------------------------------------------------------
           IMAGE is the name of the structure containing the image whose 
           values will be displayed. The image must be 2-D.
           ----------------------------------------------------------------
2 STAPIX
   NAME    STAPIX
   TYPE    INT[6]
   PROMPT  "(STAPIX) Start pixel of subset."
   TEXT    ----------------------------------------------------------------
           STAPIX is an array containing the start pixel number to be 
           displayed in each dimension of the image. The first array 
           element is the start pixel in the first dimension of the 
           current sort order (usually X).
           ----------------------------------------------------------------
2 ENDPIX
   NAME    ENDPIX
   TYPE    INT[6]
   PROMPT  "(ENDPIX) End pixel of subset."
   TEXT    ----------------------------------------------------------------
           ENDPIX is an array containing the end pixel number to be 
           displayed in each dimension of the image. The first array 
           element is the end pixel in the first dimension of the 
           current sort order (usually X). Only one or two elements of 
           ENDPIX may differ from the corresponding elements of STAPIX.
           ----------------------------------------------------------------
2 AGAIN
   NAME    AGAIN
   TYPE    KEY
   PROMPT  "(AGAIN) Look at another subset?"
   TEXT    ----------------------------------------------------------------
           If AGAIN is specified, another set of start and end pixels may 
           be entered. Otherwise, the program finishes. 
           ----------------------------------------------------------------
2 SOURCE_COMMENTS
C+
C
C   -----------
C   S Q U I N T 
C   -----------
C
C   Description
C   -----------
C   Displays pixel values of a 2-D image or image subset as single 
C   characters, giving a very crude grey scale.
C
C
C   Scope of program
C   ----------------
C   - Only 2-D images accepted.
C   - Data array types SHORT and FLOAT supported; others converted to FLOAT.
C   - Subsetting supported.
C   - Magic values supported.
C   - Variance arrays not supported.
C   - Batch execution supported.
C
C
C   Environment
C   -----------
C   FIGARO
C
C
C   Parameters (read or written)
C   ----------------------------
C   IMAGE   Name of the structure containing the image. (character)
C           (prompted for).
C
C   STAPIX  Start pixel in each dimension of the subset to be inspected.
C          (real, array)(prompted for).
C
C   ENDPIX  End pixel in each dimension of the subset to be inspected.
C           (real, array)(prompted for).
C
C
C   Keywords
C   --------
C   AGAIN   Instruction to inspect another subset.
C
C
C   Propagation of data structure
C   -----------------------------
C   Not relevant.
C
C
C   Method
C   ------
C   - The IMAGE structure is tested for the bad pixel flag. If it is found 
C     and non-zero, magic values are assumed to be present and are left in 
C     the data.
C   - The minimum and maximum values in the selected image subset are 
C     obtained by calling the appropriate NDP_STATS routine. These are used
C     to determine an eight level scale.
C   - A subroutine appropriate to the data type is called to display 
C     symbols corresponding to the data values. Dimension 2 of the array is
C     accessed in reverse so that the display appears with the correct 
C     orientation.
C
C
C   External functions & subroutines called
C   ---------------------------------------
C   Library DSA:
C      DSA_CLOSE
C      DSA_DATA_SIZE
C      DSA_INPUT
C      DSA_MAP_DATA
C      DSA_MAP_QUALITY
C      DSA_OPEN
C      DSA_OUTPUT
C      DSA_SEEK_QUALITY
C      DSA_USE_FLAGGED_VALUES
C      DSA_WRUSER
C
C   Library DYN:
C      DYN_ELEMENT
C              
C   Library ICH:
C      ICH_ENCODE
C      ICH_LEN
C
C   Library NDP:
C      NDP_GET_IMAGE_INFO
C      NDP_PAR_RDARY
C      NDP_STATS_W
C      NDP_STATS_WQ
C      NDP_STATS_R
C      NDP_STATS_RQ
C
C   Library PAR:
C      PAR_CNPAR
C      PAR_RDARY
C      PAR_RDCHAR
C      PAR_RDKEY
C
C
C   Internal subroutines called
C   ---------------------------
C   SQUINT_DATA_W
C   SQUINT_DATA_WQ
C   SQUINT_DATA_R
C   SQUINT_DATA_RQ
C
C
C   INCLUDE statements
C   ------------------
C   INCLUDE 'DYN_SOURCE:DYNAMIC_MEMORY.INC'
C   INCLUDE 'NDP_SOURCE:NDP_MAGIC_VALUES.INC'
C   INCLUDE 'NDP_SOURCE:NDP_NUMERIC_RANGES.INC'
C
C
C   Extensions to FORTRAN 77
C   ------------------------
C   DO WHILE / END DO / IMPLICIT NONE / INCLUDE / Names > 6 characters
C                       
C
C   Possible future upgrades
C   ------------------------
C
C
C   Author/s
C   --------
C   Nick Fuller  RGO  (RGVAD::NMJF or NMJF@UK.AC.RGO.STAR)
C   Jim Lewis    RGO  (CAVAD::JRL or JRL@UK.AC.CAM.AST-STAR)
C   Julian Gold  RGO  (CAVAD:GOLDJIL or GOLDJIL@UK.AC.CAM.AST-STAR)
C
C
C   History
C   -------
C   01-FEB-1989   - Original program
C   03-AUG-1990   - Fixed so that adjustable array sizes are not passed
C                   as elements of another array.  This practice has been
C                   banned by the v5.2 compiler.  (JRL)
C   07-OCT-1991   - Now processes quality arrays (GOLDJIL)
C   04-DEC-1992   - Unix version. (GOLDJIL)
C   06-OCT-1994   - Removed lots of unused variables. (GJP)
C
C
C
1 stack
  Takes a number of 2 or 3-D images and joins them along a prescribed common
  dimension either contiguously or using the axis data if present. The
  result is a 3D stack of 2-D images.
2 FILES
   NAME    FI(LES)
   TYPE    FILE
   OPTIONS INPUT
   PROMPT  "(FIles) Name of image filename list"
   TEXT    ---------------------------------------------------------------
           This is the filename of an ASCII file that contains all the 
           names of the images you wish to process.
           ---------------------------------------------------------------
2 IMAGE
   NAME    IM(AGE)
   TYPE    FILE
   OPTIONS INPUT
   PROMPT  "(IMage) Name of input image"
   TEXT    ---------------------------------------------------------------
           This parameter is not used interactively and should not be set.
           ---------------------------------------------------------------
2 OUTPUT
   NAME    OUT(PUT)
   TYPE    FILE
   OPTIONS OUTPUT
   PROMPT  "(OUTput) Name of output image"
   TEXT    ---------------------------------------------------------------
           OUTPUT is the name of the structure which will contain the
           output image. It will have the same dimensions as the largest
           of the input images along each axis. If OUTPUT already exists, 
           it should NOT be one of the input images  
           ---------------------------------------------------------------
2 VERBOSE
   NAME    VERB(OSE)
   TYPE    KEY
   OPTIONS NOPROMPT
   TEXT    ---------------------------------------------------------------
           Specifying this keyword on the command line results in progress
           messages being written to the terminal.
           ---------------------------------------------------------------
2 USEAXES
   NAME    USEAX(ES)
   TYPE    KEY
   PROMPT  "(USEAXes) Use axis information to compute stacking order?"
   TEXT    ---------------------------------------------------------------
           If true, this keyword instructs STACK to compute the order the
           images will be stacked in from axis data contained in the data
           structures.
           --------------------------------------------------------------- 
2 SMALL
   NAME    SMALL
   TYPE    FLOAT
   OPTIONS NOPROMPT
   TEXT    ---------------------------------------------------------------
           This parameter sets the effective floating-point zero, that is
           a value for which two real numbers will be considered the same
           if their difference is less than it. Defaults to 1.0E-07.
           ---------------------------------------------------------------
2 JOIN
   NAME    JOIN
   TYPE    FLOAT
   PROMPT  "(JOIN) Which axis are the cubes to be joined along?"
   TEXT    ---------------------------------------------------------------
           This parameter specifies the dimension the files in the input
           list are to be stacked along. It can be 1, 2 or 3 (x,y or z).
           ---------------------------------------------------------------
2 PADVAL
   NAME    PAD(VAL)
   TYPE    FLOAT
   PROMPT  "(PADval) Enter the value to pad arrays out with"
   TEXT    ---------------------------------------------------------------
           When an image is read in from the input list, more often than
           not it will be smaller than the output file along axes other
           than the one to be joined along. This parameter allows you to
           specify a value with which the image will be padded out to the
           size of the output.
           ---------------------------------------------------------------
2 SOURCE_COMMENTS
C+
c
c   ---------
c   S T A C K
c   ---------
c
c   Description
c   -----------
c   Takes several 2 OR 3D images and joins them along a prescribed dimension
c   either contiguously or using the axis data if present.
c
c   Program Scope
c   -------------
c   - FLOAT or REAL data handled explicitly, all others mapped to FLOAT
c   - Images of 2 or 3 dimensions handled.
c   - Subsetting not appropriate.
c   - Magic values, quality and error arrays supported.
c   - Batch execution supported.
c   - Linearly scaled axis arrays only allowed if USEAXES is .TRUE.
c
c   Environment
c   -----------
c   Figaro
c
c   Parameters
c   ----------
c   FILES	Name of a .DAT file containg input file names. (file)
c   JOIN        Dimension images are to be stacked along. (integer)
c   OUTPUT	Name of the structure containing the resulting cube. (file)
c   PADVAL      Value to pad arrays out with. (real)
c   SMALL       Value of effective floating-point 0. (real, hidden)
c
c   Keywords
c   --------
c   USEAXES     If true, use cube axes to determine the stacking position.
c   VERBOSE  	Signals whether messages are terse (false) or long (hidden).
c
c   Propagation of Data Structure
c   -----------------------------
c   See method.
c
c   Method
c   ------
c   
c   - The program obtains USEAXES to determine how to join the cubes. If
c     this is true, the data will be placed in the output image according
c     to axis information. Otherwise, the cubes are simply butted together.
c   - The parameter FILES is obtained. This is an ASCII file containing the
c     names of the images to be stacked. 
c   - The axis to join the images along is obtained.
c   - A value to pad arrays out with is obtained.
c   - Each image is read in in turn, and the output file's properties are
c     determined from the information gathered in this first pass. The rules
c     are as follows:
c     
c     o Only 2 or 3 dimensions allowed.
c
c     o The output file size depends upon USEAXES: if we first consider the
c       dimension cubes are to be joined along -
c       
c       if (USEAXES) then
c         output_dimension = (max_axis-min_axis) / axis_scale  + 1
c       else
c         output_dimension = sum of input_dimensions
c       end if.
c
c       (Note that this implies overlapping cubes will replace values
c       in the output obtained from previous files, so the order in the
c       list of filenames is important if USEAXES is true.)
c
c       Along other dimensions -
c
c       output_dimension = maximum of input_dimensions
c
c       Arrays will be padded out with value of PADVAL and left-justified.
c
c     o The output file type is determined by the type of the first file
c       in the input list (hereafter called the BASE file). This also
c       applies to axis units and scale.
c
c     o If USEAXES is true, ALL axes must be present in ALL the images.
c       Further, logarithmic axes are disallowed and axes with units other
c       than that of the base file also cause program abortion. 
c
c     o All axis data must increase monotonically with index (if it doesn't, 
c       use AXFLIP or SETAXES to make it so).
c
c     o All axis data must be on the same scale as the base file (ie the ratio
c
c                        (end - start + 1) / no.of pixels
c                              
c       must be the same for each respective axis.)
c
c     o Quality or error arrays will appear in the output iff each input
c       file contains them, otherwise they will be ignored. Similarly
c       the bad pixel flag will only be set in the output structure iff
c       all the input files have it set. This avoids conflicts with magic
c       values and quality arrays.
c
c     o The output file CANNOT be in the input list as well, because 
c       this could lead to the program obtaining the wrong data from the
c       wrong version of the file (or an i/o error).
c
c   - The output file is mapped and filled with the padding value.
c   - Each image is then opened, and the appropriate arrays mapped. The arrays 
c     are then copied to the appropriate locations in the output.
c
c   - If USEAXES is true, the output axes are scaled accordingly.
c
c   External Functions & Subroutines
c   --------------------------------
c   DSA Library:
c     DSA_CLOSE
c     DSA_CLOSE_STRUCTURE
c     DSA_DATA_SIZE
c     DSA_DATA_TYPE
c     DSA_GET_AXIS_INFO
c     DSA_GET_LU
c     DSA_INPUT
c     DSA_MAP_AXIS_DATA
c     DSA_MAP_DATA
c     DSA_MAP_ERRORS
c     DSA_MAP_QUALITY
c     DSA_NAMED_INPUT
c     DSA_OPEN
c     DSA_OUTPUT
c     DSA_SEEK_AXIS
c     DSA_SEEK_ERRORS
c     DSA_SEEK_FLAGGED_VALUES
c     DSA_SEEK_QUALITY
c     DSA_SIMPLE_OUTPUT
c     DSA_TYPESIZE
c     DSA_UNMAP
c     DSA_WRUSER
c
c   GEN Library:
c     GEN_FILL  
c   
c   ICH Library:
c     ICH_CI
c     ICH_FOLD
c     ICH_LEN
c
c   NDP Library:
c     NDP_GET_IMAGE_INFO
c     NDP_PAR_RDARY
c
c   PAR Library:
c     PAR_CNPAR
c     PAR_GIVEN
c     PAR_RDCHAR
c     PAR_RDVAL
c
c   Internal Subroutines
c   --------------------
c
c     STACK_FILL_R
c     STACK_FILL_W
c     STACK_GET_AXIS_INFO
c     STACK_INFO
c     STACK_OVERLAP
c     STACK_R
c     STACK_SETAXES
c     STACK_W
c
c   INCLUDE's
c   ---------
c   INCLUDE 'DYN_SOURCE:DYNAMIC_MEMORY.INC'
c   INCLUDE 'NDP_SOURCE:NDP_MAGIC_VALUES.INC'
c   INCLUDE 'NDP_SOURCE:NDP_NUMERIC_RANGES.INC'
c
c   Fortran 77 Extensions
c   ---------------------
c   END DO / IMPLICIT NONE / INCLUDE / Names > 6 characters / DO WHILE
c
c   Author
c   ------
c   Julian Gold		RGO	(CAVAD::GOLDJIL or goldjil@uk.ac.cam.ast-star)
c
c   History
c   -------
c
c   21-MAY-1992		- Original program.
c   07-DEC-1992         - Unix version.
C   06-OCT-1994         - Removed lots of unused variables. (GJP)
c
1 stats
  Computes basic statistics of an image or image subset. Optionally,
  checks and if necessary corrects the bad pixel flag.
2 IMAGE
   NAME    IM(AGE)
   TYPE    FILE
   OPTIONS INPUT
   PROMPT  "(IMage) Name of image to be inspected"
   TEXT    ----------------------------------------------------------------
           IMAGE is the name of the structure containing the image for
           which the minimum, maximum, mean, standard deviation, and total
           of its pixel values will be found. The locations of the first
           occurrences of the minimum and maximum are also displayed. The
           image may have from one to six dimensions.
           ----------------------------------------------------------------
2 CHECK
   NAME    CHECK
   TYPE    KEY                                               
   OPTIONS NOPROMPT
   PROMPT  "(CHECK) Check the bad pixel flag?"
   TEXT    ----------------------------------------------------------------
           This option ensures that the bad pixel flag is set correctly.
           If CHECK is specified, magic values are assumed to be present
           and the number actually found is counted. The bad pixel flag
           is then set accordingly and an information message is given.
           Subset selection is not allowed since the whole image must be
           inspected for the flag to be valid.
           ----------------------------------------------------------------
2 WHOLE
   NAME    WH(OLE)
   TYPE    KEY                                               
   PROMPT  "(WHole) Process the whole image?"
   TEXT    ----------------------------------------------------------------
           If WHOLE is specified, the entire area of the image will be 
           processed. Otherwise, a subset of the image may be selected.
           ----------------------------------------------------------------
2 START
   NAME    ST(ART)
   TYPE    FLOAT[6]
   PROMPT  "(STart) Start coordinates of subset."
   TEXT    ----------------------------------------------------------------
           START is an array containing the start coordinate of the subset
           to be processed in each dimension of the image. The first array
           element is the start coordinate in the first dimension of the 
           current sort order (usually X). Each coordinate must be given 
           in axis units if the relevant axis is calibrated, or in pixels 
           if it is not calibrated or the axis structure is not present.  
           ----------------------------------------------------------------
2 END
   NAME    EN(D)
   TYPE    FLOAT[6]
   PROMPT  "(ENd) End coordinates of subset."
   TEXT    ----------------------------------------------------------------
           END is an array containing the end coordinate of the subset
           to be processed in each dimension of the image. The first array
           element is the end coordinate in the first dimension of the 
           current sort order (usually X). Each coordinate must be given 
           in axis units if the relevant axis is calibrated, or in pixels 
           if it is not calibrated or the axis structure is not present.  
           ----------------------------------------------------------------
2 PASS2
   NAME    PASS2
   TYPE    KEY                                               
   PROMPT  "(PASS2) Perform two passes?"
   TEXT    ----------------------------------------------------------------
           A second pass is recommended for an image with more than 10000 
           pixels. The standard deviation is recomputed using an algorithm
           which is less prone to rounding error when a large number of 
           pixels is involved. A second pass is always used when fewer 
           than 10000 pixels are involved, since other overheads outweigh
           the extra time taken.
           ----------------------------------------------------------------
2 SOURCE_COMMENTS
C+
C
C   ---------
C   S T A T S
C   ---------
C
C   Description
C   -----------
C   Inspects an image or an image subset and determines the total, maximum, 
C   minimum, mean, and standard deviation. The coordinates of the maximum 
C   and minimum pixels, the total number of pixels inspected, and (if 
C   applicable) the number of bad  pixels found are output. The bad
C   pixel flag may be checked to ensure that it has the correct value.
C
C
C   Scope of program
C   ----------------
C   - Images of up to six dimensions accepted.
C   - Data array types SHORT and FLOAT supported; others converted to FLOAT.
C   - Subsetting supported.
C   - Magic values supported.
C   - Quality and variance arrays supported.
C   - Batch execution supported.
C
C
C   Environment
C   -----------
C   FIGARO
C
C
C   Parameters (read or written)
C   ----------------------------
C   IMAGE  Name of the structure containing the image to be inspected.
C          (character)(prompted for).
C
C   START  Start coordinate in each dimension of the subset to be inspected.
C          (real, array)(prompted for).
C
C   END    End coordinate in each dimension of the subset to be inspected. 
C          (real, array)(prompted for).
C
C   The following parameters are all set by the program and written to the 
C   parameter file:
C
C   STAT_TOTAL   Sum of the pixel values 
C
C   STAT_MIN     Minimum pixel value 
C
C   STAT_MAX     Maximum pixel value
C
C   STAT_MEAN    Mean pixel value 
C
C   STAT_SIGMA   Standard distribution of the pixel values
C
C   STAT_SIZE    Number of pixels inspected 
C
C   STAT_BADPIX  Number of bad pixels (magic or bad quality) found
C
C   STAT_1START  First pixel inspected in dimension 1
C   STAT_2START    "     "       "     "      "     2
C   STAT_3START    "     "       "     "      "     3
C   STAT_4START    "     "       "     "      "     4
C   STAT_5START    "     "       "     "      "     5
C   STAT_6START    "     "       "     "      "     6
C
C   STAT_1END    Last pixel inspected in dimension 1
C   STAT_2END     "     "       "     "      "     2
C   STAT_3END     "     "       "     "      "     3
C   STAT_4END     "     "       "     "      "     4
C   STAT_5END     "     "       "     "      "     5
C   STAT_6END     "     "       "     "      "     6
C
C   STAT_1MIN    The pixel coord in dim 1 where the min was found
C   STAT_2MIN     "    "     "   "   "  2   "    "   "   "    "
C   STAT_3MIN     "    "     "   "   "  3   "    "   "   "    "
C   STAT_4MIN     "    "     "   "   "  4   "    "   "   "    "
C   STAT_5MIN     "    "     "   "   "  5   "    "   "   "    "
C   STAT_6MIN     "    "     "   "   "  6   "    "   "   "    "
C
C   STAT_1MAX    The pixel coord in dim 1 where the max was found
C   STAT_2MAX     "    "     "   "   "  2   "    "   "   "    "
C   STAT_3MAX     "    "     "   "   "  3   "    "   "   "    "
C   STAT_4MAX     "    "     "   "   "  4   "    "   "   "    "
C   STAT_5MAX     "    "     "   "   "  5   "    "   "   "    "
C   STAT_6MAX     "    "     "   "   "  6   "    "   "   "    "
C
C
C   Keywords
C   --------
C   WHOLE  Instructs the program to inspect the whole image. Otherwise, a
C          subset of the image may be selected.
C
C   CHECK  Instructs the program to check whether the bad pixel flag is set
C          correctly and, if necessary, correct it. (hidden keyword).
C
C   PASS2  Instructs the program to compute the standard deviation using
C          two passes through the data. The one-pass algorithm normally 
C          used is prone to rounding error when large numbers of pixels 
C          are involved, but is rather faster. If fewer than 10000 pixels
C          are involved, STATS always uses two passes, since other overheads
C          outweigh the extra time taken.
C
C
C   Propagation of data structure
C   -----------------------------
C   Not relevant.
C
C
C   Method
C   ------
C   - The IMAGE structure is tested for the bad pixel flag. If it is found 
C     and non-zero, magic values are assumed to be present and are left in
C     the data.
C   - The program can be instructed to check whether the bad pixel flag is
C     is set correctly and if not, to correct it. This is done by assuming
C     that magic values are present and then inspecting the whole image.
C   - For images with less than 10000 pixels the two pass method is used
C     automatically. For larger images the instruction to use the two pass
C     method is prompted for.
C   - A NDP_STATS_ subroutine appropriate to the required method, the data 
C     type, the presence or absence of magic values, and the instruction
C     to check the bad pixel flag is called to compute the statistics.
C   - If the whole of IMAGE was inspected, the range structure is updated 
C     and marked as valid.
C   - The bad data flag is corrected if necessary.
C   - Several parameters are set to the values of the statistical quantities
C     and are written to the parameter file.
C
C
C   External functions & subroutines called
C   ---------------------------------------
C   Library DSA:
C      DSA_CLOSE
C      DSA_DATA_SIZE
C      DSA_INPUT
C      DSA_MAP_DATA
C      DSA_MAP_ERRORS
C      DSA_MAP_QUALITY
C      DSA_OPEN
C      DSA_SEEK_ERRORS
C      DSA_SEEK_QUALITY
C      DSA_SET_RANGE
C      DSA_USE_FLAGGED_VALUES
C      DSA_WRUSER
C
C   Library DYN:
C      DYN_ELEMENT
C
C   Library ICH:
C      ICH_ENCODE
C      ICH_LEN
C
C   Library NDP:
C      NDP_AXIS_RANGE
C      NDP_DISPLAY_PROGRESS
C      NDP_ERROR_STATS_W
C      NDP_ERROR_STATS_Q
C      NDP_GET_IMAGE_INFO
C      NDP_STATS_W
C      NDP_STATS_WQ
C      NDP_STATS_R
C      NDP_STATS_RQ
C      NDP_STATS2_W
C      NDP_STATS2_WQ
C      NDP_STATS2_R
C      NDP_STATS2_RQ
C
C   Library PAR:
C      PAR_RDKEY
C      PAR_ABORT
C     
C   Library VAR:
C      VAR_SETNUM
C
C
C   Internal subroutines called
C   ---------------------------
C   None.
C
C
C   INCLUDE statements
C   ------------------
C   INCLUDE 'DYN_SOURCE:DYNAMIC_MEMORY.INC'
C   INCLUDE 'NDP_SOURCE:NDP_MAGIC_VALUES.INC'
C   INCLUDE 'NDP_SOURCE:NDP_NUMERIC_RANGES.INC'
C
C
C   Extensions to FORTRAN77
C   -----------------------
C   END DO / IMPLICIT NONE / INCLUDE / Names > 6 characters
C
C            
C   Possible future upgrades
C   ------------------------
C
C
C   Author/s
C   --------
C   Nick Fuller  RGO  (RGVAD:NMJF or NMJF@UK.AC.RGO.STAR)
C   Julian Gold  RGO  (CAVAD::GOLDJIL or GOLDJIL@UK.AC.CAM.AST-STAR)
C
C   History
C   -------
C   01-FEB-1989   - Original program
C   10-SEP-1991   - Program can now be aborted before computing stats
C   18-OCT-1991   - Quality and error array handling implemented.
C                   The STAT_MAGIC parameter is now called STAT_BADPIX
C                   since it is now the number of bad pixels (magic or
C                   non-zero quality) in the image. (GOLDJIL)
C   07-DEC-1992   - Unix version.
C   06-OCT-1994   - Removed lots of unused variables. (GJP)
C
1 stretch
  Takes a 1,2 or 3-D image and expands or compresses it to the dimensions
  of a second image (of the same dimensionality). There is a choice of 
  interpolation method.
2 IMAGE1
   NAME    IMAGE1
   TYPE    FILE
   OPTIONS INPUT
   PROMPT  "(IMAGE1) Name of input image"
   TEXT    ---------------------------------------------------------------
           This parameter specifies the filename of the image that is to
           be stretched.
           ---------------------------------------------------------------
2 IMAGE2
   NAME    IMAGE2
   TYPE    FILE
   OPTIONS INPUT
   PROMPT  "(IMAGE2) Name of reference image"
   TEXT    ---------------------------------------------------------------
           This parameter specifies the filename of the image that is to
           define the amounts IMAGE1 is to be scaled. It must have the 
           same dimensionality of IMAGE1, which will be compressed or
           expanded to the dimensions of IMAGE2.
           ---------------------------------------------------------------
2 OUTPUT
   NAME    OUT(PUT)
   TYPE    FILE
   OPTIONS OUTPUT
   PROMPT  "(OUTput) Name of output image"
   TEXT    ---------------------------------------------------------------
           OUTPUT is the name of the structure which will contain the
           output image. It will have the same dimensions as the largest
           of the input images along each axis. If OUTPUT already exists, 
           it should NOT be one of the input images  
           ---------------------------------------------------------------
2 VERBOSE
   NAME    VERB(OSE)
   TYPE    KEY
   OPTIONS NOPROMPT
   TEXT    ---------------------------------------------------------------
           Specifying this keyword on the command line results in progress
           messages being written to the terminal.
           ---------------------------------------------------------------
2 INTERP
   NAME    INTERP
   TYPE    CHAR
   PROMPT  "(INTERP) (C)onstant or (L)inear interpolation?"
   TEXT    --------------------------------------------------------------
           This parameter selects one of two interpolation methods to
           compute pixel values in the stretched image.
           Typing C will calculate intermediate pixel values in the 
           streched cube by piecewise constant interpolation. 
           Typing L will perform piecewise linear interpolation.
           --------------------------------------------------------------
2 SOURCE_COMMENTS
C+
c
c   -------------
c   S T R E T C H
c   -------------
c
c   Description
c   -----------
c   Uses the axis arrays of one cube to re-scale the data in another cube,
c   performing any necessary interpolation.
c
c   Program Scope
c   -------------
c   - FLOAT or REAL data, other types handled as float
c   - Images of up to 3 dimensions
c   - Subsetting not appropriate
c   - Linear axis arrays necessary in at least one dimension
c   - Magic values, error and quality arrays supported.
c   - Batch mode supported
c
c   Environment
c   -----------
c   Figaro
c
c   Parameters
c   ----------
c   IMAGE1      Name of image to be scaled
c   IMAGE2      Name of image whose dimensions will determine the scaling
c   OUTPUT      Name of output structure
c   INTERP      Type of interpolation to be used.
c   
c   Keywords
c   --------
c   VERBOSE     Make the program more talkative.
c
c   Method
c   ------
c   - Two data structures are prompted for and opened. They must both have
c     the same dimensionality but differing dimensions. The first is the 
c     image to be stretched, the second one defines the size of the stretched
c     array.
c   - Various checks are made to see if the two images are compatible.
c   - Error and quality arrays are checked for.
c   - The output structure is created with the same dimensions as the second
c     input structure.
c   - All necessary arrays are mapped.
c   - The program can perform either piecewise constant or linear interpolation
c     of pixel data. This option is obtained.
c   - The input cube is stretched (or indeed squashed) to fit the output cube.
c   - The axes (if present) are adjusted to fit the new size.
c
c   External functions and subroutines
c   ----------------------------------
c
c   DSA Library:
c     DSA_CLOSE
c     DSA_GET_AXIS_DATA
c     DSA_GET_WORK_ARRAY
c     DSA_INPUT
c     DSA_OPEN
c     DSA_OUTPUT
c     DSA_MAP_AXIS_DATA
c     DSA_MAP_DATA
c     DSA_MAP_ERRORS
c     DSA_MAP_QUALITY
c     DSA_SEEK_ERRORS
c     DSA_SEEK_QUALITY
c     DSA_SIMPLE_OUTPUT
c     DSA_UNMAP
c     DSA_WRUSER
c
c   GEN Library:
c     GEN_ELEMF
c
c   ICH Library:
c     ICH_CI
c     ICH_FOLD
c
c   NDP Library:
c     NDP_GET_IMAGE_INFO
c
c   PAR Library:
c     PAR_RDCHAR
c     PAR_RDKEY
c
c   Internal subroutines
c   --------------------
c   STRETCH_1D_<T>
c   STRETCH_2D_<T>
c   STRETCH_3D_<T>
c   STRETCH_DO_AXIS
c
c   INCLUDE's
c   ---------
c   INCLUDE 'DYN_SOURCE:DYNAMIC_MEMORY.INC'
c   INCLUDE 'NDP_SOURCE:NDP_MAGIC_VALUES.INC'
c   INCLUDE 'NDP_SOURCE:NDP_NUMERIC_RANGES.INC'
c   INCLUDE 'DCV_FUN'
c
c   Fortran 77 Extensions
c   ---------------------
c   END DO / IMPLICIT NONE / INCLUDE / Names > 6 characters / DO WHILE
c
c   Author
c   ------
c   Julian Gold         RGO     (CAVAD::GOLDJIL or goldjil@uk.ac.cam.ast-star)
c
c   History
c   -------
c
c   14-AUG-1992         - Original program.
c   10-DEC-1992         - Unix version.
C   06-OCT-1994         - Removed lots of unused variables. (GJP)
c
1 subset
  Creates a subset of an image.
2 IMAGE
   NAME    IM(AGE)
   TYPE    FILE
   OPTIONS INPUT
   PROMPT  "(IMage) Name of input image"
   TEXT    ----------------------------------------------------------------
           IMAGE is the name of the structure containing the image to be 
           subsetted. The image may have from one to six dimensions. The
           output image will have the same number of dimensions, even if,
           for example, a cube is subsetted to a single plane.
           ----------------------------------------------------------------
2 START
   NAME    ST(ART)
   TYPE    FLOAT[6]
   PROMPT  "(STart) Start coordinates of subset."
   TEXT    ----------------------------------------------------------------
           START is an array containing the start coordinate of the subset
           in each dimension of the image. The first array element is the 
           start coordinate in the first dimension of the current sort 
           order (usually X). Each coordinate must be given in axis units 
           if the relevant axis is calibrated, or in pixels if it is not 
           calibrated or the axis structure is not present.  
           ----------------------------------------------------------------
2 END
   NAME    EN(D)
   TYPE    FLOAT[6]
   PROMPT  "(ENd) End coordinates of subset."
   TEXT    ----------------------------------------------------------------
           END is an array containing the end coordinate of the subset
           in each dimension of the image. The first array element is the 
           end coordinate in the first dimension of the current sort order
           (usually X). Each coordinate must be given in axis units if the
           relevant axis is calibrated, or in pixels if it is not 
           calibrated or the axis structure is not present.  
           ----------------------------------------------------------------
2 OUTPUT
   NAME    OUT(PUT)
   TYPE    FILE
   OPTIONS OUTPUT
   PROMPT  "(OUTput) Name of output image"
   TEXT    ----------------------------------------------------------------
           OUTPUT is the name of the structure which will contain the
           output image. If OUTPUT already exists, a new version will be 
           created. If OUTPUT is the same as IMAGE, a new version of IMAGE
           will be created.
           ----------------------------------------------------------------
2 SOURCE_COMMENTS
C+
C
C   -----------
C   S U B S E T
C   -----------
C
C   Description
C   -----------
C   Creates a subset of an image.
C
C
C   Scope of program
C   ----------------
C   - Images of up to six dimensions accepted.
C   - Data array types SHORT and FLOAT supported; others converted to FLOAT.
C   - Subsetting supported (obviously).
C   - Magic values not supported since not relevant.
C   - Quality and error arrays supported.
C   - Batch execution supported.
C
C
C   Environment
C   -----------
C   FIGARO
C
C
C   Parameters (read or written)
C   ----------------------------
C   IMAGE   Name of the structure containing the image to be subsetted.
C           (character)(prompted for).
C
C   START   Coordinate in each dimension of IMAGE at which the subset
C           operation is to start. (real, array)(prompted for).
C
C   END     Coordinate in each dimension of IMAGE at which the subset
C           operation is to end. (real, array)(prompted for).
C
C   OUTPUT  Name of the structure containing the image subset. May be the 
C           same as IMAGE. (character)(prompted for).
C
C   Keywords
C   --------
C   None.
C
C
C   Propagation of data structure
C   -----------------------------
C   - All standard objects except the data array and axes are copied from 
C     IMAGE.
C   - Data array and axes are reshaped.
C
C
C   Method
C   ------
C   - The structure IMAGE is copied to OUTPUT, with the exception of the
C     data array and axes. DSA_RESHAPE_ routines are called to modify the 
C     dimensions of the OUTPUT axis and data arrays. 
C   - The calibrations of the appropriate parts of the IMAGE axes are copied
C     to the OUTPUT axes. 
C   - A subroutine appropriate to the data type is called to transfer the 
C     required subset of the IMAGE data array to the OUTPUT data array.
C
C
C   External functions & subroutines called
C   ---------------------------------------
C   Library DSA:
C     DSA_CLOSE
C     DSA_DATA_SIZE
C     DSA_INPUT
C     DSA_MAP_AXIS_DATA
C     DSA_MAP_DATA
C     DSA_MAP_ERRORS
C     DSA_MAP_QUALITY
C     DSA_OPEN 
C     DSA_OUTPUT
C     DSA_RESHAPE_AXIS
C     DSA_RESHAPE_DATA
C     DSA_SEEK_ERRORS
C     DSA_SEEK_QUALITY
C     DSA_USE_FLAGGED_VALUES
C     DSA_WRUSER
C
C   Library DYN:
C     DYN_ELEMENT
C
C   Library GEN:
C     GEN_BSEARCH
C     GEN_ELEMF
C
C   Library NDP:
C     NDP_DISPLAY_PROGRESS
C     NDP_GET_IMAGE_INFO
C     NDP_PAR_RDARY
C
C
C   Internal subroutines called
C   ---------------------------
C   SUBSET_DATA_W
C   SUBSET_DATA_R
C   SUBSET_DATA_B
C   SUBSET_NEWAXIS
C
C
C   INCLUDE statements
C   ------------------
C   INCLUDE 'DYN_SOURCE:DYNAMIC_MEMORY.INC'
C   INCLUDE 'NDP_SOURCE:NDP_MAGIC_VALUES.INC'
C   INCLUDE 'NDP_SOURCE:NDP_NUMERIC_RANGES.INC'
C                                             
C     
C   Extensions to FORTRAN77
C   -----------------------
C   END DO / IMPLICIT NONE / INCLUDE / Names > 6 characters
C
C
C   Possible future upgrades
C   ------------------------
C
C
C   Author/s
C   --------
C   Nick Fuller  RGO  (RGVAD::NMJF or NMJF@UK.AC.RGO.STAR)
C   Julian Gold  RGO  (CAVAD::GOLDJIL or GOLDJIL@UK.AC.CAM.AST-STAR)
C
C   History
C   -------
C   01-FEB-1989   - Original program
C   15-OCT-1991   - Quality and error array handling implemented. Code
C                   written in GENERIC format.
C   10-DEC-1992   - Unix version. (GOLDJIL)
C   06-OCT-1994   - Removed lots of unused variables. (GJP)
C
1 tau2fig
  Converts a disk file in the old TAURUS format to a 2-D or 3-D FIGARO
  data structure.

  NOTE:  This task is not available under Unix.
         Please contact starlink@jiscmail.ac.uk if this is a problem.


2 TAUFILE
   NAME    TAU(FILE)
   TYPE    CHAR
   PROMPT  "(TAUfile) Name of old format TAURUS file"
   TEXT    ----------------------------------------------------------------
           TAUFILE is the name of the old format TAURUS file to be read.
           The name must include an extension such as '.DAT'. The image
           may be 2-D or 3-D.
           ----------------------------------------------------------------
             
2 NDIM
   NAME    NDIM
   TYPE    INT
   PROMPT  "(NDIM) Number of dimensions"
   TEXT    ----------------------------------------------------------------
           Both 2-D and 3-D old format images are acceptable.
           ----------------------------------------------------------------
2 SIZE
   NAME    SIZE
   TYPE    INT[6]
   PROMPT  "(SIZE) Dimensions of image."
   TEXT    ----------------------------------------------------------------
           SIZE is an array containing the sizeof each dimension of the
           old format image. The first array element is size of the first
           dimension of the current sort order (usually X).
           ----------------------------------------------------------------
2 FLOAT
   NAME    FL(OAT)
   TYPE    KEY                                               
   PROMPT  "(FLoat) Is TAUFILE of type FLOAT?"
   TEXT    ----------------------------------------------------------------
           If FLOAT is specified, TAUFILE will be read as FLOAT, and the 
           output data array will be of type FLOAT, i.e. single precision 
           floating point (REAL*4).
           ----------------------------------------------------------------
2 SHORT
   NAME    SH(ORT)
   TYPE    KEY                                               
   PROMPT  "(SHort) Is TAUFILE of type SHORT?"
   TEXT    ----------------------------------------------------------------
           If SHORT is specified, TAUFILE will be read as SHORT, and the 
           output data array will be of type SHORT, i.e. signed word 
           (INTEGER*2).
           ----------------------------------------------------------------
             
2 OUTPUT
   NAME    OUT(PUT)
   TYPE    FILE
   OPTIONS OUTPUT
   PROMPT  "(OUTput) Name of image to be created"
   TEXT    ----------------------------------------------------------------
           OUTPUT is the name of the structure which will contain the 
           output image. If OUTPUT already exists, a new version will be
           created.
           ----------------------------------------------------------------
2 AXES
   NAME    AX(ES)
   TYPE    KEY                                               
   PROMPT  "(AXes) Calibrate the axes?"
   TEXT    ----------------------------------------------------------------
           If AXES is specified, the axes of the output image may be 
           calibrated by assigning a start and end value to each. 
           ----------------------------------------------------------------
2 AXKEY
   NAME    AXKEY
   TYPE    INT[6]
   PROMPT  "(AXKEY) Keys for axes to be calibrated."
   TEXT    ----------------------------------------------------------------
           AXKEY is an array containing the instruction to leave alone or
           calibrate each axis. 0 = leave alone, 1 = calibrate. 
           ----------------------------------------------------------------
2 AXSTART
   NAME    AXST(ART)
   TYPE    FLOAT[6]
   PROMPT  "(AXSTart) Start values of axes."
   TEXT    ----------------------------------------------------------------
           AXSTART is an array containing the start calibration value of 
           each axis. The first array element is the start value of the
           first axis.
           ----------------------------------------------------------------
2 AXEND
   NAME    AXEN(D)
   TYPE    FLOAT[6]
   PROMPT  "(AXENd) End values of axes."
   TEXT    ----------------------------------------------------------------
           AXEND is an array containing the end calibration value of each 
           axis. The first array element is the end value of the first
           axis.
           ----------------------------------------------------------------
2 AXLOG
   NAME    AXLOG
   TYPE    INT[6]
   PROMPT  "(AXLOG) Keys for logarithmic scaling."
   TEXT    ----------------------------------------------------------------
           AXLOG is an array containing the instruction for linear or log-
           arithmic calibration of each axis. 0 = linear, 1 = logarithmic. 
           ----------------------------------------------------------------
2 SOURCE_COMMENTS
C+
C
C   -------------
C   T A U 2 F I G
C   -------------
C
C   Description
C   -----------
C   Converts an old format 2-D or 3-D TAURUS image to a FIGARO data
C   structure.
C                                                      
C
C   Scope of program
C   ----------------
C   - Images of two or three dimensions accepted.
C   - Data array types SHORT and FLOAT may be created.
C   - Subsetting not supported.
C   - Magic values not supported since not supported in old TAURUS format.
C   - Quality and variance arrays not supported.
C   - Batch execution supported.
C
C
C   Environment
C   -----------
C   FIGARO
C
C
C   Parameters (read or written)
C   ----------------------------
C   TAUFILE  Name of the old format TAURUS file. (character)(prompted for).
C
C   NDIM     Number of dimensions in the image. (integer)(prompted for).
C
C   SIZE     Size of each dimension of the image. (integer, array)
C            (prompted for).
C
C   OUTPUT   The name of the structure containing the output image. 
C            (character)(prompted for).
C
C   AXKEY    Keys for axes to be calibrated.(integer, array)(prompted for).
C
C   AXSTART  Start calibration value for each axis. (real, array)
C            (prompted for). 
C
C   AXEND    End calibration value for each axis. (real, array)
C            (prompted for). 
C
C   AXLOG    Keys for axes to be calibrated logarithmically. 
C            (integer, array)(prompted for).
C
C
C
C   Keywords
C   --------
C   SHORT    Instruction to read the old format file as INTEGER*2 and create
C            a data array of type SHORT.
C
C   FLOAT    Instruction to read the old format file as REAL and create a
C            data array of type FLOAT.
C
C   AXES     Instruction to calibrate the axes of the image.
C
C
C   Propagation of data structure
C   -----------------------------
C   Not relevant.
C
C
C   Method
C   ------
C   - The name of the old format TAURUS file, including a filename 
C     extension, is prompted for. Since the data type, dimensionality, and
C     dimensions are are not available in the file, they must also be 
C     prompted for.
C   - The old TAURUS file is mapped using the routine MAPFILE from the old
C     TAURUS system.
C   - A structure definition file appropriate to the required number of
C     dimensions and data type is read. 
C   - Structure variables for the size of each dimension are set and the 
C     OUTPUT structure is created.
C   - If it is required to calibrate the axes, the structure variable for
C     axis calibration is set, and the axis number(s), start and end 
C     value(s), and linear/logarithmic flag(s) are prompted for. The axes 
C     are then mapped and calibrated.
C   - The OUTPUT data array is mapped and the data is copied by the fast
C     transfer routine GEN_MOVE.
C   - The old TAURUS file is unmapped using the routine UNMAPFILE from the
C     old TAURUS system.
C
C
C   External functions & subroutines called
C   ---------------------------------------
C   Library DSA:
C      DSA_CLOSE
C      DSA_CREATE_STRUCTURE
C      DSA_MAP_AXIS_DATA
C      DSA_MAP_DATA
C      DSA_OPEN
C      DSA_READ_STRUCT_DEF
C      DSA_SET_STRUCT_VAR
C      DSA_TYPESIZE
C      DSA_WRUSER
C
C   Library DYN:
C      DYN_ELEMENT
C
C   Library GEN:
C      GEN_MOVE
C
C   Library ICH:
C      ICH_CI
C      ICH_LEN
C
C   Library NDP:
C      MAPFILE
C      NDP_PAR_RDARY
C      NDP_SET_AXES
C      NDP_SET_BAD_PIXEL
C      UNMAPFILE
C
C   Library PAR:
C      PAR_GIVEN
C      PAR_RDKEY
C      PAR_RDVAL
C
C
C   Internal subroutines called
C   ---------------------------
C   None.
C
C
C   INCLUDE statements
C   ------------------
C   INCLUDE 'DYN_SOURCE:DYNAMIC_MEMORY.INC'
C   INCLUDE 'NDP_SOURCE:NDP_MAGIC_VALUES.INC'
C   INCLUDE 'NDP_SOURCE:NDP_NUMERIC_RANGES.INC'
C                                             
C
C   Extensions to FORTRAN77
C   -----------------------
C   END DO / IMPLICIT NONE / INCLUDE / Names > 6 characters / %VAL
C
C
C   Possible future upgrades
C   ------------------------
C
C
C   Author/s
C   --------
C   Nick Fuller  RGO  (RGVAD::NMJF or NMJF@UK.AC.RGO.STAR)
C
C
C   History
C   -------
C   01-FEB-1989   - Original program
C
C
1 transform
  Geometric transformation program for shifting, rotating, and resampling
  an image. The operations may be performed seperately or in combination.
  New pixel values may be derived from the nearest neighbours or by
  linear interpolation. Currently handles 2 and 3-D data only.
2 IMAGE
   NAME    IM(AGE)
   TYPE    FILE
   OPTIONS INPUT
   PROMPT  "(IMage) Name of input image"
   TEXT    ----------------------------------------------------------------
           IMAGE is the name of the structure containing the image to be 
           transformed. The image may have two or three dimensions.
           ----------------------------------------------------------------
2 SHIFT
   NAME    SHIFT
   TYPE    FLOAT[6]
   PROMPT  "(SHIFT) Shift amount."
   TEXT    ----------------------------------------------------------------
           SHIFT is an array containing the shift amount, in unresampled
           pixels, to be applied to each dimension of the image. The first
           array element is the shift in the first dimension of the
           current sort order (usually X). Pixels which no longer have a 
           value after the shift will be assigned the magic value. Note 
           that operations will be performed in the order shift - rotate -
           resample.
           ----------------------------------------------------------------
2 CENTRE
   NAME    CENTRE
   TYPE    FLOAT[6]
   PROMPT  "(CENTRE) Centre of rotation."
   TEXT    ----------------------------------------------------------------
           CENTRE is an array containing the centre of rotation, in 
           unresampled pixels, in each dimension of the image. The centre 
           may lie outside the image in any or all dimensions. The first 
           array element is the pixel number in the first dimension of the
           current sort order (usually X). Note that operations will be 
           performed in the order shift - rotate - resample.
           ----------------------------------------------------------------
2 ANGLE
   NAME    ANGLE
   TYPE    FLOAT[6]
   PROMPT  "(ANGLE) Angle of rotation."
   TEXT    ----------------------------------------------------------------
           ANGLE is an array containing the anticlockwise rotation angle, 
           in degrees, about each rotation axis. For a 2-D image, ANGLE(1)
           is the angle about the only possible axis, perpendicular to the
           image plane. For a 3-D image, the first array element is the 
           angle about an axis parallel to the first dimension of the 
           current sort order (usually X), and so on. Pixels which lie 
           outside the area of data after rotation will be assigned the
           magic value.
           ----------------------------------------------------------------
2 RESAMPLE
   NAME    RESAMPLE
   TYPE    FLOAT[6]
   PROMPT  "(RESAMPLE) Resampling factor."
   TEXT    ----------------------------------------------------------------
           RESAMPLE is an array containing the resampling factor, in 
           output pixels per input pixel, that is required for each 
           dimension of the image. The first array element is the factor 
           in the first dimension of the current sort order (usually X).
           Note that operations will be performed in the order shift - 
           rotate - resample.
           ----------------------------------------------------------------
2 STAPIX
   NAME    STAPIX
   TYPE    INT[6]
   PROMPT  "(STAPIX) Start pixel of output."
   TEXT    ----------------------------------------------------------------
           STAPIX is an array containing the required start pixel in each 
           dimension of the output image. The values entered must be
           relative to the origin of IMAGE (1,1...) and must take into 
           account the shift and rotation. The first array element is the
           start pixel in the first dimension of the transformed image.
           ----------------------------------------------------------------
2 ENDPIX
   NAME    ENDPIX
   TYPE    INT[6]
   PROMPT  "(ENDPIX) End pixel of output."
   TEXT    ----------------------------------------------------------------
           ENDPIX is an array containing the required end pixel in each 
           dimension of the output image. The values entered must be
           relative to the origin of IMAGE (1,1...) and must take into 
           account the shift and rotation. The first array element is the
           end pixel in the first dimension of the transformed image.
           ----------------------------------------------------------------
2 INTERP
   NAME    INTERP
   TYPE    INT
   PROMPT  "(INTERP) Interpolation method"
   TEXT    ----------------------------------------------------------------
           INTERP is the number of the required interpolation method:
           1 = nearest neighbour
           2 = average of neighbours  *** not yet available ***
           3 = linear interpolation
           4 = higher order  *** not yet available ***
           ----------------------------------------------------------------
2 MINCORN
   NAME    MINCORN
   TYPE    INT
   PROMPT  "(MINCORN) Minimum no. of non-magic corner pixels"
   TEXT    ----------------------------------------------------------------
           MINCORN is the mimimum number of non-magic corner pixels which
           are required for an interpolated value to be computable. The
           maximum number of corner pixels is 2**NDIM, where NDIM is
           the number of dimensions. For example, each fractional pixel
           to be interpolated in a 2-D image has four whole number pixels
           nearby, at the corners of a square. The value of MINCORN has an
           effect on the quality of interpolation: if it is low, the new
           values may be computed from a small number of nearby values and
           will therefore be more approximate than if MINCORN is high.
           ----------------------------------------------------------------
2 AXES
   NAME    AX(ES)
   TYPE    KEY                                               
   PROMPT  "(AXes) Calibrate the output axes?"
   TEXT    ----------------------------------------------------------------
           If AXES is specified, the output axes may be calibrated by 
           assigning a start and end value to each. 
           ----------------------------------------------------------------
2 AXKEY
   NAME    AXKEY
   TYPE    INT[6]
   PROMPT  "(AXKEY) Keys for axes to be calibrated."
   TEXT    ----------------------------------------------------------------
           AXKEY is an array containing the instruction to leave alone or
           calibrate each axis. 0 = leave alone, 1 = calibrate. 
           ----------------------------------------------------------------
2 AXSTART
   NAME    AXST(ART)
   TYPE    FLOAT[6]
   PROMPT  "(AXSTart) Start values of axes."
   TEXT    ----------------------------------------------------------------
           AXSTART is an array containing the start calibration value of 
           each axis. The first array element is the start value of the
           first axis.
           ----------------------------------------------------------------
2 AXEND
   NAME    AXEN(D)
   TYPE    FLOAT[6]
   PROMPT  "(AXENd) End values of axes."
   TEXT    ----------------------------------------------------------------
           AXEND is an array containing the end calibration value of each 
           axis. The first array element is the end value of the first
           axis.
           ----------------------------------------------------------------
2 AXLOG
   NAME    AXLOG
   TYPE    INT[6]
   PROMPT  "(AXLOG) Keys for logarithmic scaling."
   TEXT    ----------------------------------------------------------------
           AXLOG is an array containing the instruction for linear or log-
           arithmic calibration of each axis. 0 = linear, 1 = logarithmic. 
           ----------------------------------------------------------------
2 OUTPUT
   NAME    OUT(PUT)
   TYPE    FILE
   OPTIONS OUTPUT
   PROMPT  "(OUTput) Name of output image"
   TEXT    ----------------------------------------------------------------
           OUTPUT is the name of the structure which will contain the 
           output image. If OUTPUT already exists, a new version will be
           created. If OUTPUT is the same as IMAGE, a new version of IMAGE
           will be created.
           ----------------------------------------------------------------
2 ERR_VAL
   NAME    ERR_VAL
   TYPE    FLOAT
   PROMPT  "(ERR_VAL) Value to pad error arrays with"
   TEXT    ---------------------------------------------------------------
           When you perform certain operations, the size of arrays will
           increase. In such cases, and when an error array is present
           in the data, the new error array will be padded with dummy
           values. ERR_VAL is the value you would like to insert.
           --------------------------------------------------------------- 
2 SOURCE_COMMENTS
C+
C
C   -----------------
C   T R A N S F O R M
C   -----------------
C
C
C   Description
C   -----------
C   Geometric transformation program which can perform rebinning operations 
C   on an image, in the form of linear shift, rotation, and resampling. The 
C   operations may be performed separately or in combination. Several 
C   methods for interpolating new pixel values are available.
C
C
C   Scope of program
C   ----------------
C   - Images of two or three dimensions accepted.
C   - Data array types SHORT and FLOAT supported; others converted to FLOAT.
C   - Subsetting not supported.
C   - Magic values supported.
C   - Quality and variance arrays supported.
C   - Batch execution supported.
C
C
C   Environment
C   -----------
C   FIGARO
C
C                                            
C   Parameters (read or written)
C   ----------------------------
C   IMAGE     Name of the structure containing the input image. (character)
C             (prompted for).
C
C   SHIFT     Shift amount for each dimension in unresampled pixels. A 
C             positive value shifts to a higher pixel number. (real, array)
C             (prompted for). 
C
C   CENTRE    Rotation centre in each dimension in unresampled pixels. 
C             (real, array)(prompted for).
C
C   ANGLE     Anticlockwise rotation angle about each axis in degrees. 
C             (real, array)(prompted for).
C
C   RESAMPLE  Resampling factor for each dimension in output pixels per
C             input pixel. (real, array)(prompted for). 
C
C   STAPIX    Required start pixel of OUTPUT, relative to origin of IMAGE
C             (1,1...) after shift and rotation. (integer, array)
C             (prompted for).
C
C   ENDPIX    Required end pixel of OUTPUT, relative to origin of IMAGE
C             (1,1...) after shift and rotation. (integer, array)
C             (prompted for).
C
C   INTERP    Method used to compute the value of each output pixel.
C             (integer)(prompted for). These method numbers are also used in
C             UNMAGIC. Methods 2 (average of neighbours) and 5 (replace with
C             a constant) are offered in UNMAGIC but are not appropriate to 
C             TRANSFORM.
C             1 = nearest neighbour
C             3 = linear interpolation
C             4 = higher order (not yet available)
C
C   OUTPUT    Name of the structure containing the output image. May be the 
C             same as IMAGE. (character)(prompted for).     
C
C   AXKEY     Keys for axes to be calibrated.(integer, array)(prompted for).
C
C   AXSTART   Start calibration value for each axis. (real, array)(prompted 
C             for). 
C
C   AXEND     End calibration value for each axis. (real, array)(prompted 
C             for). 
C             
C   AXLOG     Keys for axes to be calibrated logarithmically. 
C             (integer, array)(prompted for).
C
C   ERR_VAL   The value to pad error arrays out with when the output 
C             array becomes larger thsan the input array.
C                  
C   Keywords
C   --------
C   AXES      Instruction to calibrate the axes of OUTPUT. If specified,
C             the axis start and increment values may be selected.
C
C
C   Propagation of data structure
C   -----------------------------
C   - All standard objects except the data array and axes are copied from 
C     IMAGE.
C   - Data array and axes are modified and reshaped.
C
C   
C   Method
C   ------
C   - The IMAGE structure is tested for the bad data flag. If it is found
C     and non-zero, magic values are assumed to be present and are left in
C     the data.
C   - Quality and error arrays are tested for.
C   - 3-D rotation matrices are computed if required.
C   - All rotations are allowed, but rotation about axis 1 or 2 is much less
C     efficient in terms of page faulting than rotation about axis 3. Both 
C     of the former involve accessing the third dimension of the data array
C     in a non-sequential fashion. A working set management method like that
C     used in AXFLIP and TRANSPOSE would be very difficult to devise. It 
C     would be logical to run TRANSPOSE, do the most efficient rotation in
C     TRANSFORM, and then run TRANSPOSE again, but in practice this would 
C     probably take even longer.
C   - The dimensions of OUTPUT are computed by applying the required shift,
C     rotation, and resampling to the corners of IMAGE.
C   - The structure IMAGE is copied to OUTPUT, with the exception of the 
C     data array and axes. DSA_RESHAPE_ routines are called to modify the 
C     dimensions of the OUTPUT axis and data/quality/error arrays. 
C   - If it is required to calibrate the OUTPUT axes, the axis number(s), 
C     start and end value(s), and linear/logarithmic flag(s) are prompted 
C     for. The axes are then mapped and calibrated.
C   - A subroutine appropriate to the data type, the presence or absence of 
C     rotation, the required interpolation method, and the presence or
C     absence of magic values is called to transform the IMAGE data array
C     into the OUTPUT data array. All the routines use the same approach to
C     transformation, which is to back-transform each pixel location of 
C     OUTPUT so as to find the IMAGE pixel whose value is to be used. In
C     most cases this will not be an exact pixel, so a value must be
C     interpolated at the intermediate location. The nearest neighbour
C     method does not interpolate but simply uses NINT to round the pixel
C     number. Interpolation of a value for the back-transformed pixel is 
C     impossible if it lies outside IMAGE, or if any of the adjacent IMAGE 
C     pixels is magic. Therefore the OUTPUT pixel is given the magic value.
C     Error and quality arrays are handled by subsequent calls to the
C     appropriate routine for efficiency (rather than handle them all at
C     once.)
C   - The OUTPUT bad data flag is set if magic values have appeared for the
C     reasons given above. 
C                                                   
C
C   External functions & subroutines called
C   ---------------------------------------
C   Library DSA:
C      DSA_CLOSE
C      DSA_DATA_SIZE
C      DSA_INPUT
C      DSA_MAP_AXIS_DATA
C      DSA_MAP_DATA
C      DSA_MAP_ERRORS
C      DSA_MAP_QUALITY
C      DSA_RESHAPE_AXIS
C      DSA_RESHAPE_DATA
C      DSA_OPEN
C      DSA_OUTPUT
C      DSA_SEEK_ERRORS
C      DSA_SEEK_QUALITY
C      DSA_USE_FLAGGED_VALUES
C      DSA_WRUSER
C
C   Library DYN:
C      DYN_ELEMENT   
C
C   Library GEN:
C      GEN_ELEMF
C
C   Library ICH:
C      ICH_ENCODE
C      ICH_LEN
C
C   Library NDP:
C      NDP_CORNERS
C      NDP_DISPLAY_PROGRESS
C      NDP_GET_IMAGE_INFO
C      NDP_LINEAR
C      NDP_PAR_RDARY
C      NDP_SET_AXES
C      NDP_SET_BAD_PIXEL
C
C   Library PAR:
C      PAR_RDVAL
C      PAR_SDVAL
C
C
C   Internal subroutines called
C   ---------------------------
C   TRANSFORM_NEWDIMS
C   TRANSFORM_2DNOROT1_W
C   TRANSFORM_2DNOROT1_R
C   TRANSFORM_2DNOROT3_W
C   TRANSFORM_2DNOROT3_WQ
C   TRANSFORM_2DNOROT3_R
C   TRANSFORM_2DNOROT3_RQ
C   TRANSFORM_2DROT1_W
C   TRANSFORM_2DROT1_R
C   TRANSFORM_2DROT3_W
C   TRANSFORM_2DROT3_WQ
C   TRANSFORM_2DROT3_R
C   TRANSFORM_2DROT3_RQ
C   TRANSFORM_2DTRANNR
C   TRANSFORM_2DTRANR
C   TRANSFORM_3DNOROT1_W
C   TRANSFORM_3DNOROT1_R
C   TRANSFORM_3DNOROT3_W
C   TRANSFORM_3DNOROT3_WQ
C   TRANSFORM_3DNOROT3_R
C   TRANSFORM_3DNOROT3_RQ
C   TRANSFORM_3DROT1_W
C   TRANSFORM_3DROT1_R
C   TRANSFORM_3DROT3_W
C   TRANSFORM_3DROT3_WQ
C   TRANSFORM_3DROT3_R
C   TRANSFORM_3DROT3_RQ
C   TRANSFORM_3DTRANNR
C   TRANSFORM_3DTRANR
C   TRANSFORM_3DMATRIX
C
C
C   INCLUDE statements
C   ------------------
C   INCLUDE 'DYN_SOURCE:DYNAMIC_MEMORY.INC'
C   INCLUDE 'NDP_SOURCE:NDP_MAGIC_VALUES.INC'
C   INCLUDE 'NDP_SOURCE:NDP_NUMERIC_RANGES.INC'
C
C
C   Extensions to FORTRAN 77
C   ------------------------
C   END DO / IMPLICIT NONE / INCLUDE / Names > 6 characters
C
C
C   Possible future upgrades:
C   ------------------------
C   - Provide a higher order interpolation method.
C   - Cater for more than 3 dimensions.
C
C
C   Author/s
C   --------
C   Nick Fuller   RGO  (RGVAD::NMJF or NMJF@UK.AC.RGO.STAR)
C   Chris Benn    RGO  (RGVAD::CRB or CRB@UK.AC.RGO.STAR)
C   Peter Allan   Manchester (MAVAD::PMA)
C   Jim Lewis     RGO  (CAVAD::JRL or JRL@UK.AC.CAM.AST-STAR)
C   Julian Gold   RGO  (CAVAD::GOLDJIL or GOLDJIL@UK.AC.CAM.AST-STAR)
C
C
C   History
C   -------
C   01-FEB-1989   - Original program
C   22-JUL-1990   - Modified to pass the sizes of adjustable arrays to 
C                   subroutines as individual variables rather than as
C                   elements of arrays. This change was made necessary by
C                   the VAX Fortran 5.2 compiler. (PMA)
C   28-JAN-1991   - Several bugs fixed.  Magic values were being passed
C                   wrongly to REAL routines.  The NOROT routines wouldn't
C                   shift properly as the shifts were being added back in
C                   a devious way.  The method 3 routines were also trying
C                   to interpolate past the edges of the images as well.
C                   (JRL)
C   01-DEC-1991   - Quality and error array handling added. (GOLDJIL)
C   11-MAR-1992   - Now checks that resampling factors are non-zero (GOLDJIL).
C   10-DEC-1992   - Unix version (GOLDJIL)
C   06-OCT-1994   - Removed lots of unused variables. (GJP)
C
1 transpose
  Transposes the dimensions of an image by resequencing the data array
  and exchanging the relevant axis arrays. This is done to promote
  maximum efficiency in subsequent operations which concentrate on a 
  particular dimension, for example spectral line analysis in a TAURUS
  data cube. Currently handles 3-D images only; the FIGARO programs
  ROTATE, IREVX and IREVY may be used on 2-D images.
2 IMAGE
   NAME    IM(AGE)
   TYPE    FILE
   OPTIONS INPUT
   PROMPT  "(IMage) Name of input image"
   TEXT    ----------------------------------------------------------------
           IMAGE is the name of the structure containing the image to be
           transposed. The image may have from two to six dimensions.
           ----------------------------------------------------------------
2 ORDER
   NAME    ORDER
   TYPE    FLOAT[6]
   PROMPT  "(ORDER) Transposed axis order."
   TEXT    ----------------------------------------------------------------
           ORDER is the order of the transposed axes in terms of the input 
           axes. For example, if it is required to transpose a cube from 
           XYZ to ZXY order, ORDER is entered as 3,1,2. To transpose ZXY 
           back to XYZ, enter 2,3,1.
           ----------------------------------------------------------------
2 OUTPUT
   NAME    OUT(PUT)
   TYPE    FILE
   OPTIONS OUTPUT
   PROMPT  "(OUTput) Name of output image"
   TEXT    ----------------------------------------------------------------
           OUTPUT is the name of the structure which will contain the
           output image. If OUTPUT already exists, a new version will be  
           created. If OUTPUT is the same as IMAGE, a new version of IMAGE
           will be created.
           ----------------------------------------------------------------
2 TUNE
   NAME    TUNE
   TYPE    FLOAT
   OPTIONS NOPROMPT
   PROMPT  "(TUNE) Tuning factor"
   TEXT    ----------------------------------------------------------------
           TUNE adjusts the number of image planes which are read as a 
           group and tranposed together. It has a small effect on the
           performance of the program.
           ----------------------------------------------------------------
2 SOURCE_COMMENTS
C+
C
C   -----------------
C   T R A N S P O S E
C   -----------------
C
C   Description
C   -----------
C   Transposes the dimensions of an image by resequencing the data array.
C   This is done to promote maximum efficiency in subsequent operations
C   which concentrate on a particular dimension, for example spectral-line
C   analysis in a TAURUS data cube.
C
C
C   Scope of program
C   ----------------
C   - Currently handles 3-D images only.
C   - Data array types SHORT and FLOAT supported; others converted to FLOAT.
C   - Subsetting not supported.
C   - Magic value blanking not supported since not relevant.
C   - Quality and error arrays supported.
C   - Batch execution supported.
C
C
C   Environment
C   -----------
C   FIGARO
C
C                              
C   Parameters (read or written)
C   ----------------------------
C   IMAGE   Name of the structure containing the input image. (character)
C           (prompted for).
C
C   ORDER   Order of the axes in the output image, in terms of the input
C           axes. (integer, array)(prompted for).
C
C   OUTPUT  Name of the structure containing the output image. May be the 
C           same as IMAGE. (character)(prompted for).
C
C   TUNE    Tuning factor which adjusts the number of image planes read into
C           the work array at one time. Has a small effect on performance. 
C           (real)(hidden parameter).
C
C   Keywords
C   --------
C   None.
C
C
C   Propagation of data structure
C   -----------------------------
C   - All standard objects except the data array and axes are copied from 
C     IMAGE.
C   - Data array and axes are modified and reshaped.
C                    
C
C   Method
C   ------
C   - The transposition is not necessarily performed directly as specified. 
C     The order in which the IMAGE dimensions are read into the work array 
C     and the order in which the work array dimensions are written to OUTPUT
C     are computed so that they result in the required transposition while 
C     minimizing page faulting over the whole process.
C   - The structure IMAGE is copied to OUTPUT, with the exception of the
C     data array and axes. DSA_RESHAPE_ routines are called to modify the 
C     dimensions of the OUTPUT axis and data arrays. 
C   - The calibrations, label, and units of the IMAGE axes are copied to the
C     appropriate OUTPUT axes.
C   - A subroutine appropriate to the dimensionality and data type is
C     called to transpose the IMAGE data array into the OUTPUT data array.
C     All these routines check the process page count so they can deal with
C     the data array in pieces which fit into the working set. This 
C     minimizes page faulting and improves efficiency.
C
C
C   External functions & subroutines called
C   ---------------------------------------
C   Library DSA:
C     DSA_CLOSE
C     DSA_DATA_SIZE
C     DSA_GET_AXIS_INFO
C     DSA_INPUT
C     DSA_MAP_AXIS_DATA
C     DSA_MAP_DATA
C     DSA_MAP_ERRORS
C     DSA_MAP_QUALITY
C     DSA_OPEN
C     DSA_OUTPUT
C     DSA_RESHAPE_AXIS
C     DSA_RESHAPE_DATA
C     DSA_SET_AXIS_INFO
C     DSA_TYPESIZE
C     DSA_SEEK_ERRORS
C     DSA_SEEK_QUALITY
C     DSA_USE_FLAGGED_VALUES
C     DSA_WRUSER
C
C   Library DYN:
C     DYN_ELEMENT
C
C   Library GEN:
C     GEN_MOVE
C
C   Library ICH:
C     ICH_ENCODE
C     ICH_LEN
C     
C   Library NDP:
C     NDP_DISPLAY_PROGRESS
C     NDP_GET_IMAGE_INFO
C     NDP_GETJPI_PPGCNT
C     NDP_GETJPI_WSEXTENT
C
C   Library PAR:
C     PAR_RDARY
C     
C
C   Internal subroutines called
C   ---------------------------
C   TRANSPOSE_3D_W
C   TRANSPOSE_3D_R
C   TRANSPOSE_3D_B
C
C   INCLUDE statements
C   ------------------
C   INCLUDE 'DYN_SOURCE:DYNAMIC_MEMORY.INC'
C   INCLUDE 'NDP_SOURCE:NDP_MAGIC_VALUES.INC'
C   INCLUDE 'NDP_SOURCE:NDP_NUMERIC_RANGES.INC'
C                                             
C
C   Extensions to FORTRAN77
C   -----------------------
C   DO WHILE / IMPLICIT NONE / INCLUDE / Names > 6 characters
C
C         
C   Possible future upgrades
C   ------------------------
C   - Only 3-D images are handled at present. Subroutines to be written:
C       TRANSPOSE_2D_<T>
C       TRANSPOSE_4D_<T>
C       TRANSPOSE_5D_<T>
C       TRANSPOSE_6D_<T>
C   - More complex transposition strategies will be required for the higher
C     dimensionalities, possibly including multiple passes, dimensional 
C     subsetting, and axis flipping. The AIPS program TRANS could be used as
C     a guide.
C
C
C   Author/s
C   --------
C   Nick Fuller  RGO  (RGVAD::NMJF or NMJF@UK.AC.RGO.STAR)
C   Jim Lewis    RGO  (CAVAD::JRL or JRL@UK.AC.CAM.AST-STAR)
C   Julian Gold  RGO  (CAVAD::GOLDJIL or GOLDJIL@UK.AC.CAM.AST-STAR)
C
C   History
C   -------
C   01-FEB-1989   - Original program
C   03-AUG-1990   - Fixed so that adjustable array sizes are not passed
C                   as elements of another array.  This practice has been
C                   banned by the v5.2 compiler.  (JRL)
C   12-NOV-1990   - Fixed bug in TRANSPOSE_3D_R which caused access violations
C                   when trying to transpose the whole array at once.  (JRL)
C   18-OCT-1991   - Quality and error array handling added.
C                   Subroutines written in GENERIC form. 
C                   Fixed horrible bug that crashes program on certain
C                   permutations of indices when arrays aren't cubes.(GOLDJIL)
C   10-DEC-1992   - Unix version. (GOLDJIL)
C   06-OCT-1994   - Removed lots of unused variables. (GJP)
C
C                     
1 typecon
  Converts the data (and error) array of an image structure from any 
  type to either INTEGER*2 or REAL. Errors will occur on conversion to 
  INTEGER *2 if any pixel values are outside the 16 bit signed integer 
  range. The method differs from that of the FIGARO program CONTRACT,
  which rescales the values to avoid such errors. The programs 
  in NDPROGS can use a CONTRACTed image instead of an INTEGER*2 
  image, but there will be a significant delay while the values are 
  scaled back to their original range.
2 IMAGE
   NAME    IM(AGE)
   TYPE    FILE
   OPTIONS INPUT
   PROMPT  "(IMage) Name of input image"
   TEXT    ----------------------------------------------------------------
           IMAGE is the name of the structure containing the image whose 
           data array is to be converted to the required type. Any data 
           type may be input, but only SHORT or FLOAT may be output.
           Overflow errors will therefore occur if an inappropriate
           conversion is attempted. The image may have from one to six 
           dimensions.
           ----------------------------------------------------------------
2 SHORT
   NAME    SH(ORT)
   TYPE    KEY                                               
   PROMPT  "(SHort) Create a data array of type SHORT?"
   TEXT    ----------------------------------------------------------------
           If SHORT is specified, the output data array will be of type
           SHORT, i.e. signed 16 bit integer (INTEGER*2).
           ----------------------------------------------------------------
2 FLOAT
   NAME    FL(OAT)
   TYPE    KEY                                               
   PROMPT  "(FLoat) Create a data array of type FLOAT?"
   TEXT    ----------------------------------------------------------------
           If FLOAT is specified, the output data array will be of type
           FLOAT, i.e. 32 bit single precision floating point (REAL*4).
           ----------------------------------------------------------------
2 OUTPUT
   NAME    OUT(PUT)
   TYPE    FILE
   OPTIONS OUTPUT
   PROMPT  "(OUTput) Name of output image"
   TEXT    ----------------------------------------------------------------
           OUTPUT is the name of the structure which will contain the
           output image. If OUTPUT already exists, a new version will be 
           created. If OUTPUT is the same as IMAGE, a new version of IMAGE
           will be created.
           ----------------------------------------------------------------
2 SOURCE_COMMENTS
C+
C
C   -------------
C   T Y P E C O N
C   -------------
C
C   Description
C   -----------
C   Converts the data array of an image from SHORT to FLOAT, or from FLOAT
C   to SHORT.
C
C
C   Scope of program
C   ----------------
C   - Images of up to six dimensions accepted.
C   - Data array types BYTE, SHORT, INT, FLOAT, and DOUBLE supported.
C   - Subsetting not supported.
C   - Magic values supported.
C   - Quality and variance arrays supported.
C   - Batch execution supported.
C
C
C   Environment
C   -----------
C   FIGARO
C
C
C   Parameters (read or written)
C   ----------------------------
C   IMAGE   Name of the structure containing the input image. (character)
C           (prompted for).
C
C   OUTPUT  Name of the structure containing the output image. (character)
C           (prompted for).
C
C
C   Keywords
C   --------
C   SHORT   Instruction to create a data array of type SHORT.
C
C   FLOAT   Instruction to create a data array of type FLOAT.
C
C
C   Propagation of data structure
C   -----------------------------
C   - All standard objects are copied from IMAGE.
C   - Data array is modified.
C
C
C   Method
C   ------
C   - The IMAGE structure is tested for the bad data flag, quality and error
C     arrays. If the bad data flag is found
C     and non-zero, magic values are assumed to be present and are left in
C     the data, unless a quality array is present.
C   - The instruction to convert to either SHORT or FLOAT is either deduced 
C     from the data type of IMAGE, or prompted for.
C   - An empty output structure is opened. A call to DSA_SIMPLE_OUTPUT then
C     builds the output file of the required type.
C   - The axis structure (if present) is copied to OUTPUT.
C   - The data, quality and error arrays (where applicable) are copied to
C     OUTPUT.
C
C   External functions & subroutines called
C   ---------------------------------------
C   Library DSA:
C      DSA_AXIS_SIZE
C      DSA_CLOSE
C      DSA_DATA_SIZE
C      DSA_INPUT
C      DSA_MAP_DATA
C      DSA_MAP_ERRORS
C      DSA_MAP_QUALITY
C      DSA_OPEN
C      DSA_OUTPUT
C      DSA_RESHAPE_AXIS
C      DSA_SEEK_AXIS
C      DSA_SEEK_ERRORS
C      DSA_SEEK_QUALITY
C      DSA_SET_FLAGGED_VALUES
C      DSA_SIMPLE_OUTPUT
C      DSA_TYPESIZE
C      DSA_USE_FLAGGED_VALUES
C      DSA_WRUSER
C
C   Library DYN:
C      DYN_ELEMENT
C
C   Library GEN:
C      GEN_MOVE
C
C   Library ICH:
C      ICH_CI
C      ICH_LEN
C
C   Library NDP:
C      NDP_GET_IMAGE_INFO
C
C   Library PAR:
C      PAR_GIVEN
C      PAR_RDKEY
C
C
C   Internal subroutines called
C   ---------------------------
C   None.
C
C
C   INCLUDE statements
C   ------------------
C   INCLUDE 'DYN_SOURCE:DYNAMIC_MEMORY.INC'
C   INCLUDE 'NDP_SOURCE:NDP_MAGIC_VALUES.INC'
C   INCLUDE 'NDP_SOURCE:NDP_NUMERIC_RANGES.INC'
C
C   Extensions to FORTRAN77
C   -----------------------
C   END DO / IMPLICIT NONE / INCLUDE / Names > 6 characters
C
C
C   Possible future upgrades
C   ------------------------
C
C   Author/s
C   --------
C   Nick Fuller  RGO  (RGVAD::NMJF or NMJF@UK.AC.RGO.STAR)
C   Julian Gold  RGO  (CAVAD::GOLDJIL or GOLDJIL@UK.AC.CAM.AST-STAR)
C
C   History
C   -------
C   01-FEB-1989   - Original program
C   14-JUN-1990   - Fixed to set magic value flag if it's needed  (JRL)
C   18-JUN-1990   - Fixed bug which caused the program to die if axis arrays
C                   didn't exist.  (JRL)
C   11-NOV-1991   - Got rid of nasty array coercion, added quality and error
C                   handling, tidied up (and all before lunchtime). (GOLDJIL)
C   10-DEC-1992   - Unix version. (GOLDJIL)
C   06-OCT-1994   - Removed lots of unused variables. (GJP)
C
C
1 unmagic
  Replaces bad pixels in an image or image subset with an appropriate 
  value. New pixel values may be derived from the average of adjacent 
  pixels or by linear interpolation. Alternatively, all bad pixels may be
  replaced by the same constant value.
2 IMAGE
   NAME    IM(AGE)
   TYPE    FILE
   OPTIONS INPUT
   PROMPT  "(IMage) Name of input image"
   TEXT    ----------------------------------------------------------------
           IMAGE is the name of the structure containing the image in 
           which each magic value pixel will be replaced by a value
           derived from its neighbours. The image may have from one to six
           dimensions.
           ----------------------------------------------------------------
2 WHOLE
   NAME    WH(OLE)
   TYPE    KEY                                               
   PROMPT  "(WHole) Process the whole image?"
   TEXT    ----------------------------------------------------------------
           If WHOLE is specified, the entire area of the image will be 
           processed. Otherwise, a subset of the image may be selected.
           ----------------------------------------------------------------
2 START
   NAME    ST(ART)
   TYPE    FLOAT[6]
   PROMPT  "(STart) Start coordinates of subset."
   TEXT    ----------------------------------------------------------------
           START is an array containing the start coordinate of the subset
           to be processed in each dimension of the image. The first array
           element is the start coordinate in the first dimension of the 
           current sort order (usually X). Each coordinate must be given 
           in axis units if the relevant axis is calibrated, or in pixels 
           if it is not calibrated or the axis structure is not present.  
           ----------------------------------------------------------------
2 END
   NAME    EN(D)
   TYPE    FLOAT[6]
   PROMPT  "(ENd) End coordinates of subset."
   TEXT    ----------------------------------------------------------------
           END is an array containing the end coordinate of the subset
           to be processed in each dimension of the image. The first array
           element is the end coordinate in the first dimension of the 
           current sort order (usually X). Each coordinate must be given 
           in axis units if the relevant axis is calibrated, or in pixels 
           if it is not calibrated or the axis structure is not present.  
           ----------------------------------------------------------------
2 INTERP
   NAME    INTERP
   TYPE    INT
   PROMPT  "(INTERP) Interpolation method"
   TEXT    ----------------------------------------------------------------
           INTERP is the number of the required interpolation method:
           2 = average of neighbours
           3 = linear interpolation  *** not yet available ***
           4 = higher order  *** not yet available ***
           5 = replace with a constant value
           ----------------------------------------------------------------
2 MINADJ
   NAME    MINADJ
   TYPE    INT
   PROMPT  "(MINADJ) Minimum no. of non-magic adjacent pixels"
   TEXT    ----------------------------------------------------------------
           MINADJ is the mimimum number of non-magic adjacent pixels which
           are required for an interpolated value to be computable. The
           maximum number of adjacent pixels is (3**NDIM)-1, where NDIM is
           the number of dimensions. Vertical, horizontal, and diagonal
           neighbours are all adjacent pixels. The value of MINADJ has an
           effect on the quality of interpolation: if it is low, the new
           values may be computed from a small number of nearby values and
           will therefore be more approximate than if MINADJ is high.
           ----------------------------------------------------------------
2 VALUE
   NAME    VAL(UE)
   TYPE    FLOAT
   PROMPT  "(VALue) Constant value"
   TEXT    ----------------------------------------------------------------
           Every bad pixel will be replaced by this value.
           ----------------------------------------------------------------
2 OUTPUT
   NAME    OUT(PUT)
   TYPE    FILE
   OPTIONS OUTPUT
   PROMPT  "(OUTput) Name of output image"
   TEXT    ----------------------------------------------------------------
           OUTPUT is the name of the structure which will contain the
           output image. If OUTPUT already exists, a new version will be 
           created. If OUTPUT is the same as IMAGE, a new version of IMAGE
           will be created.
           ----------------------------------------------------------------
2 SOURCE_COMMENTS
C+
C
C   -------------
C   U N M A G I C
C   -------------
C
C
C   Description
C   -----------
C   Sets each bad pixel in an image to a value derived from its
C   neighbours. Several methods for computing the new value are available.
C
C
C   Scope of program
C   ----------------
C   - Images of up to six dimensions accepted.
C   - Data array types SHORT and FLOAT supported; others converted to FLOAT.
C   - Subsetting supported.
C   - Magic values and quality arrays supported.
C   - Variance arrays not supported.
C   - Batch execution supported.
C
C
C   Environment
C   -----------
C   FIGARO
C
C                                            
C   Parameters (read or written)
C   ----------------------------
C   IMAGE   Name of the structure containing the input image. (character)
C           (prompted for).
C
C   START   The coordinate in each dimension of IMAGE at which the edit
C           operation is to start. (real, array)(prompted for).
C
C   END     The coordinate in each dimension of IMAGE at which the edit
C           operation is to end. (real, array)(prompted for).
C
C   INTERP  Method used to compute the value of each output pixel (integer)
C           (prompted for). These method numbers are also used in TRANSFORM.
C           Method 1 (nearest neighbour) is offered in TRANSFORM but is not 
C           appropriate to UNMAGIC.
C           2 = average of neighbours
C           3 = linear interpolation
C           4 = higher order (not yet available)
C           5 = replace with a constant value
C
C   MINADJ  For method 2, the minimum number of adjacent pixels which must 
C           be non-magic for an average value to be computable. (integer)
C           (prompted for). 
C
C   VALUE   For method 5, the value to be assigned to all magic value 
C           pixels. (real)(prompted for).                              
C
C   OUTPUT  Name of the structure containing the output image. May be the 
C           same as IMAGE. (character)(prompted for).     
C
C
C   Keywords
C   --------
C   WHOLE   Instructs the program to edit the whole image. Otherwise, a
C           subset of the image may be selected.
C
C
C   Propagation of data structure
C   -----------------------------
C   - All standard objects are copied from IMAGE.
C   - Data array is modified.
C
C
C   Method
C   ------
C   - The IMAGE structure is tested for the bad data flag. If it is found
C     and non-zero, magic values are assumed to be present and are left in
C     the data.
C   - The structure IMAGE is copied to OUTPUT.
C   - A subroutine appropriate to the data type and the required interpolation 
C     method values is called to interpolate using the values available in the 
C     IMAGE data array, and store the results in the OUTPUT data array.
C   - The OUTPUT bad data flag is unset only if the whole of IMAGE was used
C     and no magic values remain. 
C                                               
C
C   External functions & subroutines called
C   ---------------------------------------
C   Library DSA:
C      DSA_CLOSE
C      DSA_DATA_SIZE
C      DSA_INPUT
C      DSA_MAP_DATA
C      DSA_MAP_QUALITY
C      DSA_OPEN
C      DSA_OUTPUT
C      DSA_SEEK_QUALITY
C      DSA_USE_FLAGGED_VALUES
C      DSA_WRUSER
C
C   Library DYN:
C      DYN_ELEMENT
C
C   Library ICH:
C      ICH_ENCODE
C      ICH_LEN
C
C   Library NDP:
C      NDP_ADJACENT
C      NDP_AXIS_RANGE
C      NDP_CORNERS
C      NDP_DISPLAY_PROGRESS
C      NDP_GET_IMAGE_INFO
C      NDP_LINEAR
C      NDP_SET_BAD_PIXEL
C
C   Library PAR:
C      PAR_RDVAL
C
C
C   Internal subroutines called
C   ---------------------------
C   UNMAGIC_AVERAGE_W
C   UNMAGIC_AVERAGE_R
C   UNMAGIC_CONSTANT_W
C   UNMAGIC_CONSTANT_R
C   UNMAGIC_LINEAR_W
C   UNMAGIC_LINEAR_R
C
C
C   INCLUDE statements
C   ------------------
C   INCLUDE 'DYN_SOURCE:DYNAMIC_MEMORY.INC'  
C   INCLUDE 'NDP_SOURCE:NDP_MAGIC_VALUES.INC'
C   INCLUDE 'NDP_SOURCE:NDP_NUMERIC_RANGES.INC'
C   INCLUDE 'DCV_FUN'
C
C
C   Extensions to FORTRAN 77
C   ------------------------
C   END DO / IMPLICIT NONE / INCLUDE / Names > 6 characters
C
C
C   Possible future upgrades:
C   ------------------------
C   - Provide a higher order interpolation method.
C   - Repeat the chosen interpolation operation until no magic value pixels
C     remain. This would mean using work arrays so that the output of one
C     iteration can become the input for the next. 
C
C
C   Author/s
C   --------
C   Nick Fuller  RGO  (RGVAD::NMJF or NMJF@UK.AC.RGO.STAR)
C   Julian Gold  RGO  (CAVAD::GOLDJIL or GOLDJIL@UK.AC.CAM.AST-STAR)
C
C   History
C   -------
C   01-FEB-1989  - Original program
C   09-OCT-1991  - Quality array support added. Code written in GENERIC
C                  format. (GOLDJIL)
C   10-DEC-1992  - Unix version (GOLDJIL).
C   06-OCT-1994  - Removed lots of unused variables. (GJP)
CC
C

